#!/usr/bin/env bash

if ((BASH_VERSINFO[0] < 4)); then
  echo "$(basename "$0"): requires bash 4.0 or higher (found ${BASH_VERSION})" >&2
  exit 1
fi

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS]

Lists available activities on the connected device, tagged by category.
By default, lists only activities from user-installed (third-party) apps.

Supported categories:
  L - Launcher (android.intent.category.LAUNCHER)
  H - Home/Launcher App (android.intent.category.HOME)
  T - TV/Leanback (android.intent.category.LEANBACK_LAUNCHER)
  S - Settings (android.intent.category.PREFERENCE)

Options:
  --launcher-only  List only launcher activities
  --home-only      List only home/launcher app activities
  --tv-only        List only TV/Leanback activities
  --settings-only  List only settings activities
  --all            List activities from all packages (including system apps)
  --help           Display this help message and exit

Environment:
  ANDROID_SERIAL  Serial number of device to connect to (see 'adb devices -l').
EOF
  exit 0
}

# Parse args
launcher_only=0
home_only=0
tv_only=0
settings_only=0
all_apps=0

while [[ "$#" -gt 0 ]]; do
  case $1 in
    --launcher-only) launcher_only=1 ;;
    --home-only) home_only=1 ;;
    --tv-only) tv_only=1 ;;
    --settings-only) settings_only=1 ;;
    --all) all_apps=1 ;;
    --help) usage ;;
    *)
      echo "$(basename "$0"): unknown option '$1'" >&2
      exit 1
      ;;
  esac
  shift
done

count=$((launcher_only + home_only + tv_only + settings_only))
if ((count > 1)); then
  echo "$(basename "$0"): cannot specify multiple *-only options" >&2
  exit 1
fi

require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo >&2 "$(basename "$0"): $1 not found"
    exit 127
  }
}

require adb

if ! adb get-state >/dev/null 2>&1; then
  if [[ -n "$ANDROID_SERIAL" ]]; then
    echo "$(basename "$0"): device '$ANDROID_SERIAL' not available" >&2
  else
    echo "$(basename "$0"): no device connected" >&2
  fi
  exit 1
fi

# Define Intents
ACTION_MAIN="android.intent.action.MAIN"
CAT_LAUNCHER="android.intent.category.LAUNCHER"
CAT_HOME="android.intent.category.HOME"
CAT_LEANBACK="android.intent.category.LEANBACK_LAUNCHER"
CAT_PREFERENCE="android.intent.category.PREFERENCE"

# Fetch user packages if filtering is enabled
declare -A user_pkgs
if ((!all_apps)); then
  # Read user packages into associative array
  # 'pm list packages -3' returns "package:com.example"
  while read -r line; do
    pkg=${line#package:}
    user_pkgs["$pkg"]=1
  done < <(adb shell pm list packages -3 | tr -d '\r')
fi

# Awk script to parse 'cmd package query-activities' output
# shellcheck disable=SC2016
PARSE_CMD_OUTPUT_AWK=' 
  /ActivityInfo:/ { in_block = 1; next }
  /ApplicationInfo:/ { in_block = 0; next }
  in_block && /name=/ { sub("name=", "", $1); name = $1 }
  in_block && /packageName=/ { sub("packageName=", "", $1); pkg = $1; print pkg "/" name }
'

run_query() {
  local action=$1
  local cat=$2
  local args=("-c" "$cat")
  if [[ -n "$action" ]]; then
    args+=("-a" "$action")
  fi

  adb shell cmd package query-activities "${args[@]}" 2>/dev/null |
    awk "$PARSE_CMD_OUTPUT_AWK" |
    tr -d '\r'
}

# Helper to filter output based on user_pkgs
filter_and_print() {
  while read -r comp; do
    [[ -z "$comp" ]] && continue
    if ((all_apps)); then
      echo "$comp"
    else
      # Extract package name: com.example/Activity -> com.example
      local pkg="${comp%%/*}"
      if [[ -n "${user_pkgs[$pkg]+_}" ]]; then
        echo "$comp"
      fi
    fi
  done
}

# If specific flag, run query and filter
if ((launcher_only)); then
  run_query "$ACTION_MAIN" "$CAT_LAUNCHER" | filter_and_print | sort | uniq
  exit 0
fi

if ((home_only)); then
  run_query "$ACTION_MAIN" "$CAT_HOME" | filter_and_print | sort | uniq
  exit 0
fi

if ((tv_only)); then
  run_query "$ACTION_MAIN" "$CAT_LEANBACK" | filter_and_print | sort | uniq
  exit 0
fi

if ((settings_only)); then
  run_query "" "$CAT_PREFERENCE" | filter_and_print | sort | uniq
  exit 0
fi

# Default: List all with tags

# Gather lists
list_l=$(run_query "$ACTION_MAIN" "$CAT_LAUNCHER")
list_h=$(run_query "$ACTION_MAIN" "$CAT_HOME")
list_t=$(run_query "$ACTION_MAIN" "$CAT_LEANBACK")
list_s=$(run_query "" "$CAT_PREFERENCE")

# Merge and Print
awk ' 
  function clean(c) { gsub(/^[ \t]+|[ \t]+$/, "", c); return c }

  { 
    type = $1
    $1 = ""
    comp = clean($0)
    if (comp == "") next
    
    if (type == "L:") l[comp] = 1
    else if (type == "H:") h[comp] = 1
    else if (type == "T:") t[comp] = 1
    else if (type == "S:") s[comp] = 1
  }

  END {
    for (c in l) all[c] = 1
    for (c in h) all[c] = 1
    for (c in t) all[c] = 1
    for (c in s) all[c] = 1

    for (c in all) {
      tag_l = (c in l) ? "L" : " "
      tag_h = (c in h) ? "H" : " "
      tag_t = (c in t) ? "T" : " "
      tag_s = (c in s) ? "S" : " "
      
      # Format: LH T S com.package/Activity
      printf "%s%s%s%s %s\n", tag_l, tag_h, tag_t, tag_s, c
    }
  }
' <(
  echo "$list_l" | awk '{print "L: " $0}'
  echo "$list_h" | awk '{print "H: " $0}'
  echo "$list_t" | awk '{print "T: " $0}'
  echo "$list_s" | awk '{print "S: " $0}'
) | sort | uniq | while read -r line; do
  if ((all_apps)); then
    echo "$line"
  else
    # line is "LHTS com.pkg/Act"
    # Extract comp (last field)
    comp=${line##* }
    pkg=${comp%%/*}
    if [[ -n "${user_pkgs[$pkg]+_}" ]]; then
      echo "$line"
    fi
  fi
done
