#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0")

Opens the system theme settings on the connected Android device (Wear OS).
Requires a debuggable build (userdebug/eng) with adb root access.

Options:
  --help      Display this help message and exit

Environment:
  ANDROID_SERIAL  Serial number of device to connect to (see 'adb devices -l').
                  To target a specific device, use:
                    env ANDROID_SERIAL=<serial> $(basename "$0")
EOF
  exit 0
}

if [[ "$1" == "--help" ]]; then
  usage
fi

require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo >&2 "$(basename "$0"): $1 not found"
    exit 127
  }
}

require adb

# Check device availability
if ! adb get-state >/dev/null 2>&1; then
  if [[ -n "$ANDROID_SERIAL" ]]; then
    echo "$(basename "$0"): device '$ANDROID_SERIAL' not available" >&2
  else
    echo "$(basename "$0"): no device connected" >&2
  fi
  exit 1
fi

# Check if we are running as root
# 'id -u' returns 0 for root
if [[ "$(adb shell id -u 2>/dev/null | tr -d '\r')" != "0" ]]; then
  # Not currently root. Try to restart adbd as root.
  # "adb root" usually prints "restarting adbd as root" or an error message.
  if ! adb root; then
    echo "$(basename "$0"): 'adb root' command failed." >&2
    exit 1
  fi

  # Wait for the device to reconnect after adbd restart
  adb wait-for-device

  # Verify if we are root now
  if [[ "$(adb shell id -u 2>/dev/null | tr -d '\r')" != "0" ]]; then
    echo "$(basename "$0"): Failed to obtain root access." >&2

    # Check if the build is debuggable to provide a helpful hint
    # ro.debuggable=1 means userdebug or eng build
    # ro.debuggable=0 means user (production) build
    DEBUGGABLE=$(adb shell getprop ro.debuggable 2>/dev/null | tr -d '\r')
    if [[ "$DEBUGGABLE" != "1" ]]; then
      echo "Reason: Device appears to be running a 'user' build (ro.debuggable=$DEBUGGABLE)." >&2
      echo "        This command requires a 'userdebug' or 'eng' build." >&2
    fi
    exit 1
  fi
fi

# Run the command
adb exec-out am start -a com.google.android.clockwork.sysui.ACTION_SYSTEM_THEME_SETTINGS
