#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0")

Dumps the state of the CapabilityService from the Wearable Service.

This script extracts the section of the 'dumpsys wearableservice' output
that deals with advertised and discovered capabilities on the Wear OS network.
It shows which nodes (devices) have which capabilities and which apps
are advertising them.

Options:
  --help      Display this help message and exit

Environment:
  ANDROID_SERIAL  Serial number of device to connect to (see 'adb devices -l').
                  To target a specific device, use:
                    env ANDROID_SERIAL=<serial> $(basename "$0")

Examples:
  # Show all capability service information
  $(basename "$0")

  # Find which nodes advertise a specific capability
  $(basename "$0") | grep "my_app_capability"
EOF
  exit 0
}

if [[ "$1" == "--help" ]]; then
  usage
fi

require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo >&2 "$(basename "$0"): $1 not found"
    exit 127
  }
}

require adb

adb exec-out dumpsys activity service WearableService | sed -n '/CapabilityService/,/######/p'
