#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") [FILE]

Records the screen of an adb-connected device using raw frames and ffmpeg.
Useful for devices that don't support standard screenrecord codecs (e.g. Wear OS).

Arguments:
  FILE        The path to save the screen recording to.
              (defaults to 'adb-screenrecord-YYYYMMDDHHMMSS.mp4')

Options:
  --help      Display this help message and exit

Environment:
  ANDROID_SERIAL  Serial number of device to connect to (see 'adb devices -l').
EOF
  exit 0
}

if [[ "$1" == "--help" ]]; then
  usage
fi

require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo >&2 "$(basename "$0"): $1 not found"
    exit 127
  }
}

require adb
require ffmpeg

filename="$1"

if [ -z "$filename" ]; then
  filename=$(date -u +'adb-screenrecord-%Y%m%d%H%M%S.mp4')
fi

function stop {
  adb exec-out settings put system show_touches 0
  echo "Saved to $filename"
}

trap stop SIGINT

adb exec-out settings put system show_touches 1

echo "Recording... (Press Ctrl-C to stop)"

SIZE=454x454
BITRATE=70M

# -use_wallclock_as_timestamps 1 -vsync 0
#
#   frames are received in realtime
#   https://video.stackexchange.com/a/25953/35776
#
# -an
#
#   remove audio from output
#
# -c:v libx264
#
#   video codec (MP4)

adb exec-out screenrecord --output-format=raw-frames --size "$SIZE" --bit-rate "$BITRATE" - | ffmpeg -f rawvideo -vcodec rawvideo -s "$SIZE" -pix_fmt rgb24 -use_wallclock_as_timestamps 1 -vsync 0 -i - -an -c:v libx264 -pix_fmt yuv420p -y "$filename"
