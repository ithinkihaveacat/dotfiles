#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS]

Display device information and properties from an adb-connected Android device.

Shows hardware details, software versions, and display configuration including:
  - Device manufacturer, model, and serial number
  - Android version, API level, and security patch date
  - SoC/chipset information and CPU architecture
  - Display resolution, density, and calculated dp size

Options:
  -h, --help  Display this help message and exit

Environment:
  ANDROID_SERIAL  Serial number of device to connect to (see 'adb devices -l').
                  To target a specific device, use:
                    env ANDROID_SERIAL=<serial> $(basename "$0")
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

require() { hash "$@" || exit 127; }

require adb

# Check if device is available
device_state=$(adb get-state 2>&1)
if [ "$device_state" != "device" ]; then
  echo "$(basename "$0"): no device connected" >&2
  if [[ "$device_state" == *"more than one"* ]]; then
    echo "" >&2
    echo "Multiple devices detected. Set ANDROID_SERIAL to select one:" >&2
    adb devices -l | tail -n +2 | grep -v '^$' >&2
    echo "" >&2
    echo "Example: ANDROID_SERIAL=<serial> $(basename "$0")" >&2
  else
    echo "Connect a device via USB or start an emulator." >&2
  fi
  exit 1
fi

# Function to get a property value
getprop() {
  adb exec-out getprop "$1" 2>/dev/null | tr -d '\r'
}

# Gather all properties
SERIAL=$(getprop ro.serialno)
IS_EMULATOR=$(getprop ro.kernel.qemu)
BOOT_QEMU=$(getprop ro.boot.qemu)
CHARACTERISTICS=$(getprop ro.build.characteristics)

if [[ "$SERIAL" == emulator-* ]] || [[ "$SERIAL" == EMULATOR* ]] || [[ "$IS_EMULATOR" == "1" ]] || [[ "$BOOT_QEMU" == "1" ]] || [[ "$CHARACTERISTICS" == *"emulator"* ]]; then
  # Try querying the emulator console first
  AVD_NAME=$(adb emu avd name 2>/dev/null | head -n 1 | tr -d '\r')

  # Fallback to properties
  if [[ -z "$AVD_NAME" || "$AVD_NAME" == "error"* ]]; then
    AVD_NAME=$(getprop ro.boot.qemu.avd_name)
  fi
  if [[ -z "$AVD_NAME" ]]; then
    AVD_NAME=$(getprop ro.kernel.qemu.avd_name)
  fi

  # Fallback to kernel command line
  if [[ -z "$AVD_NAME" ]]; then
    CMDLINE=$(adb shell cat /proc/cmdline 2>/dev/null)
    # Try to find 'android.avd_name=...' or 'qemu.avd_name=...'
    if [[ "$CMDLINE" =~ android.avd_name=([^[:space:]]+) ]]; then
      AVD_NAME="${BASH_REMATCH[1]}"
    elif [[ "$CMDLINE" =~ qemu.avd_name=([^[:space:]]+) ]]; then
      AVD_NAME="${BASH_REMATCH[1]}"
    fi
  fi
fi
MANUFACTURER=$(getprop ro.product.manufacturer)
BRAND=$(getprop ro.product.brand)
MODEL=$(getprop ro.product.model)
DEVICE=$(getprop ro.product.device)
PRODUCT_NAME=$(getprop ro.product.name)

API_LEVEL=$(getprop ro.build.version.sdk)
ANDROID_VERSION=$(getprop ro.build.version.release)
BUILD_ID=$(getprop ro.build.id)
SECURITY_PATCH=$(getprop ro.build.version.security_patch)
BUILD_TYPE=$(getprop ro.build.type)

HARDWARE=$(getprop ro.hardware)
CHIPNAME=$(getprop ro.hardware.chipname)
PLATFORM=$(getprop ro.board.platform)
SOC_MANUFACTURER=$(getprop ro.soc.manufacturer)
SOC_MODEL=$(getprop ro.soc.model)
ABI=$(getprop ro.product.cpu.abi)
ABI2=$(getprop ro.product.cpu.abi2)

# Display dimensions
HEIGHT=$(adb exec-out wm size 2>/dev/null | awk -F'[: x]+' '{print $3}')
WIDTH=$(adb exec-out wm size 2>/dev/null | awk -F'[: x]+' '{print $4}')
DENSITY=$(adb exec-out wm density 2>/dev/null | tail -1 | awk '{print $NF}')

# Calculate DP size
if command -v bc &>/dev/null && [[ -n "$HEIGHT" && -n "$WIDTH" && -n "$DENSITY" ]]; then
  HEIGHT_DP=$(echo "scale=2; $HEIGHT * 160 / $DENSITY" | bc)
  WIDTH_DP=$(echo "scale=2; $WIDTH * 160 / $DENSITY" | bc)
fi

# Output organized information
echo "Device Information:"
[[ -n "$MANUFACTURER" ]] && echo "  Manufacturer: $MANUFACTURER"
[[ -n "$BRAND" ]] && echo "  Brand: $BRAND"
[[ -n "$MODEL" ]] && echo "  Model: $MODEL"
[[ -n "$DEVICE" ]] && echo "  Device: $DEVICE"
[[ -n "$PRODUCT_NAME" ]] && echo "  Product: $PRODUCT_NAME"
[[ -n "$SERIAL" ]] && echo "  Serial: $SERIAL"
[[ -n "$AVD_NAME" ]] && echo "  AVD Name: $AVD_NAME"
[[ -n "$CHARACTERISTICS" ]] && echo "  Type: $CHARACTERISTICS"

echo ""
echo "System Information:"
[[ -n "$ANDROID_VERSION" ]] && echo "  Android: $ANDROID_VERSION"
[[ -n "$API_LEVEL" ]] && echo "  API Level: $API_LEVEL"
[[ -n "$BUILD_ID" ]] && echo "  Build ID: $BUILD_ID"
[[ -n "$BUILD_TYPE" ]] && echo "  Build Type: $BUILD_TYPE"
[[ -n "$SECURITY_PATCH" ]] && echo "  Security Patch: $SECURITY_PATCH"

echo ""
echo "Hardware:"
[[ -n "$HARDWARE" ]] && echo "  Hardware: $HARDWARE"
[[ -n "$CHIPNAME" ]] && echo "  Chipset: $CHIPNAME"
[[ -n "$SOC_MANUFACTURER" && -n "$SOC_MODEL" ]] && echo "  SoC: $SOC_MANUFACTURER $SOC_MODEL"
[[ -n "$PLATFORM" ]] && echo "  Platform: $PLATFORM"
if [[ -n "$ABI" ]]; then
  if [[ -n "$ABI2" ]]; then
    echo "  ABI: $ABI, $ABI2"
  else
    echo "  ABI: $ABI"
  fi
fi

if [[ -n "$HEIGHT" && -n "$WIDTH" && -n "$DENSITY" ]]; then
  echo ""
  echo "Display:"
  echo "  Resolution: ${WIDTH}x${HEIGHT} px"
  echo "  Density: ${DENSITY} dpi"
  if [[ -n "$HEIGHT_DP" && -n "$WIDTH_DP" ]]; then
    printf "  Size (dp): %.0fx%.0f\n" "$WIDTH_DP" "$HEIGHT_DP"
  fi
fi
