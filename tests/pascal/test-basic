#!/usr/bin/env bash

# Tests: tests/pascal/

set -euo pipefail

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
BIN="$DIR/../../bin/pascal"
SATISFIES="$DIR/../../bin/satisfies"

if [[ -z "${GEMINI_API_KEY:-}" ]]; then
  echo "1..0 # SKIP GEMINI_API_KEY not set"
  exit 0
fi

echo "1..3"

# Test 1: Usage (no args)
OUTPUT=$(mktemp)
trap 'rm -f "$OUTPUT"' EXIT

if ! "$BIN" >"$OUTPUT" 2>&1; then
  echo "not ok 1 - Script failed with no arguments (expected exit code 0)"
  sed 's/^/# /' "$OUTPUT"
else
  if grep -q "Usage: pascal" "$OUTPUT"; then
    echo "ok 1 - Usage displayed correctly when no arguments provided"
  else
    echo "not ok 1 - Usage output missing expected text"
    sed 's/^/# /' "$OUTPUT"
  fi
fi

# Test 2: Simple Query
QUERY="What is 2 + 2? Answer in one word."
if RESPONSE=$("$BIN" "$QUERY"); then
  if echo "$RESPONSE" | grep -qi "four" || echo "$RESPONSE" | grep -q "4"; then
    echo "ok 2 - Simple query returned correct answer"
  else
    echo "not ok 2 - Simple query returned unexpected answer: $RESPONSE"
  fi
else
  echo "not ok 2 - Simple query failed to execute"
fi

# Test 3: Context Query
CONTEXT="The secret code is 'bananarama'."
QUERY="What is the secret code?"
if RESPONSE=$(echo "$CONTEXT" | "$BIN" "$QUERY"); then
  if echo "$RESPONSE" | grep -qi "bananarama"; then
    echo "ok 3 - Context query returned correct answer"
  else
    echo "not ok 3 - Context query returned unexpected answer: $RESPONSE"
  fi
else
  echo "not ok 3 - Context query failed to execute"
fi
