#!/usr/bin/env bash

set -u

# Setup paths
SCRIPT_DIR=$(dirname "$0")
ROOT_DIR="$SCRIPT_DIR/../.."
BIN_COMPARE="$ROOT_DIR/bin/screenshot-compare"
BIN_SATISFIES="$ROOT_DIR/bin/satisfies"
IMG_LARGE="$SCRIPT_DIR/fixtures/verify_large.png"
IMG_SMALL="$SCRIPT_DIR/fixtures/verify_small.png"
IMG_REGULAR="$SCRIPT_DIR/fixtures/verify_regular.png"
IMG_ITALIC="$SCRIPT_DIR/fixtures/verify_italic.png"

# Total number of tests
TOTAL_TESTS=4
TEST_NUM=0

echo "1..$TOTAL_TESTS"

run_test() {
  local description="$1"
  local img1="$2"
  local img2="$3"
  local assertion="$4"
  
  TEST_NUM=$((TEST_NUM + 1))
  
  # Run comparison, capturing stderr to /dev/null to keep TAP output clean
  OUTPUT=$("$BIN_COMPARE" "$img1" "$img2" 2>/dev/null)
  
  # Check if output satisfies the condition
  if echo "$OUTPUT" | "$BIN_SATISFIES" "$assertion"; then
    echo "ok $TEST_NUM - $description"
  else
    echo "not ok $TEST_NUM - $description"
    echo "# Output was:"
    echo "$OUTPUT" | sed 's/^/# /'
    echo "# Failed assertion: $assertion"
  fi
}

# --- Test Set 1: Layout/Size Differences (Large vs Small) ---

run_test "Large vs Small: Detects height reduction" \
  "$IMG_LARGE" "$IMG_SMALL" \
  "mentions height reduction or size change of the blue container"

run_test "Large vs Small: Detects padding/margin shifts" \
  "$IMG_LARGE" "$IMG_SMALL" \
  "mentions changes to vertical padding or margins"

# --- Test Set 2: Font Style Differences (Regular vs Italic) ---

run_test "Regular vs Italic: Detects style change" \
  "$IMG_REGULAR" "$IMG_ITALIC" \
  "identifies change from regular to italic font style"

run_test "Regular vs Italic: Mentions font weight/style specifics" \
  "$IMG_REGULAR" "$IMG_ITALIC" \
  "mentions italic text or font style variation"
