#!/usr/bin/env bash
#
# Tests for screenshot-compare
#
# Requirements:
#   GEMINI_API_KEY - Must be set to a valid Gemini API key
#
# These tests call the Gemini API, so they are slow and incur API costs.
# They are skipped automatically if GEMINI_API_KEY is not set.

set -u

# Skip all tests if GEMINI_API_KEY is not set
if [[ -z "${GEMINI_API_KEY:-}" ]]; then
  echo "1..0 # SKIP GEMINI_API_KEY not set"
  exit 0
fi

# Setup paths
SCRIPT_DIR=$(dirname "$0")
IMG_LARGE="$SCRIPT_DIR/fixtures/verify_large.png"
IMG_SMALL="$SCRIPT_DIR/fixtures/verify_small.png"
IMG_REGULAR="$SCRIPT_DIR/fixtures/verify_regular.png"
IMG_ITALIC="$SCRIPT_DIR/fixtures/verify_italic.png"
IMG_V33="$SCRIPT_DIR/fixtures/screenshot_api33_v2.png"
IMG_V36="$SCRIPT_DIR/fixtures/screenshot_api36_v2.png"

# Total number of tests
TOTAL_TESTS=6
TEST_NUM=0

echo "1..$TOTAL_TESTS"

run_test() {
  local description="$1"
  local img1="$2"
  local img2="$3"
  local assertion="$4"

  TEST_NUM=$((TEST_NUM + 1))

  # Run comparison, capturing stderr to /dev/null to keep TAP output clean
  OUTPUT=$(screenshot-compare "$img1" "$img2" 2>/dev/null)

  # Check if output satisfies the condition
  if echo "$OUTPUT" | satisfies "$assertion"; then
    echo "ok $TEST_NUM - $description"
  else
    echo "not ok $TEST_NUM - $description"
    echo "# Output was:"
    echo "$OUTPUT" | sed 's/^/# /'
    echo "# Failed assertion: $assertion"
  fi
}

# --- Test Set 1: Layout/Size Differences (Large vs Small) ---

run_test "Large vs Small: Detects height reduction" \
  "$IMG_LARGE" "$IMG_SMALL" \
  "mentions height reduction or size change of the blue container"

run_test "Large vs Small: Detects padding/margin shifts" \
  "$IMG_LARGE" "$IMG_SMALL" \
  "mentions changes to vertical padding or margins"

# --- Test Set 2: Font Style Differences (Regular vs Italic) ---

run_test "Regular vs Italic: Detects style change" \
  "$IMG_REGULAR" "$IMG_ITALIC" \
  "identifies change from regular to italic font style"

run_test "Regular vs Italic: Mentions font weight/style specifics" \
  "$IMG_REGULAR" "$IMG_ITALIC" \
  "mentions italic text or font style variation"

# --- Test Set 3: Circular UI and Background/Wrapping (API 33 vs 36) ---

run_test "Does not misidentify as square" \
  "$IMG_V33" "$IMG_V36" \
  "does not claim one is square"

run_test "Detects background and wrapping changes" \
  "$IMG_V33" "$IMG_V36" \
  "mentions the background color change from dark gray/charcoal to black, and the change in text wrapping or lines"
