#!/usr/bin/env bash
#
# Tests for bin/screenshot-compare identical image detection
#
# Does NOT require GEMINI_API_KEY as it tests local fail-fast logic.

set -u

# Setup paths
SCRIPT_DIR=$(dirname "$0")
ROOT_DIR="$SCRIPT_DIR/../.."
BIN_COMPARE="$ROOT_DIR/bin/screenshot-compare"
IMG1="$SCRIPT_DIR/fixtures/identical_1.png"
IMG2="$SCRIPT_DIR/fixtures/identical_2.png"

# Total number of tests
TOTAL_TESTS=1
TEST_NUM=0

echo "1..$TOTAL_TESTS"

run_test() {
  local description="$1"
  local img1="$2"
  local img2="$3"
  
  TEST_NUM=$((TEST_NUM + 1))
  
  # Run comparison
  # We expect exit code 2 for identical images
  "$BIN_COMPARE" "$img1" "$img2" >/dev/null 2>&1
  EXIT_CODE=$?
  
  if [[ $EXIT_CODE -eq 2 ]]; then
    echo "ok $TEST_NUM - $description"
  else
    echo "not ok $TEST_NUM - $description"
    echo "# Expected exit code 2, got $EXIT_CODE"
  fi
}

run_test "Identical images trigger exit code 2" \
  "$IMG1" "$IMG2"
