#!/usr/bin/env bash

# Tests: tests/markdown-extract-body/

set -euo pipefail

DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"
BIN="$DIR/../../bin/markdown-extract-body"
SATISFIES="$DIR/../../bin/satisfies"
FIXTURES="$DIR/fixtures"

if [[ -z "${GEMINI_API_KEY:-}" ]]; then
  echo "1..0 # SKIP GEMINI_API_KEY not set"
  exit 0
fi

echo "1..1"

OUTPUT=$(mktemp)
trap 'rm -f "$OUTPUT"' EXIT

# Run the script
if ! "$BIN" <"$FIXTURES/input.md" >"$OUTPUT"; then
  echo "not ok 1 - markdown-extract-body failed to run"
  exit 1
fi

# Compare using satisfies
EXPECTED=$(cat "$FIXTURES/expected.md")
PROMPT="The input is a Markdown extraction of a web article. The expected text is a reference for what the extraction should look like. Does the input semantically match the expected text, capturing the same core narrative and structure while ignoring minor metadata differences or whitespace? Expected text: $EXPECTED"

if cat "$OUTPUT" | "$SATISFIES" "$PROMPT"; then
  echo "ok 1 - Output matches expected content"
else
  echo "not ok 1 - Output does not match expected content"
  echo "# Actual output:"
  cat "$OUTPUT" | sed 's/^/# /'
  exit 1
fi
