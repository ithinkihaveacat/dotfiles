#!/usr/bin/env bash
#
# Tests for bin/jetpack inspect subcommand

set -u

# Setup paths
SCRIPT_DIR=$(dirname "$0")
ROOT_DIR="$SCRIPT_DIR/../.."
BIN_JETPACK="$ROOT_DIR/bin/jetpack"

# Temporary directory for downloads
TEST_TMP=$(mktemp -d)
trap 'rm -rf "$TEST_TMP"' EXIT

# Total number of tests
TOTAL_TESTS=5
TEST_NUM=0

echo "1..$TOTAL_TESTS"

run_test() {
  local args="$1"
  local description="$2"

  TEST_NUM=$((TEST_NUM + 1))
  
  # Run in subshell to capture exit code
  # We use a unique output dir for each test to avoid conflicts
  if "$BIN_JETPACK" inspect --output "$TEST_TMP/$TEST_NUM" $args >"$TEST_TMP/out.$TEST_NUM" 2>&1; then
    echo "ok $TEST_NUM - $description"
  else
    echo "not ok $TEST_NUM - $description"
    echo "# Command failed: $BIN_JETPACK inspect $args"
    cat "$TEST_TMP/out.$TEST_NUM" | sed 's/^/# /'
  fi
}

# The failing test case reported by user
run_test "androidx.lifecycle.ViewModel" "inspect androidx.lifecycle.ViewModel should succeed"

# Additional examples from help
run_test "androidx.core.splashscreen.SplashScreen" "inspect androidx.core.splashscreen.SplashScreen"
run_test "androidx.wear.tiles:tiles" "inspect androidx.wear.tiles:tiles (coordinate)"
run_test "androidx.wear.ambient.AmbientLifecycleObserver" "inspect androidx.wear.ambient.AmbientLifecycleObserver"

# Pinned version test
run_test "androidx.lifecycle.ViewModel 2.8.7" "inspect androidx.lifecycle.ViewModel 2.8.7 (pinned)"
