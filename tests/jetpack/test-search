#!/usr/bin/env bash
#
# Tests for bin/jetpack search subcommand

set -u

# Setup paths
SCRIPT_DIR=$(dirname "$0")
ROOT_DIR="$SCRIPT_DIR/../.."
BIN_JETPACK="$ROOT_DIR/bin/jetpack"
TEST_CACHE_DIR=$(mktemp -d)

# Mock XDG_CACHE_HOME to use our temp dir
export XDG_CACHE_HOME="$TEST_CACHE_DIR"
export TMPDIR="$TEST_CACHE_DIR"

# Total number of tests
TOTAL_TESTS=2
TEST_NUM=0

echo "1..$TOTAL_TESTS"

cleanup() {
  rm -rf "$TEST_CACHE_DIR"
}
trap cleanup EXIT

# Create a mock index file
mkdir -p "$TEST_CACHE_DIR/jetpack"
cat <<EOF > "$TEST_CACHE_DIR/jetpack/androidx-index.json"
[
  {"group": "androidx.wear.compose"},
  {"group": "androidx.activity"}
]
EOF

run_test() {
  local args="$1"
  local expected="$2"

  TEST_NUM=$((TEST_NUM + 1))

  # Run with --index to force using our mock file and avoid network calls
  OUTPUT=$("$BIN_JETPACK" search --index "$args")

  if [ "$OUTPUT" == "$expected" ]; then
    echo "ok $TEST_NUM - search $args -> $expected"
  else
    echo "not ok $TEST_NUM - search $args -> $expected"
    echo "# Got: $OUTPUT"
    echo "# Expected: $expected"
  fi
}

# Test 1: Exact match logic (via substring)
run_test "androidx.activity" "androidx.activity"

# Test 2: Substring match
run_test "wear.compose" "androidx.wear.compose"
