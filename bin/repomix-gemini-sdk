#!/usr/bin/env bash

set -e

BUILD_DIR=$(mktemp -d)
trap 'rm -rf "$BUILD_DIR"' EXIT

require() {
    hash "$@" || { echo "Error: Command '$1' not found." >&2; exit 127; }
}

require curl
require unzip
require repomix
require jq

# Download google-gemini/cookbook repo
COOKBOOK_URL="https://github.com/google-gemini/cookbook/archive/refs/heads/main.zip"
COOKBOOK_ZIP="$BUILD_DIR/cookbook.zip"
COOKBOOK_DIR="$BUILD_DIR/cookbook-main"

curl -sSL -o "$COOKBOOK_ZIP" "$COOKBOOK_URL"
unzip -o -q "$COOKBOOK_ZIP" -d "$BUILD_DIR"

# Download googleapis/js-genai repo
JSGENAI_URL="https://github.com/googleapis/js-genai/archive/refs/heads/main.zip"
JSGENAI_ZIP="$BUILD_DIR/js-genai.zip"
JSGENAI_DIR="$BUILD_DIR/js-genai-main"

curl -sSL -o "$JSGENAI_ZIP" "$JSGENAI_URL"
unzip -o -q "$JSGENAI_ZIP" -d "$BUILD_DIR"

# Create a filtered notebooks directory
FILTERED_DIR="$BUILD_DIR/filtered"
mkdir -p "$FILTERED_DIR"

# Filter Book_illustration.ipynb - remove binary image data
jq 'walk(if type == "object" and has("data") and (.data | type == "object") then
  .data |= with_entries(select(.key | test("^image/") | not))
  else . end) |
  walk(if type == "object" and has("outputs") then
  .outputs |= map(if .data then .data |= with_entries(select(.key | test("^image/") | not)) else . end)
  else . end)' \
  "$COOKBOOK_DIR/examples/Book_illustration.ipynb" > "$FILTERED_DIR/Book_illustration.ipynb"

# Filter Image_out.ipynb - remove binary image data
jq 'walk(if type == "object" and has("data") and (.data | type == "object") then
  .data |= with_entries(select(.key | test("^image/") | not))
  else . end) |
  walk(if type == "object" and has("outputs") then
  .outputs |= map(if .data then .data |= with_entries(select(.key | test("^image/") | not)) else . end)
  else . end)' \
  "$COOKBOOK_DIR/quickstarts/Image_out.ipynb" > "$FILTERED_DIR/Image_out.ipynb"

# Create a combined directory structure for repomix
COMBINED_DIR="$BUILD_DIR/combined"
mkdir -p "$COMBINED_DIR/notebooks"
mkdir -p "$COMBINED_DIR/js-genai-src"

# Copy filtered notebooks
cp "$FILTERED_DIR/Book_illustration.ipynb" "$COMBINED_DIR/notebooks/"
cp "$FILTERED_DIR/Image_out.ipynb" "$COMBINED_DIR/notebooks/"

# Copy js-genai src directory
cp -r "$JSGENAI_DIR/src"/* "$COMBINED_DIR/js-genai-src/"

# Use repomix to combine everything
repomix "$COMBINED_DIR" --no-security-check --quiet -o -
