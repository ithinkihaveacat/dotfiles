#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0")

Generate a combined repomix output of the Google Gemini TypeScript/JavaScript SDK.

This script downloads and combines:
  - Full source code from googleapis/js-genai SDK (src directory only)

Output is written to stdout.

Options:
  -h, --help  Display this help message and exit

Examples:
  $(basename "$0")
    Generate combined documentation to stdout

  $(basename "$0") > gemini-sdk-context.txt
    Save combined documentation to a file
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

set -e

BUILD_DIR=$(mktemp -d)
trap 'rm -rf "$BUILD_DIR"' EXIT

require() {
  hash "$@" || {
    echo "Error: Command '$1' not found." >&2
    exit 127
  }
}

require curl
require unzip
require repomix

# Download googleapis/js-genai repo
JSGENAI_URL="https://github.com/googleapis/js-genai/archive/refs/heads/main.zip"
JSGENAI_ZIP="$BUILD_DIR/js-genai.zip"
JSGENAI_DIR="$BUILD_DIR/js-genai-main"

curl -fsSL -o "$JSGENAI_ZIP" "$JSGENAI_URL"
unzip -o -q "$JSGENAI_ZIP" -d "$BUILD_DIR"

# Create a combined directory structure for repomix
COMBINED_DIR="$BUILD_DIR/combined"
mkdir -p "$COMBINED_DIR/js-genai-src"

# Copy js-genai src directory
cp -r "$JSGENAI_DIR/src"/* "$COMBINED_DIR/js-genai-src/"

# Use repomix to combine everything
repomix "$COMBINED_DIR" --no-security-check --quiet -o -
