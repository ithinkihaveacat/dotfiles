#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") PACKAGE_OR_CLASS_NAME

Gets the Jetpack library for a given Android package or fully-qualified class name.

The script uses a combination of a heuristic rule and a lookup table for exceptions.

Arguments:
  PACKAGE_OR_CLASS_NAME  The package name (e.g., androidx.core.splashscreen) or
                         class name (e.g., androidx.core.splashscreen.SplashScreen).

Examples:
  $(basename "$0") androidx.core.splashscreen.SplashScreen.Companion.installSplashScreen
  # Output: androidx.core:core-splashscreen

  $(basename "$0") androidx.wear.ambient.AmbientLifecycleObserver
  # Output: androidx.wear:wear

  $(basename "$0") androidx.wear.protolayout.material3.textButton
  # Output: androidx.wear.protolayout:protolayout-material3
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

set -e

if [ "$#" -lt 1 ];
then
  echo "$(basename "$0"): missing required arguments" >&2
  echo "Usage: $(basename "$0") PACKAGE_OR_CLASS_NAME" >&2
  exit 1
fi

INPUT=$1

# Exception table for known mappings that don't follow the general rule.
# The keys are prefixes, so we match against the start of the input string.
case "$INPUT" in
  androidx.core.splashscreen*)
    echo "androidx.core:core-splashscreen"
    exit 0
    ;;
  androidx.wear.ambient*)
    # This is an exception. The package is androidx.wear.ambient, but it's in the 'wear' artifact.
    echo "androidx.wear:wear"
    exit 0
    ;;
  androidx.wear.protolayout.material3*)
    echo "androidx.wear.protolayout:protolayout-material3"
    exit 0
    ;;
  androidx.concurrent.futures*)
    echo "androidx.concurrent:concurrent-futures"
    exit 0
    ;;
  androidx.datastore.preferences.core*)
    echo "androidx.datastore:datastore-preferences-core"
    exit 0
    ;;
esac

# This is a best-effort attempt to find the package name part of the input.
PACKAGE_NAME=$(echo "$INPUT" | grep -o '^[a-z0-9\._-]*' | sed 's/\.$//')

# Fallback for class names
if ! echo "$PACKAGE_NAME" | grep -q '\.'; then
    PACKAGE_NAME=$(echo "$INPUT" | sed -n 's/\(.*\)\.\([A-Z]\).*/\1/p')
fi
if [ -z "$PACKAGE_NAME" ]; then
    PACKAGE_NAME=$INPUT
fi


# Heuristic: Find the longest matching library name in the package name.
# This list is generated from the AndroidX releases page.
JETPACK_LIBRARIES=(
activity
ads
annotation
appcompat
appfunctions
appsearch
arch.core
asynclayoutinflater
autofill
benchmark
biometric
bluetooth
browser
camera
camera-core
camera-camera2
camera-extensions
camera-lifecycle
camera-video
camera-view
camera-viewfinder
car
car.app
cardview
collection
compose
animation
compiler
foundation
ui
material
material3
runtime
concurrent
concurrent-futures
constraintlayout
contentpager
coordinatorlayout
core
core-splashscreen
core.uwb
credentials
credentials-providerevents
credentials-registry
cursoradapter
customview
databinding
datastore
datastore-preferences-core
documentfile
draganddrop
drawerlayout
dynamicanimation
emoji
emoji2
enterprise
exifinterface
fragment
games
glance
graphics
gridlayout
health
health.connect
heifwriter
hilt
ink
input
interpolator
javascriptengine
jetifier
leanback
legacy
lifecycle
lint
loader
localbroadcastmanager
media
media3
mediarouter
metrics
multidex
navigation
navigation3
navigationevent
paging
palette
pdf
percentlayout
performance
photopicker
preference
print
privacysandbox-activity
privacysandbox-ads
privacysandbox-plugins
privacysandbox-sdkruntime
privacysandbox-tools
privacysandbox-ui
profileinstaller
recommendation
recyclerview
remotecallback
resourceinspection
room
savedstate
security
sharetarget
slice
slidingpanelayout
sqlite
startup
swiperefreshlayout
test
test.uiautomator
text
text-vertical
textclassifier
tracing
transition
tv
tvprovider
vectordrawable
versionedparcelable
viewpager
viewpager2
wear
wear-compose
wear-protolayout
wear-protolayout-material
wear-protolayout-material3
wear-tiles
wear-watchface
webkit
window
window-extensions-core
work
)

best_match=""
for lib in "${JETPACK_LIBRARIES[@]}"; do
  package_segment=$(echo "$lib" | sed 's/-/./g')
  if [[ "$PACKAGE_NAME" == *"$package_segment" ]]; then
    if [ ${#lib} -gt ${#best_match} ]; then
      best_match=$lib
    fi
  fi
done

if [ -n "$best_match" ]; then
    # Simple heuristic: group is the package name up to the artifact.
    group=$(echo "$PACKAGE_NAME" | sed "s/\.$best_match.*//")
  echo "$group:$best_match"
  exit 0
fi

echo "$(basename "$0"): error: could not determine library for package '$INPUT'" >&2
echo "You can extend this script by adding an entry to the lookup table." >&2
exit 1
