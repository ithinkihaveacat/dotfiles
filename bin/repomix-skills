#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0")

Generate a combined repomix output of agent skills documentation.

This script downloads and combines:
  - All .mdx files from the agentskills/agentskills GitHub repository
  - The best-practices.md file from platform.claude.com
  - The skill-creator SKILL.md from anthropics/skills
  - The skills.md file from google-gemini/gemini-cli
  - The skills.md and create-skill.md files from developers.openai.com/codex

Options:
  -h, --help  Display this help message and exit

Examples:
  $(basename "$0")
    Generate combined documentation to stdout

  $(basename "$0") > skills-context.txt
    Save combined documentation to a file

  $(basename "$0") | pbcopy
    Copy combined documentation to clipboard (macOS)
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

set -e

BUILD_DIR=$(mktemp -d)
trap 'rm -rf "$BUILD_DIR"' EXIT

require() {
  hash "$@" || {
    echo "$(basename "$0"): $1 not found" >&2
    exit 127
  }
}

require curl
require unzip
require repomix

# Helper function to download a file and prepend the source URL
download_with_source() {
  local url="$1"
  local dest="$2"
  local filename
  filename=$(basename "$dest")

  echo "Downloading $filename..." >&2

  # Download to a temporary file
  local temp_file
  temp_file=$(mktemp)
  
  if curl -fsSL -o "$temp_file" "$url"; then
    {
      echo "Source: $url"
      echo ""
      cat "$temp_file"
    } > "$dest"
    rm "$temp_file"
  else
    echo "Error: Failed to download $url" >&2
    rm "$temp_file"
    return 1
  fi
}

# Download agentskills repository
REPO_URL="https://github.com/agentskills/agentskills/archive/refs/heads/main.zip"
ZIP_FILE="$BUILD_DIR/main.zip"
EXTRACT_DIR="$BUILD_DIR"
DOCS_DIR="$EXTRACT_DIR/agentskills-main"

curl -fsSL -o "$ZIP_FILE" "$REPO_URL"
unzip -o -q "$ZIP_FILE" -d "$EXTRACT_DIR"

# Add source headers to extracted .mdx files
# Base URL for the repository files
REPO_BASE_URL="https://github.com/agentskills/agentskills/blob/main"

find "$DOCS_DIR" -name "*.mdx" | while read -r file; do
  # Calculate relative path from DOCS_DIR
  rel_path="${file#$DOCS_DIR/}"
  # Construct the full source URL
  source_url="$REPO_BASE_URL/$rel_path"
  
  # Create a temporary file with the header
  temp_file=$(mktemp)
  {
    echo "Source: $source_url"
    echo ""
    cat "$file"
  } > "$temp_file"
  
  # Replace the original file
  mv "$temp_file" "$file"
done

# Download best-practices.md from platform.claude.com
BEST_PRACTICES_URL="https://platform.claude.com/docs/en/agents-and-tools/agent-skills/best-practices.md"
download_with_source "$BEST_PRACTICES_URL" "$DOCS_DIR/best-practices.md"

# Download skill-creator SKILL.md from anthropics/skills
SKILL_CREATOR_URL="https://raw.githubusercontent.com/anthropics/skills/refs/heads/main/skills/skill-creator/SKILL.md"
download_with_source "$SKILL_CREATOR_URL" "$DOCS_DIR/skill-creator-SKILL.md"

# Download skills.md from google-gemini/gemini-cli
GEMINI_CLI_SKILLS_URL="https://raw.githubusercontent.com/google-gemini/gemini-cli/main/docs/cli/skills.md"
download_with_source "$GEMINI_CLI_SKILLS_URL" "$DOCS_DIR/gemini-cli-skills.md"

# Download skills.md from developers.openai.com/codex
OPENAI_SKILLS_URL="https://developers.openai.com/codex/skills.md"
download_with_source "$OPENAI_SKILLS_URL" "$DOCS_DIR/openai-codex-skills.md"

# Download create-skill.md from developers.openai.com/codex
OPENAI_CREATE_SKILL_URL="https://developers.openai.com/codex/skills/create-skill.md"
download_with_source "$OPENAI_CREATE_SKILL_URL" "$DOCS_DIR/openai-codex-create-skill.md"

repomix "$DOCS_DIR" --include="**/*.mdx,best-practices.md,skill-creator-SKILL.md,gemini-cli-skills.md,openai-codex-skills.md,openai-codex-create-skill.md" --no-security-check --quiet -o -
