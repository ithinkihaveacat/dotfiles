#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] PACKAGE_OR_CLASS_NAME [VERSION] [REPO_URL]

Resolves a Jetpack library from a package or class name, downloads it,
and prints the path to the extracted source code.

This script is a wrapper around 'jetpack-resolve-library' and
'jetpack-download-source'.

Arguments:
  PACKAGE_OR_CLASS_NAME  Fully qualified package/class name
                         (e.g., androidx.core.splashscreen.SplashScreen) or
                         library coordinate (e.g., androidx.core:core-splashscreen)
  VERSION                Version string: ALPHA, BETA, RC, STABLE, LATEST, or a
                         specific version number (optional, defaults to STABLE)
  REPO_URL               Maven repository URL (optional,
                         default: https://dl.google.com/android/maven2)

Options:
  -h, --help     Display this help message and exit
  --output DIR   Specify output directory (default: create temporary directory)

Examples:
  # View source for a class
  $(basename "$0") androidx.core.splashscreen.SplashScreen

  # View source for a library, latest alpha version
  $(basename "$0") androidx.wear.tiles:tiles ALPHA

  # View source and specify an output directory
  $(basename "$0") --output /tmp/wear-tiles androidx.wear.tiles:tiles

  # Change directory to the downloaded source
  pushd "\$($(basename "$0") androidx.wear.tiles:tiles)"
EOF
  exit 0
}

set -e

require() {
  hash "$@" || {
    echo "Error: Command '$1' not found." >&2
    exit 127
  }
}

require jetpack-resolve-library
require jetpack-download-source

ARGS=()
OUTPUT_DIR=""
while [[ $# -gt 0 ]]; do
  case "$1" in
  -h | --help)
    usage
    ;;
  --output)
    if [ -z "$2" ]; then
      echo "$(basename "$0"): option '--output' requires an argument" >&2
      exit 1
    fi
    OUTPUT_DIR="$2"
    shift 2
    ;;
  *)
    ARGS+=("$1")
    shift
    ;;
  esac
done

if [ ${#ARGS[@]} -eq 0 ]; then
  echo "$(basename "$0"): missing required argument" >&2
  usage
fi

PACKAGE_OR_CLASS_NAME="${ARGS[0]}"
REMAINING_ARGS=("${ARGS[@]:1}")

# If input does not contain a colon, assume it's a class/package name
# and resolve it to a library coordinate.
if [[ "$PACKAGE_OR_CLASS_NAME" != *:* ]]; then
  PACKAGE_NAME=$(jetpack-resolve-library "$PACKAGE_OR_CLASS_NAME")
  if [ -z "$PACKAGE_NAME" ]; then
    echo "$(basename "$0"): could not resolve library for '$PACKAGE_OR_CLASS_NAME'" >&2
    exit 1
  fi
  echo "info: Resolved '$PACKAGE_OR_CLASS_NAME' to '$PACKAGE_NAME'" >&2
else
  PACKAGE_NAME="$PACKAGE_OR_CLASS_NAME"
fi

# Construct arguments for jetpack-download-source
DOWNLOAD_ARGS=()
if [ -n "$OUTPUT_DIR" ]; then
  DOWNLOAD_ARGS+=(--output "$OUTPUT_DIR")
fi
DOWNLOAD_ARGS+=("$PACKAGE_NAME")
if [ ${#REMAINING_ARGS[@]} -gt 0 ]; then
  DOWNLOAD_ARGS+=("${REMAINING_ARGS[@]}")
fi

# Download the source and echo the output directory path
jetpack-download-source "${DOWNLOAD_ARGS[@]}"
