#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0")

Lists all available tile services on the connected device.

This script queries the package manager for services that require the
'com.google.android.wearable.permission.BIND_TILE_PROVIDER' permission.

Options:
  -h, --help      Display this help message and exit

Environment:
  ANDROID_SERIAL  Serial number of device to connect to (see 'adb devices -l').
                  To target a specific device, use:
                    env ANDROID_SERIAL=<serial> $(basename "$0")

Examples:
  $(basename "$0")
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

require() { hash "$@" || exit 127; }

require adb

# Dump services and extract component names from lines containing BIND_TILE_PROVIDER
# Format of dumpsys package services:
#     package.name/class.name: com.google.android.wearable.permission.BIND_TILE_PROVIDER
# We extract the component name (before the colon) from matching lines.

adb shell dumpsys package services |
  grep "com.google.android.wearable.permission.BIND_TILE_PROVIDER" |
  grep -v "Permission \[" |
  grep -v "perm=PermissionInfo" |
  grep -v "^[[:space:]]*com.google.android.wearable.permission.BIND_TILE_PROVIDER" |
  sed -E 's/^[[:space:]]*([^:]+):.*/\1/' |
  sort
