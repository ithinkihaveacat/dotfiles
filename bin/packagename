#!/usr/bin/env bash

# packagename - Unified Android package management tool
#
# A collection of adb-based utilities for working with Android packages.

set -euo pipefail

SCRIPT_NAME=$(basename "$0")

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

require() {
  hash "$@" || {
    echo "$SCRIPT_NAME: command '$1' not found" >&2
    exit 127
  }
}

# =============================================================================
# COMMAND DEFINITIONS
# =============================================================================

cmd_clear_cache() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME clear-cache PACKAGE" >&2
    echo "" >&2
    echo "Clears the cache of a given package." >&2
    exit 1
  fi
  adb exec-out pm clear "$package"
}

cmd_dumpsys() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME dumpsys PACKAGE" >&2
    echo "" >&2
    echo "Display dumpsys package information." >&2
    exit 1
  fi
  adb exec-out dumpsys package "$package"
}

cmd_force_stop() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME force-stop PACKAGE" >&2
    echo "" >&2
    echo "Force stop an application." >&2
    exit 1
  fi
  adb exec-out am force-stop "$package"
}

cmd_jobscheduler() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME jobscheduler PACKAGE" >&2
    echo "" >&2
    echo "Display jobscheduler information for a package." >&2
    exit 1
  fi
  adb exec-out dumpsys jobscheduler "$package" | perl -ne 'print if (/  JOB/ .. /^$/) || (/  Job history/ .. /^$/)'
}

cmd_launch() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME launch PACKAGE" >&2
    echo "" >&2
    echo "Launch an application's main activity." >&2
    exit 1
  fi
  # --pct-syskeys via https://stackoverflow.com/a/46935037
  adb exec-out monkey --pct-syskeys 0 -p "$package" -c android.intent.category.LAUNCHER 1
}

cmd_logcat() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME logcat PACKAGE" >&2
    echo "" >&2
    echo "Display logcat output filtered by package's process ID." >&2
    exit 1
  fi
  local pid
  pid=$(adb exec-out pidof "$package")
  if [ -z "$pid" ]; then
    echo "$SCRIPT_NAME: can't get pid of $package" >&2
    exit 1
  fi
  adb logcat --pid="$pid"
}

cmd_permissions() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME permissions PACKAGE" >&2
    echo "" >&2
    echo "List the permissions declared by a package." >&2
    exit 1
  fi
  adb exec-out dumpsys package "$package" | perl -ne 'print (s/^....// && $_) if /^    declared permissions:/ .. /^$/'
}

cmd_pid() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME pid PACKAGE" >&2
    echo "" >&2
    echo "Get the process ID of a running package." >&2
    exit 1
  fi
  adb exec-out pidof "$package"
}

cmd_playstore() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME playstore PACKAGE" >&2
    echo "" >&2
    echo "Open the Play Store page for a package." >&2
    exit 1
  fi
  adb exec-out am start -a android.intent.action.VIEW -d "$(printf 'market://details?id=%s' "$package")"
}

cmd_profile_generate() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME profile-generate PACKAGE" >&2
    echo "" >&2
    echo "Trigger background dex optimization for a package." >&2
    exit 1
  fi
  adb exec-out cmd package compile -r bg-dexopt "$package"
}

cmd_profile_status() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME profile-status PACKAGE" >&2
    echo "" >&2
    echo "Display the dex optimization status for a package." >&2
    exit 1
  fi
  adb exec-out dumpsys package dexopt | grep -A 1 "$package"
}

cmd_pull() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME pull PACKAGE" >&2
    echo "" >&2
    echo "Pull the APK file of a package from the device." >&2
    exit 1
  fi
  local apk_path
  apk_path=$(adb exec-out pm path "$package" | head -1 | cut -f 2 -d ':')
  if [ -z "$apk_path" ]; then
    echo "$SCRIPT_NAME: $package not found on device" >&2
    exit 1
  fi
  adb pull "$apk_path" "$(printf "%s.apk" "$package")"
}

cmd_reset_permissions() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME reset-permissions PACKAGE" >&2
    echo "" >&2
    echo "Reset all permissions for a package." >&2
    exit 1
  fi
  adb exec-out pm reset-permissions "$package"
}

cmd_services() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME services PACKAGE" >&2
    echo "" >&2
    echo "List the services of a package." >&2
    exit 1
  fi
  adb exec-out dumpsys activity service "$package" | grep '^SERVICE' | awk '{ print $2 }'
}

cmd_services_dumpsys() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME services-dumpsys PACKAGE" >&2
    echo "" >&2
    echo "Display detailed dumpsys for all services in a package." >&2
    exit 1
  fi
  local services
  services=$(adb exec-out dumpsys activity service "$package" | grep '^SERVICE' | awk '{ print $2 }')
  for s in $services; do
    printf "### %s ###\n" "$s"
    echo
    # OS metadata about the service itself
    adb exec-out dumpsys activity services "$s"
    echo
    # Service-specific data
    adb exec-out dumpsys activity service "$s"
    echo
  done
}

cmd_settings() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME settings PACKAGE" >&2
    echo "" >&2
    echo "Open the settings page for a package." >&2
    exit 1
  fi
  adb shell am start -a android.settings.APPLICATION_DETAILS_SETTINGS -d "package:$package"
}

cmd_tiles() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME tiles PACKAGE" >&2
    echo "" >&2
    echo "List the tiles provided by a package (Wear OS)." >&2
    exit 1
  fi
  adb shell cmd package query-services -a androidx.wear.tiles.action.BIND_TILE_PROVIDER --brief | grep -E "\s+$package" | sed 's/^[[:space:]]*//' | sort
}

cmd_uninstall() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME uninstall PACKAGE" >&2
    echo "" >&2
    echo "Uninstall a package from the device." >&2
    exit 1
  fi
  adb uninstall "$package"
}

cmd_version() {
  local package="${1:-}"
  if [ -z "$package" ]; then
    echo "Usage: $SCRIPT_NAME version PACKAGE" >&2
    echo "" >&2
    echo "Get the version name and code of a package." >&2
    exit 1
  fi
  # Check if package is installed
  if ! adb shell pm list packages | grep -q "^package:${package}$"; then
    echo "$SCRIPT_NAME: package '$package' not found" >&2
    exit 1
  fi
  printf "packageName=%s\n" "$package"
  adb exec-out dumpsys package "$package" | sed -n '/^Packages/,/^Hidden system packages/p' | grep versionName | awk '{ print $1 }'
  adb exec-out dumpsys package "$package" | sed -n '/^Packages/,/^Hidden system packages/p' | grep versionCode | awk '{ print $1 }'
  adb exec-out dumpsys package "$package" | sed -n '/^Hidden system packages/,/^Queries/p' | grep versionName | awk '{ print $1 }'
  adb exec-out dumpsys package "$package" | sed -n '/^Hidden system packages/,/^Queries/p' | grep versionCode | awk '{ print $1 }'
}

cmd_view() {
  local package="${1:-}"
  local url="${2:-}"
  if [ -z "$package" ] || [ -z "$url" ]; then
    echo "Usage: $SCRIPT_NAME view PACKAGE URL" >&2
    echo "" >&2
    echo "Open a URL within a specific package (for testing deep links)." >&2
    exit 1
  fi
  adb exec-out am start -W -a android.intent.action.VIEW -d "$url" "$package"
}

# =============================================================================
# COMMAND REGISTRY
# =============================================================================

COMMANDS=(
  # Process/Lifecycle
  "launch:Launch an application's main activity"
  "force-stop:Force stop an application"
  "pid:Get the process ID of a running package"
  "logcat:Display logcat filtered by package's PID"

  # Information
  "dumpsys:Display dumpsys package information"
  "version:Get the version name and code"
  "permissions:List declared permissions"
  "services:List the services of a package"
  "services-dumpsys:Display detailed dumpsys for all services"
  "jobscheduler:Display jobscheduler information"
  "tiles:List tiles provided by a package (Wear OS)"

  # Profile/Optimization
  "profile-status:Display dex optimization status"
  "profile-generate:Trigger background dex optimization"

  # Package Management
  "pull:Pull the APK file from the device"
  "uninstall:Uninstall a package"
  "clear-cache:Clear the cache of a package"
  "reset-permissions:Reset all permissions"

  # Navigation
  "view:Open a URL within a package (PACKAGE URL)"
  "playstore:Open the Play Store page"
  "settings:Open the settings page"
)

# =============================================================================
# USAGE AND ARGUMENT PARSING
# =============================================================================

usage() {
  cat <<EOF
Usage: $SCRIPT_NAME <command> [arguments]

Android package management utilities via adb.

Commands:
EOF

  # Group: Process/Lifecycle
  echo "  Process/Lifecycle:"
  printf "    %-20s %s\n" "launch" "Launch an application's main activity"
  printf "    %-20s %s\n" "force-stop" "Force stop an application"
  printf "    %-20s %s\n" "pid" "Get the process ID of a running package"
  printf "    %-20s %s\n" "logcat" "Display logcat filtered by package's PID"
  echo

  # Group: Information
  echo "  Information:"
  printf "    %-20s %s\n" "dumpsys" "Display dumpsys package information"
  printf "    %-20s %s\n" "version" "Get the version name and code"
  printf "    %-20s %s\n" "permissions" "List declared permissions"
  printf "    %-20s %s\n" "services" "List the services of a package"
  printf "    %-20s %s\n" "services-dumpsys" "Display detailed dumpsys for all services"
  printf "    %-20s %s\n" "jobscheduler" "Display jobscheduler information"
  printf "    %-20s %s\n" "tiles" "List tiles provided by a package (Wear OS)"
  echo

  # Group: Profile/Optimization
  echo "  Profile/Optimization:"
  printf "    %-20s %s\n" "profile-status" "Display dex optimization status"
  printf "    %-20s %s\n" "profile-generate" "Trigger background dex optimization"
  echo

  # Group: Package Management
  echo "  Package Management:"
  printf "    %-20s %s\n" "pull" "Pull the APK file from the device"
  printf "    %-20s %s\n" "uninstall" "Uninstall a package"
  printf "    %-20s %s\n" "clear-cache" "Clear the cache of a package"
  printf "    %-20s %s\n" "reset-permissions" "Reset all permissions"
  echo

  # Group: Navigation
  echo "  Navigation:"
  printf "    %-20s %s\n" "view" "Open a URL within a package (PACKAGE URL)"
  printf "    %-20s %s\n" "playstore" "Open the Play Store page"
  printf "    %-20s %s\n" "settings" "Open the settings page"

  cat <<EOF

Options:
  --help        Display this help message and exit
  --list        List available commands (names only)

Environment:
  ANDROID_SERIAL  Serial number of device to connect to (see 'adb devices -l').
                  To target a specific device, use:
                    env ANDROID_SERIAL=<serial> $SCRIPT_NAME <command> ...

Examples:
  $SCRIPT_NAME launch com.android.systemui
  $SCRIPT_NAME version com.google.android.apps.photos
  $SCRIPT_NAME view com.android.chrome https://www.google.com
  $SCRIPT_NAME profile-status com.example.app
EOF
  exit "${1:-0}"
}

list_commands() {
  for entry in "${COMMANDS[@]}"; do
    echo "${entry%%:*}"
  done
  exit 0
}

# =============================================================================
# MAIN
# =============================================================================

if [[ $# -lt 1 ]]; then
  usage 1 >&2
fi

case "$1" in
  help|--help)
    usage 0
    ;;
  --list)
    list_commands
    ;;
  -*)
    echo "$SCRIPT_NAME: unknown option: $1" >&2
    exit 1
    ;;
  *)
    COMMAND="$1"
    shift
    ;;
esac

# Check dependency
require adb

# Map command to function and execute
CMD_FUNC="cmd_${COMMAND//-/_}"
if ! declare -f "$CMD_FUNC" > /dev/null 2>&1; then
  echo "$SCRIPT_NAME: unknown command: $COMMAND" >&2
  echo "Run '$SCRIPT_NAME --list' to see available commands" >&2
  exit 1
fi

if [[ "${1:-}" == "--help" ]]; then
  usage 0
fi

"$CMD_FUNC" "$@"
