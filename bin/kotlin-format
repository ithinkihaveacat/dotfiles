#!/usr/bin/env bash

set -euo pipefail

usage() {
  cat <<EOF
Usage: $(basename "$0") [FILE...]

Format Kotlin files using ktfmt with kotlinlang style.

When FILEs are provided, each file is formatted in place. When no FILE is
provided, reads from standard input and writes to standard output.

The ktfmt jar is automatically downloaded from GitHub on first use and
cached in \$XDG_DATA_HOME/ktfmt (or ~/.local/share/ktfmt).

Arguments:
  FILE...     Paths to Kotlin files to format (optional)

Options:
  -h, --help  Display this help message and exit

Examples:

# Format a file in place

  $(basename "$0") Main.kt

# Format multiple files

  $(basename "$0") src/*.kt

# Format from stdin to stdout

  cat Main.kt | $(basename "$0")

# Format a file and see the result

  $(basename "$0") < src/Example.kt
EOF
  exit 0
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
fi

if [[ $# -eq 0 && -t 0 ]]; then
  usage
fi

require() { hash "$@" || exit 127; }

require java
require curl
require jq

KTFMT_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/ktfmt"

# Find existing jar or download latest
get_jar() {
  local jar
  jar=$(find "$KTFMT_DIR" -maxdepth 1 -name 'ktfmt-*-with-dependencies.jar' 2>/dev/null | head -n 1)

  if [[ -n "$jar" ]]; then
    echo "$jar"
    return 0
  fi

  # Download latest release
  echo "Downloading ktfmt..." >&2
  mkdir -p "$KTFMT_DIR"

  local url
  url=$(curl -fsSL https://api.github.com/repos/facebook/ktfmt/releases |
    jq -r '.[0].assets[] | select(.browser_download_url | endswith("with-dependencies.jar")) | .browser_download_url')

  if [[ -z "$url" ]]; then
    echo "$(basename "$0"): failed to find download URL" >&2
    return 1
  fi

  local filename
  filename=$(basename "$url")
  curl -fsSL "$url" -o "$KTFMT_DIR/$filename"
  echo "Downloaded $filename" >&2
  echo "$KTFMT_DIR/$filename"
}

jar=$(get_jar)

if [[ $# -eq 0 ]]; then

  # Read from stdin, write to stdout

  java -jar "$jar" --kotlinlang-style -
else

  # Format files in place

  FAILED=0
  for FILE in "$@"; do
    if [[ ! -f "$FILE" ]]; then
      echo "$(basename "$0"): $FILE: No such file or directory" >&2
      FAILED=1
      continue
    fi
    if java -jar "$jar" --kotlinlang-style "$FILE"; then
      echo "$(basename "$0"): $FILE: formatted"
    else
      echo "$(basename "$0"): $FILE: failed to format" >&2
      FAILED=1
    fi
  done
  exit $FAILED
fi
