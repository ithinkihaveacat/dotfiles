#!/usr/bin/env bash

set -euo pipefail

usage() {
  cat <<EOF
Usage: $(basename "$0") [FILE]

Format a Kotlin file using ktfmt with kotlinlang style.

When FILE is provided, the file is formatted in place. When no FILE is
provided, reads from standard input and writes to standard output.

The ktfmt jar is automatically downloaded from GitHub on first use and
cached in \$XDG_DATA_HOME/ktfmt (or ~/.local/share/ktfmt).

Arguments:
  FILE        Path to a Kotlin file to format (optional)

Options:
  -h, --help  Display this help message and exit

Examples:

# Format a file in place

  $(basename "$0") Main.kt

# Format from stdin to stdout

  cat Main.kt | $(basename "$0")

# Format a file and see the result

  $(basename "$0") < src/Example.kt
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

if [[ $# -gt 1 ]]; then
  echo "$(basename "$0"): too many arguments" >&2
  exit 1
fi

if [[ $# -eq 0 && -t 0 ]]; then
  usage
fi

# Check for required commands

if ! command -v java >/dev/null 2>&1; then
  echo "$(basename "$0"): java not found" >&2
  exit 127
fi

if ! command -v curl >/dev/null 2>&1; then
  echo "$(basename "$0"): curl not found" >&2
  exit 127
fi

if ! command -v jq >/dev/null 2>&1; then
  echo "$(basename "$0"): jq not found" >&2
  exit 127
fi

KTFMT_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/ktfmt"

# Find existing jar or download latest
get_jar() {
  local jar
  jar=$(find "$KTFMT_DIR" -maxdepth 1 -name 'ktfmt-*-with-dependencies.jar' 2>/dev/null | head -n 1)

  if [[ -n "$jar" ]]; then
    echo "$jar"
    return 0
  fi

  # Download latest release
  echo "Downloading ktfmt..." >&2
  mkdir -p "$KTFMT_DIR"

  local url
  url=$(curl -fsSL https://api.github.com/repos/facebook/ktfmt/releases |
    jq -r '.[0].assets[] | select(.browser_download_url | endswith("with-dependencies.jar")) | .browser_download_url')

  if [[ -z "$url" ]]; then
    echo "$(basename "$0"): failed to find download URL" >&2
    return 1
  fi

  local filename
  filename=$(basename "$url")
  curl -fsSL "$url" -o "$KTFMT_DIR/$filename"
  echo "Downloaded $filename" >&2
  echo "$KTFMT_DIR/$filename"
}

jar=$(get_jar)

if [[ $# -eq 0 ]]; then

# Read from stdin, write to stdout

  java -jar "$jar" --kotlinlang-style -
else

# Format file in place

  if [[ ! -f "$1" ]]; then
    echo "$(basename "$0"): $1: No such file or directory" >&2
    exit 1
  fi
  if java -jar "$jar" --kotlinlang-style "$1"; then
    echo "$(basename "$0"): $1: formatted"
  else
    echo "$(basename "$0"): $1: failed to format" >&2
    exit 1
  fi
fi
