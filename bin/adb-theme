#!/usr/bin/env bash

# Bash 4.x check for associative arrays and case modification
if ((BASH_VERSINFO[0] < 4)); then
  echo "$(basename "$0"): requires bash 4.0 or higher (found ${BASH_VERSION})" >&2
  exit 1
fi

usage() {
  cat <<EOF
Usage: $(basename "$0") COMMAND [THEME]

Get or set the Android system theme customization via ADB.

Requirements:
  - Wear OS device
  - API Level 36+ (Android 16) recommended (warns if lower)

Commands:
  get         Get the current theme configuration (JSON)
  set THEME   Set the theme to one of the presets

Themes:
  indigo      Vibrant blue
  iris        Expressive purple
  ivy         Spritz dark green
  jade        Tonal spot green
  lemongrass  Expressive yellow-green
  moonstone   Spritz grey-blue
  peony       Vibrant pink
  porcelain   Spritz beige
  watchface   Dynamic colors from home wallpaper
  none        Static grey (reset)

Options:
  -h, --help  Display this help message and exit

Examples:
  $(basename "$0") get
  $(basename "$0") set lemongrass
  $(basename "$0") set none
EOF
  exit 0
}

# Dependencies
for cmd in adb jq; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "$(basename "$0"): $cmd not found, please install it." >&2
    exit 1
  fi
done

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

# Check device type (Wear OS required)
CHARACTERISTICS=$(adb exec-out getprop ro.build.characteristics 2>/dev/null | tr -d '\r')
if [[ "$CHARACTERISTICS" != *"watch"* ]]; then
  echo "$(basename "$0"): error: this script requires a Wear OS device (found: $CHARACTERISTICS)" >&2
  exit 1
fi

# Check API level (Warn if < 36)
API_LEVEL=$(adb exec-out getprop ro.build.version.sdk 2>/dev/null | tr -d '\r')
if [[ -n "$API_LEVEL" && "$API_LEVEL" -lt 36 ]]; then
  echo "$(basename "$0"): warning: API level $API_LEVEL detected. Themes may not work as expected (requires API 36+)." >&2
fi

COMMAND="${1:-}"
THEME_NAME="${2:-}"

# Define themes
declare -A THEMES
THEMES[indigo]='{"android.theme.customization.color_source":"preset","android.theme.customization.system_palette":"#6F9BFF","android.theme.customization.theme_style":"VIBRANT"}'
THEMES[iris]='{"android.theme.customization.color_source":"preset","android.theme.customization.system_palette":"#BAC3FF","android.theme.customization.theme_style":"EXPRESSIVE"}'
THEMES[ivy]='{"android.theme.customization.color_source":"preset","android.theme.customization.system_palette":"#404945","android.theme.customization.theme_style":"SPRITZ"}'
THEMES[jade]='{"android.theme.customization.color_source":"preset","android.theme.customization.system_palette":"#B6CF90","android.theme.customization.theme_style":"TONAL_SPOT"}'
THEMES[lemongrass]='{"android.theme.customization.color_source":"preset","android.theme.customization.system_palette":"#DDEB78","android.theme.customization.theme_style":"EXPRESSIVE"}'
THEMES[moonstone]='{"android.theme.customization.color_source":"preset","android.theme.customization.system_palette":"#9A9EAD","android.theme.customization.theme_style":"SPRITZ"}'
THEMES[none]='{"android.theme.customization.color_source":"static","android.theme.customization.system_palette":"#9A9EAD","android.theme.customization.theme_style":"SPRITZ"}'
THEMES[peony]='{"android.theme.customization.color_source":"preset","android.theme.customization.system_palette":"#FF6F7F","android.theme.customization.theme_style":"VIBRANT"}'
THEMES[porcelain]='{"android.theme.customization.color_source":"preset","android.theme.customization.system_palette":"#CFC6B4","android.theme.customization.theme_style":"SPRITZ"}'
THEMES[watchface]='{"android.theme.customization.color_source":"home_wallpaper","android.theme.customization.system_palette":"#9A9EAD","android.theme.customization.theme_style":"SPRITZ"}'

case "$COMMAND" in
  get)
    adb exec-out settings get secure theme_customization_overlay_packages | jq .
    ;;
  set)
    if [[ -z "$THEME_NAME" ]]; then
      echo "$(basename "$0") set: missing theme name" >&2
      echo "Available themes: ${!THEMES[*]}" >&2
      exit 1
    fi

    # Convert to lowercase
    KEY="${THEME_NAME,,}"

    if [[ -z "${THEMES[$KEY]:-}" ]]; then
      echo "$(basename "$0") set: unknown theme '$THEME_NAME'" >&2
      echo "Available themes: ${!THEMES[*]}" >&2
      exit 1
    fi

    JSON="${THEMES[$KEY]}"
    echo "Setting theme to '$KEY'..."
    adb exec-out settings put secure theme_customization_overlay_packages "$JSON"
    ;;
  *)
    if [[ -z "$COMMAND" ]]; then
        usage
    else
        echo "$(basename "$0"): unknown command '$COMMAND'" >&2
        exit 1
    fi
    ;;
esac
