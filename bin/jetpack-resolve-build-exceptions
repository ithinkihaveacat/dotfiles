#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") LIBRARY_COORDINATE

Helper script to analyze a Jetpack library and suggest exceptions for jetpack-resolve.

Arguments:
  LIBRARY_COORDINATE  Maven coordinate (e.g., androidx.wear:wear)

Examples:
  $(basename "$0") androidx.wear:wear
  $(basename "$0") androidx.glance.wear:wear-core

This script downloads the source JAR for a library from the AndroidX SNAPSHOT repository,
examines the package structure, and suggests exception entries for packages that don't
follow the standard naming pattern. The output can be added to the EXCEPTIONS array in
the jetpack-resolve script.

NOTE: This script ONLY supports SNAPSHOT versions from https://androidx.dev/snapshots/latest/artifacts/repository
This is because we typically need to find exceptions for new APIs that are not yet stable.
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

set -e

if [ "$#" -lt 1 ]; then
  usage
fi

require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "$(basename "$0"): required command '$1' not found" >&2
    exit 127
  }
}

require curl
require jar

# Find jetpack-resolve script (should be in same directory as this script)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
JETPACK_RESOLVE="$SCRIPT_DIR/jetpack-resolve"

if [ ! -x "$JETPACK_RESOLVE" ]; then
  # Try PATH as fallback
  if command -v jetpack-resolve >/dev/null 2>&1; then
    JETPACK_RESOLVE="jetpack-resolve"
  else
    echo "$(basename "$0"): jetpack-resolve script not found" >&2
    exit 127
  fi
fi

LIBRARY=$1

# Validate library format
if [[ ! "$LIBRARY" =~ ^[^:]+:[^:]+$ ]]; then
  echo "$(basename "$0"): invalid library format '$LIBRARY' (expected GROUP_ID:ARTIFACT_ID)" >&2
  exit 1
fi

GROUP_ID=$(echo "$LIBRARY" | cut -d: -f1)
ARTIFACT_ID=$(echo "$LIBRARY" | cut -d: -f2)

# Always use snapshot repo
REPO_URL="https://androidx.dev/snapshots/latest/artifacts/repository"

# Get the latest snapshot version
GROUP_ID_PATH=$(echo "$GROUP_ID" | sed 's/\./\//g')
METADATA_URL="$REPO_URL/$GROUP_ID_PATH/$ARTIFACT_ID/maven-metadata.xml"

# Check if the library exists
if ! curl -sSLf "$METADATA_URL" >/dev/null 2>&1; then
  echo "$(basename "$0"): failed to fetch $METADATA_URL" >&2
  exit 1
fi

VERSION=$(curl -sSLf "$METADATA_URL" 2>/dev/null |
  sed -n 's/.*<latest>\(.*\)<\/latest>.*/\1/p' |
  head -1)

if [ -z "$VERSION" ]; then
  echo "$(basename "$0"): no version found at $METADATA_URL" >&2
  exit 1
fi

# Resolve timestamped JAR version for SNAPSHOTs
JAR_VERSION="$VERSION"
VERSION_METADATA_URL="$REPO_URL/$GROUP_ID_PATH/$ARTIFACT_ID/$VERSION/maven-metadata.xml"

# Try to use xmllint if available, otherwise fallback to grep/sed hacks
if command -v xmllint >/dev/null 2>&1; then
  SNAPSHOT_JAR_VERSION=$(curl -sSLf "$VERSION_METADATA_URL" 2>/dev/null |
    xmllint --xpath "//snapshotVersion[classifier='sources' and extension='jar']/value/text()" - 2>/dev/null || true)
else
  # Fallback for systems without xmllint (approximate)
  SNAPSHOT_JAR_VERSION=$(curl -sSLf "$VERSION_METADATA_URL" 2>/dev/null |
    grep -A 5 "<classifier>sources</classifier>" | grep "<value>" | head -1 | sed 's/.*<value>\(.*\)<\/value>.*/\1/')
fi

if [ -n "$SNAPSHOT_JAR_VERSION" ]; then
  JAR_VERSION="$SNAPSHOT_JAR_VERSION"
else
  echo "$(basename "$0"): warning: could not resolve timestamped version for snapshot, using $VERSION" >&2
fi

# Download source JAR to temp directory
TMPDIR=$(mktemp -d)
trap 'rm -rf "$TMPDIR"' EXIT

SOURCE_JAR_URL="$REPO_URL/$GROUP_ID_PATH/$ARTIFACT_ID/$VERSION/$ARTIFACT_ID-$JAR_VERSION-sources.jar"
SOURCE_JAR="$TMPDIR/sources.jar"

if ! curl -sSLf -o "$SOURCE_JAR" "$SOURCE_JAR_URL" 2>/dev/null; then
  echo "$(basename "$0"): failed to download $SOURCE_JAR_URL" >&2
  exit 1
fi

# Extract and find all packages
cd "$TMPDIR"
jar xf sources.jar 2>/dev/null || true

# Find all unique packages from source files
PACKAGES=$(find . -type f \( -name "*.java" -o -name "*.kt" \) 2>/dev/null | while read -r file; do
  grep -m1 "^package " "$file" 2>/dev/null | sed 's/package //;s/;.*//;s/ .*//'
done | sort -u)

if [ -z "$PACKAGES" ]; then
  echo "$(basename "$0"): no packages found in $SOURCE_JAR_URL" >&2
  exit 1
fi

while IFS= read -r pkg; do
  if [ -z "$pkg" ]; then
    continue
  fi

  # Test with a fake class name
  RESULT=$("$JETPACK_RESOLVE" "$pkg.TestClass" 2>/dev/null || echo "ERROR")

  # Check if result matches expected library
  if [ "$RESULT" != "$GROUP_ID:$ARTIFACT_ID" ]; then
    echo "  \"$pkg|$GROUP_ID:$ARTIFACT_ID\""
  fi
done <<<"$PACKAGES"
