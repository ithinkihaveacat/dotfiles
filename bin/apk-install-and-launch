#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] APK_FILE

Installs and launches an Android application from an APK or ZIP archive.

The script can handle single APK files or ZIP archives containing split APKs.
It automatically determines the package name and main launchable activity.

Arguments:
  APK_FILE    Path to the APK or ZIP file to install.

Options:
  -f          Force uninstall the application before installing.
  -h, --help  Display this help message and exit

Examples:
  # Install and launch a standard APK
  $(basename "$0") my-app.apk

  # Uninstall the existing version, then install and launch a split APK from a ZIP
  $(basename "$0") -f my-app.zip

If this script breaks, it's probably because apkanalyzer doesn't
work. See if running "apkanalyzer" by itself emits its help page, or
an error. If an error, you probably want to check that JAVA_HOME is
set to the right version of java.
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

shopt -s nullglob
set -e

require() { hash "$@" || exit 127; }

require adb
require apkanalyzer
require xpath
require unzip

UNINSTALL=false
while getopts "f" opt; do
  case $opt in
    f)
      UNINSTALL=true
      ;;
    \?)
      exit 1
      ;;
  esac
done
shift $((OPTIND-1))

if [ -z "$1" ]; then
  echo "$(basename "$0"): missing file operand" >&2
  exit 1
fi

if [ ! -f "$1" ]; then
  echo "$(basename "$0"): $1: No such file or directory" >&2
  exit 1
fi

if [[ $1 == *.zip ]]; then
  TMPDIR=$(mktemp -d)
  trap 'rm -rf -- "$TMPDIR"' EXIT
  unzip -q "$1" -d "$TMPDIR"
  BASEAPKS=("$TMPDIR"/*-base-split.apk)
  BASEAPK="${BASEAPKS[0]}"
  if [ ! -f "$BASEAPK" ]; then
    echo "$(basename "$0"): *-base-split.apk not found in zip, aborting" >&2
    exit 1
  fi
  APKS=("$TMPDIR"/*.apk)
else
  BASEAPK="$1"
fi

PACKAGE=$(apkanalyzer manifest application-id "$BASEAPK")
ACTIVITY=$(apkanalyzer manifest print "$BASEAPK" | xpath -n -q -e "string(//activity[intent-filter/action[@android:name='android.intent.action.MAIN'] and intent-filter/category[@android:name='android.intent.category.LAUNCHER']]/@android:name)")

if [ "$UNINSTALL" = "true" ]; then
  adb uninstall "$PACKAGE" || true
fi

if [[ $1 == *.zip ]]; then
  adb install-multiple -g -t -r "${APKS[@]}"
else # assume regular APK
  adb install -g -t -r "$1"
fi

adb exec-out am start -n "$PACKAGE/$ACTIVITY" -a android.intent.action.MAIN -c android.intent.category.LAUNCHER
