#!/usr/bin/env bash

export ANDROID_HOME="$HOME/.local/share/android-sdk"
# To find valid versions for build-tools, run:
# sdkmanager --list | grep "build-tools;"
export ANDROID_BUILD_TOOLS_VERSION="36.0.0"
# To find valid versions for platforms, run:
# sdkmanager --list | grep "platforms;android-"
export ANDROID_PLATFORM_VERSION="android-36"


usage() {
  cat <<EOF
Usage: $(basename "$0") [COMMAND]

A script to set up and manage the Android SDK, emulator, and system images.

Commands:
  init                Install all necessary components and create a default Wear OS AVD.
  list                List all available AVDs.
  create <name>       Create a new Wear OS AVD with the specified name.
  start <name>        Start the specified AVD.
  stop <name>         Stop the specified AVD.
  delete <name>       Delete the specified AVD.

Options:
  -h, --help          Display this help message and exit

Examples:
  # One-command setup for the emulator
  $(basename "$0") init

  # List available AVDs
  $(basename "$0") list

  # Start a specific AVD
  $(basename "$0") start wearos_avd
EOF
  exit 0
}

require() {
  for cmd in "$@"; do
    if ! command -v "$cmd" &>/dev/null; then
      # If the command is in our SDK, let's try to find it there
      if [[ -f "$ANDROID_HOME/cmdline-tools/latest/bin/$cmd" || -f "$ANDROID_HOME/emulator/$cmd" || -f "$ANDROID_HOME/platform-tools/$cmd" ]]; then
        continue
      fi
      echo "$(basename "$0"): '$cmd' command not found" >&2
      exit 127
    fi
  done
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

if [[ -z "$1" ]]; then
  usage
fi

install_cli_tools() {
  require curl mktemp unzip uname grep head sed rm mkdir mv

  # Check if Android SDK cmdline-tools directory already exists
  if [[ -d "$ANDROID_HOME/cmdline-tools" ]]; then
    echo "Android SDK command-line tools already installed."
    return 0
  fi

  local temp_dir
  temp_dir=$(mktemp -d)
  trap 'rm -rf -- "$temp_dir"' EXIT

  local os
  case "$(uname -s)" in
    Darwin)
      os="mac"
      ;;
    Linux)
      os="linux"
      ;;
    *)
      echo "$(basename "$0"): Unsupported OS: $(uname -s)" >&2
      exit 1
      ;;
  esac

  local repository_xml
  repository_xml=$(curl -s https://dl.google.com/android/repository/repository2-1.xml)

  local latest_zip
  latest_zip=$(echo "${repository_xml}" | grep "commandlinetools-${os}" | head -n 1 | sed -e 's/.*>\(.*\).zip<\/url>.*/\1.zip/')

  if [[ -z "${latest_zip}" ]]; then
    echo "$(basename "$0"): Could not find latest commandlinetools for ${os}" >&2
    exit 1
  fi

  local download_url
  download_url="https://dl.google.com/android/repository/${latest_zip}"
  echo "Downloading ${download_url}..."
  curl -L "${download_url}" -o "${temp_dir}/commandlinetools.zip"

  echo "Unzipping to ${temp_dir}..."
  unzip -q "${temp_dir}/commandlinetools.zip" -d "${temp_dir}"

  # Per https://developer.android.com/tools/sdkmanager
  local install_dir="$ANDROID_HOME/cmdline-tools/latest"
  echo "Creating installation directory ${install_dir}..."
  rm -rf "$ANDROID_HOME/cmdline-tools"
  mkdir -p "${install_dir}"

  echo "Moving cmdline-tools contents to ${install_dir}..."
  mv "${temp_dir}/cmdline-tools/"* "${install_dir}/"
}

install_emulator() {
  if [[ -f "$ANDROID_HOME/emulator/emulator" ]]; then
    echo "Android emulator already installed."
    return 0
  fi

  require yes

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run --install-cli-tools first." >&2
    exit 1
  fi

  echo "Installing emulator..."
  yes | "${sdkmanager}" --licenses > /dev/null
  "${sdkmanager}" --install "emulator"
}

install_wearos_image() {
  require uname awk grep tail yes

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run --install-cli-tools first." >&2
    exit 1
  fi

  echo "Finding latest Wear OS image..."

  local arch
  case "$(uname -m)" in
    arm64 | aarch64)
      arch="arm64-v8a"
      ;;
    x86_64)
      arch="x86_64"
      ;;
    *)
      echo "$(basename "$0"): Unsupported architecture: $(uname -m)" >&2
      exit 1
      ;;
  esac

  local wearos_image_package="system-images;${ANDROID_PLATFORM_VERSION};android-wear-signed;${arch}"
  local installed_packages
  installed_packages=$("${sdkmanager}" --list_installed)

  if echo "${installed_packages}" | grep -q "${wearos_image_package}"; then
    echo "Wear OS system image '${wearos_image_package}' already installed."
    return 0
  fi

  local wearos_image
  wearos_image=$("${sdkmanager}" --list --channel=3 | grep "${wearos_image_package}" | tail -n 1 | awk '{print $1}')

  if [[ -z "${wearos_image}" ]]; then
    echo "$(basename "$0"): Could not find latest Wear OS image" >&2
    exit 1
  fi

  echo "Installing ${wearos_image}..."
  yes | "${sdkmanager}" --licenses > /dev/null
  "${sdkmanager}" --install "${wearos_image}"
}

install_platform_tools() {
  if [[ -d "$ANDROID_HOME/platform-tools" ]]; then
    echo "Android SDK platform-tools already installed."
    return 0
  fi

  require yes

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run --install-cli-tools first." >&2
    exit 1
  fi

  echo "Installing platform-tools..."
  yes | "${sdkmanager}" --licenses > /dev/null
  "${sdkmanager}" --install "platform-tools"
}

install_build_tools() {
  if [[ -d "$ANDROID_HOME/build-tools/$ANDROID_BUILD_TOOLS_VERSION" ]]; then
    echo "Android SDK build-tools version $ANDROID_BUILD_TOOLS_VERSION already installed."
    return 0
  fi

  require yes

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run --install-cli-tools first." >&2
    exit 1
  fi

  echo "Installing build-tools..."
  yes | "${sdkmanager}" --licenses > /dev/null
  "${sdkmanager}" --install "build-tools;${ANDROID_BUILD_TOOLS_VERSION}"
}

install_platforms() {
  if [[ -d "$ANDROID_HOME/platforms/$ANDROID_PLATFORM_VERSION" ]]; then
    echo "Android SDK platform $ANDROID_PLATFORM_VERSION already installed."
    return 0
  fi

  require yes

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run --install-cli-tools first." >&2
    exit 1
  fi

  echo "Installing platforms;${ANDROID_PLATFORM_VERSION}..."
  yes | "${sdkmanager}" --licenses > /dev/null
  "${sdkmanager}" --install "platforms;${ANDROID_PLATFORM_VERSION}"
}

create_avd() {
  require uname awk grep tail yes avdmanager

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run --install-cli-tools first." >&2
    exit 1
  fi

  local avdmanager="$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager"
  if [[ ! -f "$avdmanager" ]]; then
    echo "$(basename "$0"): avdmanager not found. Please run --install-cli-tools first." >&2
    exit 1
  fi

  if "${avdmanager}" list avd | grep -q "Name: $1"; then
    echo "AVD '$1' already exists."
    return 0
  fi

  echo "Finding latest Wear OS image..."

  local arch
  case "$(uname -m)" in
    arm64 | aarch64)
      arch="arm64-v8a"
      ;;
    x86_64)
      arch="x86_64"
      ;;
    *)
      echo "$(basename "$0"): Unsupported architecture: $(uname -m)" >&2
      exit 1
      ;;
  esac

  local wearos_image
  wearos_image=$("${sdkmanager}" --list --channel=3 | grep "system-images;.*android-wear.*${arch}" | tail -n 1 | awk '{print $1}')

  if [[ -z "${wearos_image}" ]]; then
    echo "$(basename "$0"): Could not find latest Wear OS image" >&2
    exit 1
  fi

  echo "Creating AVD '$1' with image '${wearos_image}'..."
  echo "no" | "${avdmanager}" create avd -n "$1" -k "${wearos_image}" -d "wearos_large_round"
}

start_avd() {
  require emulator adb

  local emulator_path="$ANDROID_HOME/emulator/emulator"
  if [[ ! -f "${emulator_path}" ]]; then
    echo "$(basename "$0"): emulator not found. Please run --install-emulator first." >&2
    exit 1
  fi

  # Check for platform-tools
  if [[ ! -d "$ANDROID_HOME/platform-tools" ]]; then
    echo "$(basename "$0"): platform-tools not found. Please run --install-platform-tools first." >&2
    exit 1
  fi

  local adb_path="$ANDROID_HOME/platform-tools/adb"
  if [[ ! -f "${adb_path}" ]]; then
    echo "$(basename "$0"): adb not found. Please run --install-platform-tools first." >&2
    exit 1
  fi

  echo "Starting AVD '$1'..."
  nohup "${emulator_path}" -avd "$1" -no-snapshot-load &> /dev/null &

  echo "Waiting for device to connect..."
  "${adb_path}" wait-for-device
  echo "Device connected."
  "${adb_path}" devices -l
}

stop_avd() {
  require adb grep awk tr

  local avd_name_to_stop="$1"
  local adb_path="$ANDROID_HOME/platform-tools/adb"

  echo "Attempting to stop AVD '$avd_name_to_stop'..."

  # Get serial numbers of all online emulator devices
  local device_serials
  device_serials=$("${adb_path}" devices | grep "emulator-" | awk '{print $1}')

  if [[ -z "$device_serials" ]]; then
    echo "No running emulators found."
    return 0
  fi

  local found_avd=false
  for serial in $device_serials; do
    # Get the AVD name for the current device and trim whitespace/carriage returns
    local running_avd_name
    running_avd_name=$("${adb_path}" -s "$serial" shell getprop ro.boot.qemu.avd_name | tr -d '[:space:]')

    if [[ "$running_avd_name" == "$avd_name_to_stop" ]]; then
      echo "Found running AVD '$avd_name_to_stop' on device '$serial'. Stopping it..."
      "${adb_path}" -s "$serial" emu kill
      echo "AVD '$avd_name_to_stop' stopped."
      found_avd=true
      break # Stop after finding and killing the first match
    fi
  done

  if [[ "$found_avd" == false ]]; then
    echo "AVD '$avd_name_to_stop' is not currently running."
  fi
}

delete_avd() {
  require avdmanager
  local avdmanager_path="$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager"
  echo "Deleting AVD '$1'..."
  "${avdmanager_path}" delete avd -n "$1"
}

list_avds() {
  require emulator
  local emulator_path="$ANDROID_HOME/emulator/emulator"
  "${emulator_path}" -list-avds
}

init_emulator() {
  install_cli_tools
  install_platform_tools
  install_build_tools
  install_platforms
  install_emulator
  install_wearos_image
  create_avd "wearos_avd"
}

case "$1" in
  init)
    init_emulator
    ;;
  list)
    list_avds
    ;;
  create)
    if [[ -z "$2" ]]; then echo "Usage: $(basename "$0") create <name>" >&2; exit 1; fi
    create_avd "$2"
    ;;
  start)
    if [[ -z "$2" ]]; then echo "Usage: $(basename "$0") start <name>" >&2; exit 1; fi
    start_avd "$2"
    ;;
  stop)
    if [[ -z "$2" ]]; then echo "Usage: $(basename "$0") stop <name>" >&2; exit 1; fi
    stop_avd "$2"
    ;;
  delete)
    if [[ -z "$2" ]]; then echo "Usage: $(basename "$0") delete <name>" >&2; exit 1; fi
    delete_avd "$2"
    ;;
  *)
    echo "$(basename "$0"): unknown command '$1'" >&2
    usage
    exit 1
    ;;
esac