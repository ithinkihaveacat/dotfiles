#!/bin/bash

# Check if Android SDK directory already exists
if [[ -d "$HOME/.local/share/android-sdk" ]]; then
  echo "Error: $HOME/.local/share/android-sdk already exists. Please remove it manually before running this script." >&2
  exit 1
fi

# The initial version of this script will have an --install function that
# downloads and installs the android emulator. It needs to support linux and
# macos only.

# Step 1: Download the correct package.
# This function downloads the emulator image. It will need to first download the
# URL https://dl.google.com/android/repository/repository2-1.xml contains
# links to the latest versions of various tools, including the android sdk
# command line tools. Download it, inspect it, and write an xpath query to
# extract the version appropriate to the operating system (for linux, it's
# currently commandlinetools-linux-13114758_latest.zip; macos is
# commandlinetools-mac-13114758_latest.zip). Assume the general shape" of the
# xml file will stay the same, and guess at the right query that continue to
# return the appropriate file as the exact filename changes. Prepend
# https://dl.google.com/android/repository/ to the filename to construct the
# full download URL.

install_command_line_tools() {
  local temp_dir
  temp_dir=$(mktemp -d)
  trap 'rm -rf -- "$temp_dir"' EXIT

  local os
  case "$(uname -s)" in
    Darwin)
      os="mac"
      ;;
    Linux)
      os="linux"
      ;;
    *)
      echo "Unsupported OS: $(uname -s)" >&2
      exit 1
      ;;
  esac

  local repository_xml
  repository_xml=$(curl -s https://dl.google.com/android/repository/repository2-1.xml)

  local latest_zip
  latest_zip=$(echo "${repository_xml}" | grep "commandlinetools-${os}" | head -n 1 | sed -e 's/.*>\(.*\).zip<\/url>.*/\1.zip/')

  if [[ -z "${latest_zip}" ]]; then
    echo "Could not find latest commandlinetools for ${os}" >&2
    exit 1
  fi

  local download_url
  download_url=$(echo "https://dl.google.com/android/repository/${latest_zip}")
  echo "Downloading ${download_url}..."
  curl -L "${download_url}" -o "${temp_dir}/commandlinetools.zip"

  echo "Unzipping to ${temp_dir}..."
  unzip -q "${temp_dir}/commandlinetools.zip" -d "${temp_dir}"

  # Per https://developer.android.com/tools/sdkmanager
  local install_dir="$HOME/.local/share/android-sdk/cmdline-tools/latest"
  echo "Creating installation directory ${install_dir}..."
  rm -rf "$HOME/.local/share/android-sdk/cmdline-tools"
  mkdir -p "${install_dir}"

  echo "Moving cmdline-tools contents to ${install_dir}..."
  mv "${temp_dir}/cmdline-tools/"* "${install_dir}/"
}
if [[ "$1" == "--install" ]]; then
  install_command_line_tools
fi
