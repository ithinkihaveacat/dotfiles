#!/bin/bash
#
# Downloads and extracts the source code for one or more Jetpack packages.
#

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] PACKAGE... VERSION [REPO_URL]

Download and extract source code for one or more Jetpack packages.

Arguments:
  PACKAGE     One or more package names in the format GROUP_ID:ARTIFACT_ID
              (supports brace expansion, e.g., androidx.pkg:{foo,bar})
  VERSION     Version string: STABLE, LATEST, or a specific version number
  REPO_URL    Maven repository URL (optional, default: https://dl.google.com/android/maven2)

Options:
  -h, --help  Display this help message and exit
  --output DIR  Specify output directory (default: create temporary directory)

Examples:
  $(basename "$0") androidx.wear.tiles:tiles STABLE
  $(basename "$0") androidx.wear.protolayout:protolayout-{expression,material,material3} STABLE
  $(basename "$0") com.google.android.horologist:horologist-datalayer STABLE https://repo1.maven.org/maven2
  $(basename "$0") --output /tmp/wear-tiles androidx.wear.tiles:tiles STABLE
  pushd "\$($(basename "$0") androidx.wear.tiles:tiles STABLE)"

The script creates a temporary directory, downloads the source JARs for the specified
packages, extracts them, and prints the path to the temporary directory.
EOF
  exit 0
}

set -e

OUTPUT_DIR=""
REMAINING_ARGS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      usage
      ;;
    --output)
      if [ -z "$2" ]; then
        echo "$(basename "$0"): option '--output' requires an argument" >&2
        exit 1
      fi
      OUTPUT_DIR="$2"
      shift 2
      ;;
    *)
      REMAINING_ARGS+=("$1")
      shift
      ;;
  esac
done
set -- "${REMAINING_ARGS[@]}" # Overwrite the original positional arguments

if [ "$#" -lt 2 ]; then
  echo "$(basename "$0"): missing operand" >&2
  exit 1
fi

if [ "$#" -lt 2 ]; then
  echo "$(basename "$0"): missing operand" >&2
  exit 1
fi

require() {
    hash "$@" || { echo "Error: Command '$1' not found." >&2; exit 127; }
}

require curl
require jar
require jetpack-version-stable
require jetpack-version-latest
if [[ "${!#}" =~ ^https?:// ]]; then
  REPO_URL="${!#}"
  VERSION_STRING="${@: -2:1}"
  PACKAGES=("${@:1:$#-2}")
else
  REPO_URL="https://dl.google.com/android/maven2"
  VERSION_STRING="${!#}"
  PACKAGES=("${@:1:$#-1}")
fi

VERSION_STRING_UPPER=$(echo "$VERSION_STRING" | tr '[:lower:]' '[:upper:]')

# Create output directory
if [ -n "$OUTPUT_DIR" ]; then
  BUILD_DIR="$OUTPUT_DIR"
  mkdir -p "$BUILD_DIR"
else
  BUILD_DIR=$(mktemp -d)
fi

# Download and extract each package
for PACKAGE_NAME in "${PACKAGES[@]}"; do
  GROUP_ID=$(echo "$PACKAGE_NAME" | cut -d: -f1)
  ARTIFACT_ID=$(echo "$PACKAGE_NAME" | cut -d: -f2)

  # Resolve version (use the first package to resolve STABLE/LATEST)
  if [ -z "$VERSION" ]; then
    if [ "$VERSION_STRING_UPPER" == "STABLE" ]; then
      VERSION=$(jetpack-version-stable "${PACKAGE_NAME}" "$REPO_URL")
      echo "info: Resolved STABLE version for ${PACKAGE_NAME} to ${VERSION}" >&2
    elif [ "$VERSION_STRING_UPPER" == "LATEST" ]; then
      VERSION=$(jetpack-version-latest "${PACKAGE_NAME}" "$REPO_URL")
      echo "info: Resolved LATEST version for ${PACKAGE_NAME} to ${VERSION}" >&2
    else
      VERSION=$VERSION_STRING
    fi
  fi

  GROUP_ID_PATH=$(echo "$GROUP_ID" | sed 's/\./\//g')
  SOURCE_JAR_URL="${REPO_URL}/${GROUP_ID_PATH}/${ARTIFACT_ID}/${VERSION}/${ARTIFACT_ID}-${VERSION}-sources.jar"
  SOURCE_JAR_FILENAME="${ARTIFACT_ID}-${VERSION}-sources.jar"

  echo "info: Downloading ${PACKAGE_NAME} version ${VERSION}" >&2
  curl -sSL -o "${BUILD_DIR}/${SOURCE_JAR_FILENAME}" "${SOURCE_JAR_URL}"

  (
    cd "${BUILD_DIR}"
    jar xf "${SOURCE_JAR_FILENAME}"
    rm "${SOURCE_JAR_FILENAME}"
  )
done

# Clean up META-INF after all extractions
rm -rf "${BUILD_DIR}/META-INF"

echo "${BUILD_DIR}"
