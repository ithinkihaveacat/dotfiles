#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0")

Generate a combined repomix output of Raspberry Pi documentation.

This script downloads and combines all AsciiDoc files from the raspberrypi/documentation
GitHub repository, ignoring certain directories like accessories, camera, and compute-module.

Options:
  -h, --help  Display this help message and exit

Examples:
  $(basename "$0")
    Generate combined documentation to stdout

  $(basename "$0") > rpi-context.txt
    Save combined documentation to a file

  $(basename "$0") | pbcopy
    Copy combined documentation to clipboard (macOS)
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

set -e

BUILD_DIR=$(mktemp -d)
trap 'rm -rf "$BUILD_DIR"' EXIT

require() {
  hash "$@" || {
    echo "Error: Command '$1' not found." >&2
    exit 127
  }
}

require curl
require unzip
require repomix

URL="https://github.com/raspberrypi/documentation/archive/refs/heads/master.zip"
ZIP_FILE="$BUILD_DIR/master.zip"
EXTRACT_DIR="$BUILD_DIR"
DOCS_DIR="$EXTRACT_DIR/documentation-master"

curl -fsSL -o "$ZIP_FILE" "$URL"
unzip -o -q "$ZIP_FILE" "documentation-master/**/*.adoc" -d "$EXTRACT_DIR"
repomix "$DOCS_DIR" \
  --include="**/*.adoc" \
  --ignore="**/accessories/**,**/accessibility.adoc,**/ai/**,**/camera/**,**/compute-module/**,**/display-parallel-interface.adoc,**/gpio-pad-controls.adoc,**/graphics-utilities.adoc,**/keyboard-computers/**,**/legacy_config_txt/**,**/linux_kernel/**,**/microcontrollers/**,**/playing-audio-and-video.adoc,**/processors/**,**/services/**,**/spi-bus-on-raspberry-pi.adoc,**/vnc.adoc" \
  --no-security-check --quiet -o -
