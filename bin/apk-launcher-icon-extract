#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") APK_FILE

Extracts the launcher icon and round launcher icon from an APK.

The script decodes the APK, finds the icon resources referenced in the
AndroidManifest.xml, and saves them to the current directory. It handles
both vector drawables (XML) and raster images (PNG) and picks the highest
density version available.

Arguments:
  APK_FILE    Path to an APK file or a ZIP archive containing a base split APK.

Options:
  -h, --help  Display this help message and exit

Examples:
  # Extract launcher icons from a standalone APK
  $(basename "$0") /path/to/your/app.apk

  # Extract launcher icons from a ZIP archive
  $(basename "$0") /path/to/your/app.zip
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

shopt -s nullglob

require() { hash "$@" || exit 127; }

require unzip
require apktool
require xmllint
require xpath

if [ -z "$1" ]; then
  echo "$(basename "$0"): missing file operand" >&2
  exit 1
fi

function match_vector() {
  GLOB="$1"
  GLOB="${GLOB/@/res\/}"
  GLOB="${GLOB/mipmap/mipmap*}"
  GLOB="${GLOB}*.xml"
  # shellcheck disable=SC2206
  MATCHES=($2/$GLOB)
  echo "${MATCHES[0]}"
}

function match_raster() {
  densities=(xxxhdpi xxhdpi xhdpi hdpi mdpi)
  if [[ $1 =~ ^@drawable ]]; then
    for d in "${densities[@]}"; do
      GLOB="$1"
      GLOB="${GLOB/@/res\/}"
      GLOB="${GLOB/drawable/drawable-*}" # More specific glob
      GLOB="${GLOB}.png"
      # shellcheck disable=SC2206
      MATCHES=($2/$GLOB)
      if [ ${#MATCHES[@]} -gt 0 ]; then
        echo "${MATCHES[0]}"
        return
      fi
    done
  elif [[ $1 =~ ^@mipmap ]]; then
    for d in "${densities[@]}"; do
      GLOB="$1"
      GLOB="${GLOB/@/res\/}"
      GLOB="${GLOB/mipmap/mipmap-${d}*}"
      GLOB="${GLOB}*.png"
      # shellcheck disable=SC2206
      MATCHES=($2/$GLOB)
      if [ ${#MATCHES[@]} -gt 0 ]; then
        echo "${MATCHES[0]}"
        return
      fi
    done
  fi
}

function extract_resource() {
  DIR="$1"
  REFERENCE="$2"
  PREFIX="$3"

  VECTOR_ICON=$(match_vector "$REFERENCE" "$DIR")
  RASTER_ICON=$(match_raster "$REFERENCE" "$DIR")

  if [ -n "$VECTOR_ICON" ]; then
    FILENAME="$PREFIX.xml"
    xmllint --format "$VECTOR_ICON" > "$FILENAME"
    echo "Saved $FILENAME ($REFERENCE resolved to $VECTOR_ICON)"
  elif [ -n "$RASTER_ICON" ]; then
    FILENAME="$PREFIX.png"
    cp "$RASTER_ICON" "$FILENAME"
    echo "Saved $FILENAME ($REFERENCE resolved to $RASTER_ICON)"
  fi
}

if [[ $1 == *.zip ]]; then
  TMPDIR=$(mktemp -d)
  trap 'rm -rf -- "$TMPDIR"' EXIT
  unzip -q "$1" -d "$TMPDIR"
  BASEAPK=$(directory-base-split "$TMPDIR")
  if [ ! -f "$BASEAPK" ]; then
    echo "$(basename "$0"): *_base_split.apk not found in zip, aborting" >&2
    exit 1
  fi
else
  BASEAPK="$1"
fi

DECODED_TMPDIR=$(mktemp -d)
trap 'rm -rf -- "$DECODED_TMPDIR"' EXIT
apktool d "$BASEAPK" -f -s -o "$DECODED_TMPDIR" > /dev/null 2>&1

MANIFEST_PATH="$DECODED_TMPDIR/AndroidManifest.xml"

extract_resource \
  "$DECODED_TMPDIR" \
  "$(xpath -n -q -e 'string(/manifest/application/@android:icon)' < "$MANIFEST_PATH")" \
  "$(basename "$1" .zip)-launcher-icon"

if [[ -n "$(xpath -n -q -e 'string(/manifest/application/@android:roundIcon)' < "$MANIFEST_PATH")" ]]; then
  extract_resource \
    "$DECODED_TMPDIR" \
    "$(xpath -n -q -e 'string(/manifest/application/@android:roundIcon)' < "$MANIFEST_PATH")" \
    "$(basename "$1" .zip)-launcher-icon-round"
fi
