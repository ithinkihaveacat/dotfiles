#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] APK_FILE

Decodes an APK file using apktool and outputs the directory path.

This script uses 'apktool d' to decode the APK's resources.
The path to the output directory is printed to standard output.

Arguments:
  APK_FILE          Path to an APK file.

Options:
  -o, --output DIR  The directory to decode the APK into.
                    (defaults to a new temporary directory)
  -h, --help        Display this help message and exit

Examples:
  # Decode an APK into a new temporary directory
  DECODED_PATH=$($(basename "$0") /path/to/your/app.apk)
  ls "\$DECODED_PATH"

  # Decode an APK into a specific directory
  $(basename "$0") --output /tmp/decoded-apk /path/to/your/app.apk
EOF
  exit 0
}

OUTPUT_DIR=""

# Manual parsing for --output, compatible with macOS getopt
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h | --help)
      usage
      ;;
    -o | --output)
      if [ -z "$2" ]; then
        echo "$(basename "$0"): --output option requires an argument" >&2
        exit 1
      fi
      OUTPUT_DIR="$2"
      shift 2
      ;;
    *)
      break # First non-option argument is the APK_FILE
      ;;
  esac
done

require() { hash "$@" || exit 127; }

require apktool

if [ -z "$1" ]; then
  echo "$(basename "$0"): missing file operand" >&2
  exit 1
fi

APK_FILE="$1"

if [ -z "$OUTPUT_DIR" ]; then
  OUTPUT_DIR=$(mktemp -d)
else
  mkdir -p "$OUTPUT_DIR"
fi

# -s to skip source (resources only)
apktool d "$APK_FILE" -f -o "$OUTPUT_DIR" >/dev/null 2>&1

echo "$OUTPUT_DIR"
