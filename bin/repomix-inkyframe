#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0")

Generate a combined repomix output of Pimoroni Inky Frame documentation.

This script downloads and combines documentation from multiple sources:
  - Pimoroni Inky Frame GitHub repo (docs, examples, modules)
  - Pimoroni Pico GitHub repo (picographics module)
  - MicroPython mpremote documentation
  - Pimoroni "Getting Started with Inky Frame" article

Options:
  -h, --help  Display this help message and exit

Examples:
  $(basename "$0")
    Generate combined documentation to stdout

  $(basename "$0") > inky-frame-context.txt
    Save combined documentation to a file

  $(basename "$0") | pbcopy
    Copy combined documentation to clipboard (macOS)
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

set -e

# Create a temporary directory for all build artifacts
BUILD_DIR=$(mktemp -d)

# Ensure the temporary directory is cleaned up on exit
trap 'rm -rf "$BUILD_DIR"' EXIT

# Inky Frame repo
URL_INKY="https://github.com/pimoroni/inky-frame/archive/refs/heads/main.zip"
ZIP_FILE_INKY="$BUILD_DIR/inky-frame.zip"
EXTRACT_DIR_INKY="$BUILD_DIR/inky-frame-extracted"
DOCS_DIR_INKY="$EXTRACT_DIR_INKY/inky-frame-main"

# Pimoroni Pico repo
URL_PICO="https://github.com/pimoroni/pimoroni-pico/archive/refs/heads/main.zip"
ZIP_FILE_PICO="$BUILD_DIR/pico.zip"
EXTRACT_DIR_PICO="$BUILD_DIR/pico-extracted"
DOCS_DIR_PICO="$EXTRACT_DIR_PICO/pimoroni-pico-main"

# mpremote documentation
URL_MPREMOTE="https://docs.micropython.org/en/latest/_sources/reference/mpremote.rst.txt"

# Pimoroni learning article
URL_PIMORONI_LEARN="https://r.jina.ai/https://learn.pimoroni.com/article/getting-started-with-inky-frame"

# Main output directory for repomix
MIX_DIR="$BUILD_DIR/mix"

require() {
  hash "$@" || {
    echo "Error: Command '$1' not found." >&2
    exit 127
  }
}

require curl
require unzip
require repomix
require cp
require rm

# Create directories
mkdir -p "$EXTRACT_DIR_INKY" "$EXTRACT_DIR_PICO" "$MIX_DIR"

# --- Source 1: Inky Frame ---
curl -fsSL -o "$ZIP_FILE_INKY" "$URL_INKY"
unzip -o -q "$ZIP_FILE_INKY" -d "$EXTRACT_DIR_INKY"
mkdir -p "$MIX_DIR/inky-frame"
cp -R "$DOCS_DIR_INKY/docs" "$MIX_DIR/inky-frame/"
cp -R "$DOCS_DIR_INKY/examples" "$MIX_DIR/inky-frame/"
cp -R "$DOCS_DIR_INKY/modules" "$MIX_DIR/inky-frame/"

# --- Source 2: Pimoroni Pico (picographics) ---
curl -fsSL -o "$ZIP_FILE_PICO" "$URL_PICO"
unzip -o -q "$ZIP_FILE_PICO" -d "$EXTRACT_DIR_PICO"
mkdir -p "$MIX_DIR/pico"
cp -R "$DOCS_DIR_PICO/micropython/modules/picographics" "$MIX_DIR/pico/"

# --- Source 3: mpremote docs ---
mkdir -p "$MIX_DIR/mpremote"
curl -fsSL -o "$MIX_DIR/mpremote/mpremote.rst.txt" "$URL_MPREMOTE"

# --- Source 4: Pimoroni learning article ---
mkdir -p "$MIX_DIR/pimoroni-learn"
curl -fsSL -o "$MIX_DIR/pimoroni-learn/getting-started-with-inky-frame.md" "$URL_PIMORONI_LEARN"

# --- Run repomix ---
repomix "$MIX_DIR" --include="**" --no-security-check --quiet -o -
