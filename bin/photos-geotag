#!/usr/bin/env bash

# Geotags image files in input directory using GPX tracks uploaded to
# iCloud by https://itunes.apple.com/gb/app/geotag-photos-pro-2/id1008694552?mt=8

usage() {
  cat <<EOF
Usage: $(basename "$0") DIRECTORY [OFFSET]

Geotags image files using GPX tracks from Geotag Photos Pro 2.

Arguments:
  DIRECTORY   The directory containing photos to geotag.
  OFFSET      Optional UTC offset (e.g., "-01:00:00"). Delta = -1 * Geotag
              Photos 2 offset. See http://bit.ly/2wkvvhF

Options:
  --help      Display this help message and exit

Examples:
  $(basename "$0") .
  $(basename "$0") . -01:00:00
EOF
  exit 0
}

if [[ "$1" == "--help" ]]; then
  usage
fi

GPXDIR="$HOME/Library/Mobile Documents/iCloud~com~tappytaps~geotagphotos2/Documents"

require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo >&2 "$(basename "$0"): $1 not found"
    exit 127
  }
}

require exiftool

if [ $# -eq 0 ]; then
  usage 1 >&2
fi

if ! test -d "$GPXDIR"; then
  echo "$(basename "$0"): error: [$GPXDIR] not found" >&2
fi

if ! test -d "$1"; then
  echo "$(basename "$0"): error: [$1] is not a directory" >&2
  exit 1
fi

if test -n "$2"; then
  env TZ="" exiftool -overwrite_original -geotag "$GPXDIR/*.gpx" -api GeoMaxIntSecs=28800 -api GeoMaxExtSecs=28800 -geosync="$2" "$1"
else
  env TZ="" exiftool -overwrite_original -geotag "$GPXDIR/*.gpx" -api GeoMaxIntSecs=28800 -api GeoMaxExtSecs=28800 "$1"
fi
