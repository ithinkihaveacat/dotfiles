#!/usr/bin/env bash
set -euo pipefail

export ANDROID_HOME="${ANDROID_HOME:-$HOME/.local/share/android-sdk}"

# IMPORTANT: All Android SDK tools (adb, emulator, avdmanager, sdkmanager, etc.)
# must be invoked using their full paths within $ANDROID_HOME, NOT from system PATH.
# This ensures we use the correct versions and avoid conflicts with system-installed
# Android tools. The require() function allows these commands to be satisfied from
# $ANDROID_HOME paths.
# To find valid versions for build-tools, run:
# sdkmanager --list | grep "build-tools;"
export ANDROID_BUILD_TOOLS_VERSION="36.0.0"
# To find valid versions for platforms, run:
# sdkmanager --list | grep "platforms;android-"
export ANDROID_PLATFORM_VERSION="android-36"

get_host_arch() {
  case "$(uname -m)" in
    arm64 | aarch64)
      echo "arm64-v8a"
      ;;
    x86_64)
      echo "x86_64"
      ;;
    *)
      echo "$(basename "$0"): Unsupported architecture: $(uname -m)" >&2
      exit 1
      ;;
  esac
}

get_default_image_package() {
  local arch
  arch=$(get_host_arch)
  echo "system-images;${ANDROID_PLATFORM_VERSION};android-wear-signed;${arch}"
}



usage() {
  local exit_code="${1:-0}"
  cat <<EOF
Usage: $(basename "$0") [COMMAND]

A script to set up and manage the Android SDK, emulator, and system images.

Environment:
  ANDROID_HOME: ${ANDROID_HOME}

Commands:
  bootstrap           Bootstrap SDK environment for emulator management.
  list                List all available AVDs.
  info <name>         Show detailed information about an AVD.
  create <name> [image] Create a new Wear OS AVD.
                      Defaults to image: $(get_default_image_package)
  start <name>        Start the specified AVD.
  stop <name>         Stop the specified AVD.
  delete <name>       Delete the specified AVD.
  images              List all available system images with API level >=33.
  outdated            Show outdated SDK packages.
  update              Update all installed SDK packages to latest versions.

Options:
  -h, --help          Display this help message and exit

Examples:
  # Create a new AVD with the default image
  $(basename "$0") create my_default_avd

  # Create a new AVD with a specific image
  $(basename "$0") create my_specific_avd "system-images;android-33;android-wear;x86_64"

  # Show information about an AVD
  $(basename "$0") info my_default_avd

  # Start a specific AVD
  $(basename "$0") start my_default_avd

  # Check for outdated packages
  $(basename "$0") outdated
EOF
  exit "$exit_code"
}

require() {
  for cmd in "$@"; do
    if ! command -v "$cmd" &>/dev/null; then
      # If the command is in our SDK, let's try to find it there
      if [[ -f "$ANDROID_HOME/cmdline-tools/latest/bin/$cmd" || -f "$ANDROID_HOME/emulator/$cmd" || -f "$ANDROID_HOME/platform-tools/$cmd" ]]; then
        continue
      fi
      echo "$(basename "$0"): '$cmd' command not found" >&2
      exit 127
    fi
  done
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
fi

if [[ -z "${1:-}" ]]; then
  usage
fi

install_cli_tools() {

  # Check if Android SDK cmdline-tools directory already exists
  if [[ -d "$ANDROID_HOME/cmdline-tools" ]]; then
    return 0
  fi

  local temp_dir
  temp_dir=$(mktemp -d)
  trap 'rm -rf -- "$temp_dir"' EXIT

  local os
  case "$(uname -s)" in
    Darwin)
      os="mac"
      ;;
    Linux)
      os="linux"
      ;;
    *)
      echo "$(basename "$0"): Unsupported OS: $(uname -s)" >&2
      exit 1
      ;;
  esac

  local repository_xml
  echo "Fetching repository metadata..."
  if ! repository_xml=$(curl -fsSL --connect-timeout 30 --max-time 60 https://dl.google.com/android/repository/repository2-1.xml); then
    echo "$(basename "$0"): Failed to fetch repository metadata" >&2
    echo "For manual installation: https://developer.android.com/studio#command-line-tools-only" >&2
    exit 1
  fi

  if [[ -z "${repository_xml}" ]]; then
    echo "$(basename "$0"): Repository metadata is empty" >&2
    echo "For manual installation: https://developer.android.com/studio#command-line-tools-only" >&2
    exit 1
  fi

  local latest_zip
  latest_zip=$(echo "${repository_xml}" | grep "commandlinetools-${os}" | head -n 1 | sed -e 's/.*>\(.*\).zip<\/url>.*/\1.zip/' || true)

  if [[ -z "${latest_zip}" || "${latest_zip}" == ".zip" ]]; then
    echo "$(basename "$0"): Could not parse command-line tools URL for ${os}" >&2
    echo "For manual installation: https://developer.android.com/studio#command-line-tools-only" >&2
    exit 1
  fi

  local download_url
  download_url="https://dl.google.com/android/repository/${latest_zip}"
  echo "Downloading ${download_url}..."
  if ! curl -fL --connect-timeout 30 --max-time 300 "${download_url}" -o "${temp_dir}/commandlinetools.zip"; then
    echo "$(basename "$0"): Failed to download command-line tools" >&2
    echo "For manual installation: https://developer.android.com/studio#command-line-tools-only" >&2
    exit 1
  fi

  # Verify download is not empty
  if [[ ! -s "${temp_dir}/commandlinetools.zip" ]]; then
    echo "$(basename "$0"): Downloaded file is empty" >&2
    echo "For manual installation: https://developer.android.com/studio#command-line-tools-only" >&2
    exit 1
  fi

  echo "Unzipping to ${temp_dir}..."
  if ! unzip -q "${temp_dir}/commandlinetools.zip" -d "${temp_dir}"; then
    echo "$(basename "$0"): Failed to unzip command-line tools" >&2
    echo "For manual installation: https://developer.android.com/studio#command-line-tools-only" >&2
    exit 1
  fi

  # Per https://developer.android.com/tools/sdkmanager
  local install_dir="$ANDROID_HOME/cmdline-tools/latest"
  echo "Creating installation directory ${install_dir}..."
  rm -rf "$ANDROID_HOME/cmdline-tools"
  if ! mkdir -p "${install_dir}"; then
    echo "$(basename "$0"): Failed to create directory ${install_dir}" >&2
    exit 1
  fi

  echo "Moving cmdline-tools contents to ${install_dir}..."
  if ! mv "${temp_dir}/cmdline-tools/"* "${install_dir}/"; then
    echo "$(basename "$0"): Failed to move cmdline-tools to ${install_dir}" >&2
    exit 1
  fi

  local sdkmanager_path="${install_dir}/bin/sdkmanager"
  # Conditionally patch sdkmanager to fix a quoting bug
  # shellcheck disable=SC2016
  if grep -q 'JAVA_VER=$($JAVACMD' "${sdkmanager_path}" 2>/dev/null; then
    echo "Patching sdkmanager to fix quoting bug..."
    cp "${sdkmanager_path}" "${sdkmanager_path}.backup"
    # shellcheck disable=SC2016
    if [[ "$os" == "mac" ]]; then
      sed -i '' 's/JAVA_VER=$($JAVACMD/JAVA_VER=$("$JAVACMD"/g' "${sdkmanager_path}"
    else
      sed -i 's/JAVA_VER=$($JAVACMD/JAVA_VER=$("$JAVACMD"/g' "${sdkmanager_path}"
    fi
  fi

  local avdmanager_path="${install_dir}/bin/avdmanager"
  # Conditionally patch avdmanager to fix a quoting bug
  # shellcheck disable=SC2016
  if grep -q 'JAVA_VER=$($JAVACMD' "${avdmanager_path}" 2>/dev/null; then
    echo "Patching avdmanager to fix quoting bug..."
    cp "${avdmanager_path}" "${avdmanager_path}.backup"
    # shellcheck disable=SC2016
    if [[ "$os" == "mac" ]]; then
      sed -i '' 's/JAVA_VER=$($JAVACMD/JAVA_VER=$("$JAVACMD"/g' "${avdmanager_path}"
    else
      sed -i 's/JAVA_VER=$($JAVACMD/JAVA_VER=$("$JAVACMD"/g' "${avdmanager_path}"
    fi
  fi

  # Clean up temp directory and remove trap
  rm -rf -- "$temp_dir"
  trap - EXIT
}

install_emulator() {
  if [[ -f "$ANDROID_HOME/emulator/emulator" ]]; then
    return 0
  fi

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run 'bootstrap' first." >&2
    exit 1
  fi

  echo "Installing emulator..."
  yes | "${sdkmanager}" --licenses > /dev/null || true
  "${sdkmanager}" --install "emulator"
}

install_platform_tools() {
  if [[ -d "$ANDROID_HOME/platform-tools" ]]; then
    return 0
  fi

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run 'bootstrap' first." >&2
    exit 1
  fi

  echo "Installing platform-tools..."
  yes | "${sdkmanager}" --licenses > /dev/null || true
  "${sdkmanager}" --install "platform-tools"
}

install_build_tools() {
  if [[ -d "$ANDROID_HOME/build-tools/${ANDROID_BUILD_TOOLS_VERSION}" ]]; then
    return 0
  fi

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run 'bootstrap' first." >&2
    exit 1
  fi

  echo "Installing build-tools..."
  yes | "${sdkmanager}" --licenses > /dev/null || true
  "${sdkmanager}" --install "build-tools;${ANDROID_BUILD_TOOLS_VERSION}"
}

install_platforms() {

  if [[ -d "$ANDROID_HOME/platforms/${ANDROID_PLATFORM_VERSION}" ]]; then

    return 0

  fi



  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"

  if [[ ! -f "$sdkmanager" ]]; then

    echo "$(basename "$0"): sdkmanager not found. Please run 'bootstrap' first." >&2

    exit 1

  fi



  echo "Installing platforms;${ANDROID_PLATFORM_VERSION}... "

  yes | "${sdkmanager}" --licenses > /dev/null || true

  "${sdkmanager}" --install "platforms;${ANDROID_PLATFORM_VERSION}"

}

create_avd() {
  bootstrap
  require avdmanager

  local avd_name="$1"
  local image_package="$2"

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  local avdmanager="$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager"

  if "${avdmanager}" list avd | grep -q "Name: ${avd_name}"; then
    echo "AVD '${avd_name}' already exists."
    return 0
  fi

  if [[ -z "$image_package" ]]; then
    image_package=$(get_default_image_package)
    echo "No image specified, using default: ${image_package}"
  fi

  # Check if the image is installed, and install it if it's not
  local installed_packages
  installed_packages=$("${sdkmanager}" --list_installed)
  if ! echo "${installed_packages}" | grep -q "${image_package}"; then
    echo "System image '${image_package}' not found. Installing..."
    yes | "${sdkmanager}" --licenses > /dev/null || true
    if ! "${sdkmanager}" --install "${image_package}"; then
      echo "Failed to install system image '${image_package}'. Please check if the package name is valid." >&2
      exit 1
    fi
  fi

  echo "Creating AVD '${avd_name}' with image '${image_package}'..."
  # TODO: enable different device definitions ("wearos_large_round")
  echo "no" | "${avdmanager}" create avd -n "${avd_name}" -k "${image_package}" -d "wearos_large_round"
}

start_avd() {
  bootstrap
  require emulator adb

  local avd_name="$1"

  # Check if AVD exists by listing them
  local all_avds
  all_avds=$("$ANDROID_HOME/emulator/emulator" -list-avds)
  if ! echo "$all_avds" | grep -q "^${avd_name}$"; then
    echo "$(basename "$0"): AVD '${avd_name}' does not exist. Available AVDs:" >&2
    echo "$all_avds" >&2
    exit 1
  fi

  # Check if AVD is already running
  local running_avds
  # shellcheck disable=SC2063
  running_avds=$(list_avds | grep '^*' | cut -d' ' -f2 || true)
  if echo "$running_avds" | grep -q "^${avd_name}$"; then
    echo "AVD '${avd_name}' is already running."
    return 0
  fi

  local emulator_path="$ANDROID_HOME/emulator/emulator"
  if [[ ! -f "${emulator_path}" ]]; then
    echo "$(basename "$0"): emulator not found. Please run 'bootstrap' first." >&2
    exit 1
  fi

  # Check for platform-tools
  if [[ ! -d "$ANDROID_HOME/platform-tools" ]]; then
    echo "$(basename "$0"): platform-tools not found. Please run 'bootstrap' first." >&2
    exit 1
  fi

  local adb_path="$ANDROID_HOME/platform-tools/adb"
  if [[ ! -f "${adb_path}" ]]; then
    echo "$(basename "$0"): adb not found. Please run 'bootstrap' first." >&2
    exit 1
  fi

  # Check for KVM support on Linux for x86_64 emulators
  if [[ "$(uname -s)" == "Linux" && "$(get_host_arch)" == "x86_64" ]]; then
    if [[ ! -e /dev/kvm ]]; then
      echo "$(basename "$0"): ERROR: /dev/kvm not found." >&2
      echo "KVM acceleration is required for x86_64 emulators on Linux." >&2
      echo "Please ensure KVM is enabled in BIOS and the module is loaded." >&2
      echo "More info: https://developer.android.com/studio/run/emulator-acceleration#vm-linux" >&2
      exit 1
    fi
    if ! grep -q -E 'vmx|svm' /proc/cpuinfo; then
      echo "$(basename "$0"): ERROR: CPU does not support required virtualization extensions (VT-x or AMD-V)." >&2
      echo "KVM acceleration is required for x86_64 emulators on Linux." >&2
      echo "More info: https://developer.android.com/studio/run/emulator-acceleration#vm-linux" >&2
      exit 1
    fi
    if ! groups | grep -q "\\bkvm\\b"; then
      echo "$(basename "$0"): WARNING: User is not in the 'kvm' group. Emulator may fail to start." >&2
      echo "Run: sudo usermod -aG kvm $USER" >&2
      echo "You may need to log out and log back in for the group change to take effect." >&2
    fi
  fi

  echo "Starting AVD '${avd_name}'..."
  local emulator_log
  emulator_log=$(mktemp)
  nohup "${emulator_path}" -avd "${avd_name}" -no-snapshot-load > "${emulator_log}" 2>&1 &

  echo ""
  echo "To debug emulator issues, run this command:"
  echo "  ${emulator_path} -avd '${avd_name}' -no-snapshot-load -verbose -show-kernel -no-audio"
  echo ""

  echo "Waiting for device to connect (timeout: 120s)..."
  if ! timeout 120 "${adb_path}" wait-for-device; then
    echo "$(basename "$0"): Timeout waiting for device to connect" >&2
    echo "The emulator may still be starting. Check with: ${adb_path} devices" >&2
    echo "Or debug with the command shown above" >&2
    echo "--- Emulator Output --- $(date) --- " >&2
    cat "${emulator_log}" >&2
    echo "--- End Emulator Output --- $(date) --- " >&2
    rm -f "${emulator_log}"
    exit 1
  fi
  rm -f "${emulator_log}"
  echo "Device connected."
}

stop_avd() {
  bootstrap
  require adb emulator

  local avd_name_to_stop="$1"

  # Check if AVD exists
  if ! "$ANDROID_HOME/emulator/emulator" -list-avds | grep -q "^${avd_name_to_stop}$"; then
    echo "$(basename "$0"): AVD '${avd_name_to_stop}' does not exist." >&2
    exit 1
  fi

  local adb_path="$ANDROID_HOME/platform-tools/adb"

  echo "Attempting to stop AVD '$avd_name_to_stop'..."

  # Get serial numbers of all online emulator devices
  local device_serials
  device_serials=$("${adb_path}" devices | grep "emulator-" | awk '{print $1}')

  if [[ -z "$device_serials" ]]; then
    echo "No running emulators found."
    return 0
  fi

  local found_avd=false
  for serial in $device_serials; do
    # Get the AVD name for the current device and trim whitespace/carriage returns
    local running_avd_name
    running_avd_name=$("${adb_path}" -s "$serial" shell getprop ro.boot.qemu.avd_name | tr -d '[:space:]')

    if [[ "$running_avd_name" == "$avd_name_to_stop" ]]; then
      echo "Found running AVD '$avd_name_to_stop' on device '$serial'. Stopping it..."
      "${adb_path}" -s "$serial" emu kill
      echo "AVD '$avd_name_to_stop' stopped."
      found_avd=true
      break # Stop after finding and killing the first match
    fi
  done

  if [[ "$found_avd" == false ]]; then
    echo "AVD '$avd_name_to_stop' is not currently running."
  fi
}

delete_avd() {
  bootstrap
  require avdmanager emulator

  local avd_name="$1"

  # Check if AVD exists
  if ! "$ANDROID_HOME/emulator/emulator" -list-avds | grep -q "^${avd_name}$"; then
    echo "$(basename "$0"): AVD '${avd_name}' does not exist." >&2
    exit 1
  fi

  # Check if AVD is running and stop it
  local running_avds
  # shellcheck disable=SC2063
  running_avds=$(list_avds | grep '^*' | cut -d' ' -f2)
  if echo "$running_avds" | grep -q "^${avd_name}$"; then
    echo "AVD '${avd_name}' is running. Stopping it first..."
    stop_avd "${avd_name}"
  fi

  local avdmanager_path="$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager"
  echo "Deleting AVD '${avd_name}'..."
\
  "${avdmanager_path}" delete avd -n "${avd_name}"

  # Verify that the AVD has been deleted (with retry)
  local attempts=0
  while [[ $attempts -lt 3 ]]; do
    if ! "${avdmanager_path}" list avd | grep -q "Name: ${avd_name}"; then
      echo "AVD '${avd_name}' deleted successfully."
      return 0
    fi
    attempts=$((attempts + 1))
    sleep 1
  done

  echo "$(basename "$0"): Failed to delete AVD '${avd_name}'." >&2
  exit 1
}

list_avds() {
  bootstrap
  require emulator adb

  local emulator_path="$ANDROID_HOME/emulator/emulator"
  local adb_path="$ANDROID_HOME/platform-tools/adb"

  # Get all available AVDs
  local all_avds
  all_avds=$("${emulator_path}" -list-avds)

  # If --names-only flag is provided, output just the names and return
  if [[ "${1:-}" == "--names-only" ]]; then
    echo "$all_avds"
    return 0
  fi

  # Get the names of all running AVDs
  local running_avd_names=()
  local device_serials
  device_serials=$(timeout 5 "${adb_path}" devices | grep "emulator-" | awk '{print $1}' || true)

  if [[ -n "$device_serials" ]]; then
    for serial in $device_serials; do
      local avd_name
      avd_name=$(timeout 5 "${adb_path}" -s "$serial" shell getprop ro.boot.qemu.avd_name | tr -d '[:space:]' || true)
      if [[ -n "$avd_name" ]]; then
        running_avd_names+=("$avd_name")
      fi
    done
  fi

  # Print the list, marking running AVDs
  echo "$all_avds" | while IFS= read -r avd; do
    local is_running=false
    for running_avd in "${running_avd_names[@]}"; do
      if [[ "$avd" == "$running_avd" ]]; then
        is_running=true
        break
      fi
    done

    if [[ "$is_running" == true ]]; then
      echo "* $avd"
    else
      echo "  $avd"
    fi
  done
}

list_images() {
  bootstrap
  require sdkmanager

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"

  # Determine host architecture for filtering
  local arch_filter
  arch_filter=$(get_host_arch)

  # Get all available system images and installed packages
  local all_packages_raw
  all_packages_raw=$("$sdkmanager" --list)
  local installed_packages
  installed_packages=$("$sdkmanager" --list_installed | awk -F'|' '{print $1}' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

  (echo "$all_packages_raw" | grep "system-images;android-" | grep "$arch_filter" | while IFS= read -r line; do
    # Extract package path and trim whitespace
    local package_path
    package_path=$(echo "$line" | awk -F'|' '{print $1}' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

    # Extract API level
    local api_level
    api_level=$(echo "$package_path" | awk -F';' '{print $2}' | cut -d'-' -f2)

    # Check if API level is a number and greater than or equal to 33
    if [[ "$api_level" =~ ^[0-9]+$ ]] && [[ "$api_level" -ge 33 ]]; then
      # Check if the package is installed
      if echo "$installed_packages" | grep -q -x "$package_path"; then
        echo "* $package_path"
      else
        echo "  $package_path"
      fi
    fi
  done) | sort | uniq
}

info_avd() {

  local avd_name="$1"
  local avd_ini="$HOME/.android/avd/${avd_name}.ini"
  local adb_path="$ANDROID_HOME/platform-tools/adb"

  if [[ ! -f "$avd_ini" ]]; then
    echo "$(basename "$0"): AVD '${avd_name}' does not exist." >&2
    exit 1
  fi

  # Get AVD directory path
  local avd_path
  avd_path=$(grep "^path=" "$avd_ini" | cut -d'=' -f2)
  local config_ini="${avd_path}/config.ini"

  if [[ ! -f "$config_ini" ]]; then
    echo "$(basename "$0"): AVD configuration file not found at ${config_ini}" >&2
    exit 1
  fi

  # Extract information from config.ini
  local display_name api_level sysdir tag_display abi_type device_name
  local lcd_width lcd_height lcd_density lcd_circular ram_size data_size
  local sdcard_size playstore_enabled

  display_name=$(grep "^avd.ini.displayname=" "$config_ini" | cut -d'=' -f2- | tr -d '\r' || true)
  api_level=$(grep "^image.sysdir.1=" "$config_ini" | cut -d'=' -f2 | sed 's|system-images/android-\([0-9]*\)/.*|\1|' | tr -d '\r' || true)
  sysdir=$(grep "^image.sysdir.1=" "$config_ini" | cut -d'=' -f2 | tr -d '\r' || true)
  tag_display=$(grep "^tag.display=" "$config_ini" | cut -d'=' -f2- | tr -d '\r' || true)
  abi_type=$(grep "^abi.type=" "$config_ini" | cut -d'=' -f2 | tr -d '\r' || true)
  device_name=$(grep "^hw.device.name=" "$config_ini" | cut -d'=' -f2 | tr -d '\r' || true)
  lcd_width=$(grep "^hw.lcd.width=" "$config_ini" | cut -d'=' -f2 | tr -d '\r' || true)
  lcd_height=$(grep "^hw.lcd.height=" "$config_ini" | cut -d'=' -f2 | tr -d '\r' || true)
  lcd_density=$(grep "^hw.lcd.density=" "$config_ini" | cut -d'=' -f2 | tr -d '\r' || true)
  lcd_circular=$(grep "^hw.lcd.circular=" "$config_ini" | cut -d'=' -f2 | tr -d '\r' || true)
  ram_size=$(grep "^hw.ramSize=" "$config_ini" | cut -d'=' -f2 | tr -d '\r' || true)
  data_size=$(grep "^disk.dataPartition.size=" "$config_ini" | cut -d'=' -f2 | tr -d '\r' || true)
  sdcard_size=$(grep "^sdcard.size=" "$config_ini" | cut -d'=' -f2 | tr -d '\r' || true)
  playstore_enabled=$(grep "^PlayStore.enabled=" "$config_ini" | cut -d'=' -f2 | tr -d '\r' || true)

  # Convert sysdir path to package name (e.g., system-images/android-36/android-wear-signed/arm64-v8a/)
  local package_name
  if [[ -n "$sysdir" ]]; then
    package_name=$(echo "$sysdir" | sed 's|system-images/|system-images;|' | sed 's|/|;|g' | sed 's|;$||')
  fi

  # Check if AVD is running
  local is_running=false
  local serial_number=""
  local device_serials
  device_serials=$(timeout 5 "${adb_path}" devices | grep "emulator-" | awk '{print $1}' || true)

  if [[ -n "$device_serials" ]]; then
    for serial in $device_serials; do
      local running_avd_name
      running_avd_name=$(timeout 5 "${adb_path}" -s "$serial" emu avd name 2>/dev/null | tr -d '[:space:]' || true)
      if [[ "$running_avd_name" == "$avd_name" ]]; then
        is_running=true
        serial_number="$serial"
        break
      fi
    done
  fi

  # Display information
  echo "AVD Information: ${avd_name}"
  if [[ -n "$display_name" ]]; then
    echo "  Display Name: ${display_name}"
  fi

  if [[ "$is_running" == true ]]; then
    echo "  Status: Running (${serial_number})"
  else
    echo "  Status: Stopped"
  fi

  echo ""
  echo "System Image:"
  if [[ -n "$package_name" ]]; then
    echo "  Package: ${package_name}"
  fi
  if [[ -n "$api_level" ]]; then
    echo "  API Level: ${api_level}"
  fi
  if [[ -n "$tag_display" ]]; then
    echo "  Tag: ${tag_display}"
  fi
  if [[ -n "$abi_type" ]]; then
    echo "  Architecture: ${abi_type}"
  fi

  echo ""
  echo "Device Configuration:"
  if [[ -n "$device_name" ]]; then
    echo "  Profile: ${device_name}"
  fi
  if [[ -n "$lcd_width" && -n "$lcd_height" ]]; then
    local screen_info="${lcd_width}x${lcd_height}"
    if [[ -n "$lcd_density" ]]; then
      screen_info="${screen_info} (${lcd_density} dpi"
      if [[ "$lcd_circular" == "true" ]]; then
        screen_info="${screen_info}, circular)"
      else
        screen_info="${screen_info})"
      fi
    fi
    echo "  Screen: ${screen_info}"
  fi
  if [[ -n "$ram_size" ]]; then
    echo "  RAM: ${ram_size} MB"
  fi
  if [[ -n "$data_size" ]]; then
    echo "  Storage: ${data_size}"
  fi
  if [[ -n "$sdcard_size" ]]; then
    echo "  SD Card: ${sdcard_size}"
  fi
  if [[ -n "$playstore_enabled" ]]; then
    if [[ "$playstore_enabled" == "true" ]]; then
      echo "  Play Store: Yes"
    else
      echo "  Play Store: No"
    fi
  fi

  echo ""
  echo "Path: ${avd_path}"
}

check_outdated() {
  bootstrap
  require sdkmanager

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"

  echo "Checking for outdated packages..."
  echo ""
  "${sdkmanager}" --list | grep -A 1000 "Updates" || echo "All packages are up to date."
}

update_packages() {
  bootstrap
  require sdkmanager

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"

  echo "Updating all installed packages..."
  yes | "${sdkmanager}" --licenses > /dev/null || true

  if ! "${sdkmanager}" --update; then
    echo "$(basename "$0"): Failed to update packages" >&2
    echo "Try running manually: ${sdkmanager} --update" >&2
    exit 1
  fi

  echo "All packages updated successfully."
}

bootstrap() {
  install_cli_tools
  install_platform_tools
  install_build_tools
  install_platforms
  install_emulator
}

case "$1" in
  bootstrap)
    bootstrap
    ;;
  list)
    list_avds "${2:-}"
    ;;
  info)
    if [[ -z "${2:-}" ]]; then echo "$(basename "$0") info: AVD name required" >&2; exit 1; fi
    info_avd "$2"
    ;;
  images)
    list_images
    ;;
  outdated)
    check_outdated
    ;;
  update)
    update_packages
    ;;
  create)
    if [[ -n "${4:-}" ]]; then echo "$(basename "$0") create: too many arguments" >&2; exit 1; fi
    if [[ -z "${2:-}" ]]; then echo "$(basename "$0") create: AVD name required" >&2; exit 1; fi
    create_avd "$2" "${3:-}"
    ;;
  start)
    if [[ -z "${2:-}" ]]; then echo "$(basename "$0") start: AVD name required" >&2; exit 1; fi
    start_avd "$2"
    ;;
  stop)
    if [[ -z "${2:-}" ]]; then echo "$(basename "$0") stop: AVD name required" >&2; exit 1; fi
    stop_avd "$2"
    ;;
  delete)
    if [[ -z "${2:-}" ]]; then echo "$(basename "$0") delete: AVD name required" >&2; exit 1; fi
    delete_avd "$2"
    ;;
  *)
    echo "$(basename "$0"): unknown command '$1'" >&2
    usage 1
    ;;
esac