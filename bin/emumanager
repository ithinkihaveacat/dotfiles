#!/usr/bin/env bash
set -euo pipefail

export ANDROID_HOME="${ANDROID_HOME:-$HOME/.local/share/android-sdk}"
# To find valid versions for build-tools, run:
# sdkmanager --list | grep "build-tools;"
export ANDROID_BUILD_TOOLS_VERSION="36.0.0"
# To find valid versions for platforms, run:
# sdkmanager --list | grep "platforms;android-"
export ANDROID_PLATFORM_VERSION="android-36"

get_host_arch() {
  require uname
  case "$(uname -m)" in
    arm64 | aarch64)
      echo "arm64-v8a"
      ;;
    x86_64)
      echo "x86_64"
      ;;
    *)
      echo "$(basename "$0"): Unsupported architecture: $(uname -m)" >&2
      exit 1
      ;;
  esac
}

get_default_image_package() {
  local arch
  arch=$(get_host_arch)
  echo "system-images;${ANDROID_PLATFORM_VERSION};android-wear-signed;${arch}"
}



usage() {
  cat <<EOF
Usage: $(basename "$0") [COMMAND]

A script to set up and manage the Android SDK, emulator, and system images.

Commands:
  install-dependencies Install all necessary SDK components for creating and running an AVD.
  list                List all available AVDs.
  create <name> [image] Create a new Wear OS AVD.
                      Defaults to image: $(get_default_image_package)
  start <name>        Start the specified AVD.
  stop <name>         Stop the specified AVD.
  delete <name>       Delete the specified AVD.
  images              List all available system images with API level >=33.
  check-updates       Check for updates to installed SDK packages.
  upgrade             Upgrade all installed SDK packages to latest versions.

Options:
  -h, --help          Display this help message and exit

Examples:
  # Create a new AVD with the default image
  $(basename "$0") create my_default_avd

  # Create a new AVD with a specific image
  $(basename "$0") create my_specific_avd "system-images;android-33;android-wear;x86_64"

  # Start a specific AVD
  $(basename "$0") start my_default_avd

  # Check for updates
  $(basename "$0") check-updates
EOF
  exit 0
}

require() {
  for cmd in "$@"; do
    if ! command -v "$cmd" &>/dev/null; then
      # If the command is in our SDK, let's try to find it there
      if [[ -f "$ANDROID_HOME/cmdline-tools/latest/bin/$cmd" || -f "$ANDROID_HOME/emulator/$cmd" || -f "$ANDROID_HOME/platform-tools/$cmd" ]]; then
        continue
      fi
      echo "$(basename "$0"): '$cmd' command not found" >&2
      exit 127
    fi
  done
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

if [[ -z "$1" ]]; then
  usage
fi

install_cli_tools() {
  require curl mktemp unzip uname grep head sed rm mkdir mv

  # Check if Android SDK cmdline-tools directory already exists
  if [[ -d "$ANDROID_HOME/cmdline-tools" ]]; then
    echo "Android SDK command-line tools already installed."
    return 0
  fi

  local temp_dir
  temp_dir=$(mktemp -d)
  trap 'rm -rf -- "$temp_dir"' EXIT

  local os
  case "$(uname -s)" in
    Darwin)
      os="mac"
      ;;
    Linux)
      os="linux"
      ;;
    *)
      echo "$(basename "$0"): Unsupported OS: $(uname -s)" >&2
      exit 1
      ;;
  esac

  local repository_xml
  echo "Fetching repository metadata..."
  if ! repository_xml=$(curl -fsSL --connect-timeout 30 --max-time 60 https://dl.google.com/android/repository/repository2-1.xml); then
    echo "$(basename "$0"): Failed to fetch repository metadata" >&2
    echo "For manual installation: https://developer.android.com/studio#command-line-tools-only" >&2
    exit 1
  fi

  if [[ -z "${repository_xml}" ]]; then
    echo "$(basename "$0"): Repository metadata is empty" >&2
    echo "For manual installation: https://developer.android.com/studio#command-line-tools-only" >&2
    exit 1
  fi

  local latest_zip
  latest_zip=$(echo "${repository_xml}" | grep "commandlinetools-${os}" | head -n 1 | sed -e 's/.*>\(.*\).zip<\/url>.*/\1.zip/' || true)

  if [[ -z "${latest_zip}" || "${latest_zip}" == ".zip" ]]; then
    echo "$(basename "$0"): Could not parse command-line tools URL for ${os}" >&2
    echo "For manual installation: https://developer.android.com/studio#command-line-tools-only" >&2
    exit 1
  fi

  local download_url
  download_url="https://dl.google.com/android/repository/${latest_zip}"
  echo "Downloading ${download_url}..."
  if ! curl -fL --connect-timeout 30 --max-time 300 "${download_url}" -o "${temp_dir}/commandlinetools.zip"; then
    echo "$(basename "$0"): Failed to download command-line tools" >&2
    echo "For manual installation: https://developer.android.com/studio#command-line-tools-only" >&2
    exit 1
  fi

  # Verify download is not empty
  if [[ ! -s "${temp_dir}/commandlinetools.zip" ]]; then
    echo "$(basename "$0"): Downloaded file is empty" >&2
    echo "For manual installation: https://developer.android.com/studio#command-line-tools-only" >&2
    exit 1
  fi

  echo "Unzipping to ${temp_dir}..."
  if ! unzip -q "${temp_dir}/commandlinetools.zip" -d "${temp_dir}"; then
    echo "$(basename "$0"): Failed to unzip command-line tools" >&2
    echo "For manual installation: https://developer.android.com/studio#command-line-tools-only" >&2
    exit 1
  fi

  # Per https://developer.android.com/tools/sdkmanager
  local install_dir="$ANDROID_HOME/cmdline-tools/latest"
  echo "Creating installation directory ${install_dir}..."
  rm -rf "$ANDROID_HOME/cmdline-tools"
  if ! mkdir -p "${install_dir}"; then
    echo "$(basename "$0"): Failed to create directory ${install_dir}" >&2
    exit 1
  fi

  echo "Moving cmdline-tools contents to ${install_dir}..."
  if ! mv "${temp_dir}/cmdline-tools/"* "${install_dir}/"; then
    echo "$(basename "$0"): Failed to move cmdline-tools to ${install_dir}" >&2
    exit 1
  fi

  local sdkmanager_path="${install_dir}/bin/sdkmanager"
  # Conditionally patch sdkmanager to fix a quoting bug
  # shellcheck disable=SC2016
  if grep -q 'JAVA_VER=$($JAVACMD' "${sdkmanager_path}" 2>/dev/null; then
    echo "Patching sdkmanager to fix quoting bug..."
    cp "${sdkmanager_path}" "${sdkmanager_path}.backup"
    # shellcheck disable=SC2016
    if [[ "$os" == "mac" ]]; then
      sed -i '' 's/JAVA_VER=$($JAVACMD/JAVA_VER=$("$JAVACMD"/g' "${sdkmanager_path}"
    else
      sed -i 's/JAVA_VER=$($JAVACMD/JAVA_VER=$("$JAVACMD"/g' "${sdkmanager_path}"
    fi
  fi

  local avdmanager_path="${install_dir}/bin/avdmanager"
  # Conditionally patch avdmanager to fix a quoting bug
  # shellcheck disable=SC2016
  if grep -q 'JAVA_VER=$($JAVACMD' "${avdmanager_path}" 2>/dev/null; then
    echo "Patching avdmanager to fix quoting bug..."
    cp "${avdmanager_path}" "${avdmanager_path}.backup"
    # shellcheck disable=SC2016
    if [[ "$os" == "mac" ]]; then
      sed -i '' 's/JAVA_VER=$($JAVACMD/JAVA_VER=$("$JAVACMD"/g' "${avdmanager_path}"
    else
      sed -i 's/JAVA_VER=$($JAVACMD/JAVA_VER=$("$JAVACMD"/g' "${avdmanager_path}"
    fi
  fi
}

install_emulator() {
  if [[ -f "$ANDROID_HOME/emulator/emulator" ]]; then
    echo "Android emulator already installed."
    return 0
  fi

  require yes

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run --install-cli-tools first." >&2
    exit 1
  fi

  echo "Installing emulator..."
  yes | "${sdkmanager}" --licenses > /dev/null
  "${sdkmanager}" --install "emulator"
}

install_platform_tools() {
  if [[ -d "$ANDROID_HOME/platform-tools" ]]; then
    echo "Android SDK platform-tools already installed."
    return 0
  fi

  require yes

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run --install-cli-tools first." >&2
    exit 1
  fi

  echo "Installing platform-tools..."
  yes | "${sdkmanager}" --licenses > /dev/null
  "${sdkmanager}" --install "platform-tools"
}

install_build_tools() {
  if [[ -d "$ANDROID_HOME/build-tools/$ANDROID_BUILD_TOOLS_VERSION" ]]; then
    echo "Android SDK build-tools version $ANDROID_BUILD_TOOLS_VERSION already installed."
    return 0
  fi

  require yes

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run --install-cli-tools first." >&2
    exit 1
  fi

  echo "Installing build-tools..."
  yes | "${sdkmanager}" --licenses > /dev/null
  "${sdkmanager}" --install "build-tools;${ANDROID_BUILD_TOOLS_VERSION}"
}

install_platforms() {
  if [[ -d "$ANDROID_HOME/platforms/$ANDROID_PLATFORM_VERSION" ]]; then
    echo "Android SDK platform $ANDROID_PLATFORM_VERSION already installed."
    return 0
  fi

  require yes

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  if [[ ! -f "$sdkmanager" ]]; then
    echo "$(basename "$0"): sdkmanager not found. Please run --install-cli-tools first." >&2
    exit 1
  fi

  echo "Installing platforms;${ANDROID_PLATFORM_VERSION}..."
  yes | "${sdkmanager}" --licenses > /dev/null
  "${sdkmanager}" --install "platforms;${ANDROID_PLATFORM_VERSION}"
}

create_avd() {
  ensure_dependencies
  require uname awk grep tail yes avdmanager

  local avd_name="$1"
  local image_package="$2"

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"
  local avdmanager="$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager"

  if "${avdmanager}" list avd | grep -q "Name: ${avd_name}"; then
    echo "AVD '${avd_name}' already exists."
    return 0
  fi

  if [[ -z "$image_package" ]]; then
    image_package=$(get_default_image_package)
    echo "No image specified, using default: ${image_package}"
  fi

  # Check if the image is installed, and install it if it's not
  local installed_packages
  installed_packages=$(env SKIP_JDK_VERSION_CHECK=1 "${sdkmanager}" --list_installed)
  if ! echo "${installed_packages}" | grep -q "${image_package}"; then
    echo "System image '${image_package}' not found. Installing..."
    yes | env SKIP_JDK_VERSION_CHECK=1 "${sdkmanager}" --licenses > /dev/null
    if ! env SKIP_JDK_VERSION_CHECK=1 "${sdkmanager}" --install "${image_package}"; then
      echo "Failed to install system image '${image_package}'. Please check if the package name is valid." >&2
      exit 1
    fi
  else
    echo "System image '${image_package}' already installed."
  fi

  echo "Creating AVD '${avd_name}' with image '${image_package}'..."
  # TODO: enable different device definitions ("wearos_large_round")
  echo "no" | "${avdmanager}" create avd -n "${avd_name}" -k "${image_package}" -d "wearos_large_round"
}

start_avd() {
  ensure_dependencies
  require emulator adb grep cut sed

  local avd_ini="$HOME/.android/avd/$1.ini"
  if [[ ! -f "$avd_ini" ]]; then
    echo "$(basename "$0"): AVD '$1' does not exist." >&2
    exit 1
  fi

  local avd_path
  avd_path=$(grep "path=" "$avd_ini" | cut -d'=' -f2)

  local image_sysdir
  image_sysdir=$(grep "image.sysdir.1" "$avd_path/config.ini" | cut -d'=' -f2)

  if [[ ! -d "$ANDROID_HOME/$image_sysdir" ]]; then
    local package_id
    package_id=$(echo "$image_sysdir" | sed 's/\//;/g' | sed 's/;$//')
    
    echo "$(basename "$0"): The system image required by this AVD is missing." >&2
    echo "To install it, run:" >&2
    echo "  \"$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager\" --install \"$package_id\""
    exit 1
  fi  

  local emulator_path="$ANDROID_HOME/emulator/emulator"
  if [[ ! -f "${emulator_path}" ]]; then
    echo "$(basename "$0"): emulator not found. Please run --install-emulator first." >&2
    exit 1
  fi

  # Check for platform-tools
  if [[ ! -d "$ANDROID_HOME/platform-tools" ]]; then
    echo "$(basename "$0"): platform-tools not found. Please run --install-platform-tools first." >&2
    exit 1
  fi

  local adb_path="$ANDROID_HOME/platform-tools/adb"
  if [[ ! -f "${adb_path}" ]]; then
    echo "$(basename "$0"): adb not found. Please run --install-platform-tools first." >&2
    exit 1
  fi

  echo "Starting AVD '$1'..."
  nohup "${emulator_path}" -avd "$1" -no-snapshot-load &> /dev/null &

  echo ""
  echo "To debug emulator issues, run this command:"
  echo "  ${emulator_path} -avd '$1' -no-snapshot-load -verbose -show-kernel -no-audio"
  echo ""

  echo "Waiting for device to connect (timeout: 120s)..."
  if ! timeout 120 "${adb_path}" wait-for-device; then
    echo "$(basename "$0"): Timeout waiting for device to connect" >&2
    echo "The emulator may still be starting. Check with: ${adb_path} devices" >&2
    echo "Or debug with the command shown above" >&2
    exit 1
  fi
  echo "Device connected."
  "${adb_path}" devices -l
}

stop_avd() {
  ensure_dependencies
  require adb grep awk tr

  local avd_name_to_stop="$1"
  local adb_path="$ANDROID_HOME/platform-tools/adb"

  echo "Attempting to stop AVD '$avd_name_to_stop'..."

  # Get serial numbers of all online emulator devices
  local device_serials
  device_serials=$("${adb_path}" devices | grep "emulator-" | awk '{print $1}')

  if [[ -z "$device_serials" ]]; then
    echo "No running emulators found."
    return 0
  fi

  local found_avd=false
  for serial in $device_serials; do
    # Get the AVD name for the current device and trim whitespace/carriage returns
    local running_avd_name
    running_avd_name=$("${adb_path}" -s "$serial" shell getprop ro.boot.qemu.avd_name | tr -d '[:space:]')

    if [[ "$running_avd_name" == "$avd_name_to_stop" ]]; then
      echo "Found running AVD '$avd_name_to_stop' on device '$serial'. Stopping it..."
      "${adb_path}" -s "$serial" emu kill
      echo "AVD '$avd_name_to_stop' stopped."
      found_avd=true
      break # Stop after finding and killing the first match
    fi
  done

  if [[ "$found_avd" == false ]]; then
    echo "AVD '$avd_name_to_stop' is not currently running."
  fi
}

delete_avd() {
  ensure_dependencies
  require avdmanager
  local avdmanager_path="$ANDROID_HOME/cmdline-tools/latest/bin/avdmanager"
  echo "Deleting AVD '$1'..."
  "${avdmanager_path}" delete avd -n "$1"
}

list_avds() {
  ensure_dependencies
  require emulator adb grep awk tr

  local emulator_path="$ANDROID_HOME/emulator/emulator"
  local adb_path="$ANDROID_HOME/platform-tools/adb"

  # Get all available AVDs
  local all_avds
  all_avds=$("${emulator_path}" -list-avds)

  # Get the names of all running AVDs
  local running_avd_names=()
  local device_serials
  device_serials=$("${adb_path}" devices | grep "emulator-" | awk '{print $1}')

  if [[ -n "$device_serials" ]]; then
    for serial in $device_serials; do
      local avd_name
      avd_name=$("${adb_path}" -s "$serial" shell getprop ro.boot.qemu.avd_name | tr -d '[:space:]')
      if [[ -n "$avd_name" ]]; then
        running_avd_names+=("$avd_name")
      fi
    done
  fi

  # Print the list, marking running AVDs
  echo "$all_avds" | while IFS= read -r avd; do
    local is_running=false
    for running_avd in "${running_avd_names[@]}"; do
      if [[ "$avd" == "$running_avd" ]]; then
        is_running=true
        break
      fi
    done

    if [[ "$is_running" == true ]]; then
      echo "* $avd"
    else
      echo "  $avd"
    fi
  done
}

list_images() {
  ensure_dependencies
  require sdkmanager grep awk cut uname sed tr sort uniq

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"

  # Determine host architecture for filtering
  local arch_filter
  arch_filter=$(get_host_arch)

  # Get all available system images and installed packages
  local all_packages_raw
  all_packages_raw=$("$sdkmanager" --list)
  local installed_packages
  installed_packages=$("$sdkmanager" --list_installed | awk -F'|' '{print $1}' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

  (echo "$all_packages_raw" | grep "system-images;android-" | grep "$arch_filter" | while IFS= read -r line; do
    # Extract package path and trim whitespace
    local package_path
    package_path=$(echo "$line" | awk -F'|' '{print $1}' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')

    # Extract API level
    local api_level
    api_level=$(echo "$package_path" | awk -F';' '{print $2}' | cut -d'-' -f2)

    # Check if API level is a number and greater than or equal to 33
    if [[ "$api_level" =~ ^[0-9]+$ ]] && [[ "$api_level" -ge 33 ]]; then
      # Check if the package is installed
      if echo "$installed_packages" | grep -q -x "$package_path"; then
        echo "* $package_path"
      else
        echo "  $package_path"
      fi
    fi
  done) | sort | uniq
}

check_updates() {
  ensure_dependencies
  require sdkmanager

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"

  echo "Checking for updates to installed packages..."
  echo ""
  "${sdkmanager}" --list | grep -A 1000 "Updates" || echo "All packages are up to date."
}

upgrade_packages() {
  ensure_dependencies
  require sdkmanager yes

  local sdkmanager="$ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager"

  echo "Upgrading all installed packages..."
  yes | "${sdkmanager}" --licenses > /dev/null

  if ! "${sdkmanager}" --update; then
    echo "$(basename "$0"): Failed to update packages" >&2
    echo "Try running manually: ${sdkmanager} --update" >&2
    exit 1
  fi

  echo "All packages upgraded successfully."
}

ensure_dependencies() {
  install_cli_tools
  install_platform_tools
  install_build_tools
  install_platforms
  install_emulator
}

case "$1" in
  install-dependencies)
    ensure_dependencies
    ;;
  list)
    list_avds
    ;;
  images)
    list_images
    ;;
  check-updates)
    check_updates
    ;;
  upgrade)
    upgrade_packages
    ;;
  create)
    if [[ -z "$2" ]]; then echo "Usage: $(basename "$0") create <name> [image]" >&2; exit 1; fi
    create_avd "$2" "$3"
    ;;
  start)
    if [[ -z "$2" ]]; then echo "Usage: $(basename "$0") start <name>" >&2; exit 1; fi
    start_avd "$2"
    ;;
  stop)
    if [[ -z "$2" ]]; then echo "Usage: $(basename "$0") stop <name>" >&2; exit 1; fi
    stop_avd "$2"
    ;;
  delete)
    if [[ -z "$2" ]]; then echo "Usage: $(basename "$0") delete <name>" >&2; exit 1; fi
    delete_avd "$2"
    ;;
  *)
    echo "$(basename "$0"): unknown command '$1'" >&2
    usage
    ;;
esac