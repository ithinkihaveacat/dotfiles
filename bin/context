#!/usr/bin/env bash

# context - Generate combined repomix context for various topics
#
# This script provides a unified interface for generating context from
# documentation, source code, and other materials across multiple topics.
# Each topic is defined declaratively with a simple, human-readable format.

set -e

SCRIPT_NAME=$(basename "$0")

# =============================================================================
# TOPIC DEFINITIONS
# =============================================================================
# Each topic is defined using a simple declarative format:
#
#   # Description comment
#   github OWNER/REPO [BRANCH]     Download a GitHub repository
#   url URL [-> DEST]              Download a URL to a file
#   copy SOURCE DEST [FILTER]      Copy from downloaded repo to output
#   include PATTERN                Glob pattern for repomix --include
#   ignore PATTERN                 Glob pattern for repomix --ignore
#
# Sources are tagged with their origin for traceability.
# =============================================================================

define_topic_gemini_api() {
  cat <<'TOPIC'
# Gemini API documentation and examples from Google
github google-gemini/cookbook
copy google-gemini/cookbook/examples/Book_illustration.ipynb notebooks/ ipynb-images
copy google-gemini/cookbook/quickstarts/Image_out.ipynb notebooks/ ipynb-images
url https://ai.google.dev/gemini-api/docs/image-generation.md.txt -> image-generation.md
url https://ai.google.dev/gemini-api/docs/image-understanding.md.txt -> image-understanding.md
url https://ai.google.dev/gemini-api/docs/models.md.txt -> models.md
url https://ai.google.dev/gemini-api/docs/prompting-strategies.md.txt -> prompting-strategies.md
url https://ai.google.dev/gemini-api/docs/structured-output.md.txt -> structured-output.md
url https://ai.google.dev/gemini-api/docs/text-generation.md.txt -> text-generation.md
include **
TOPIC
}

define_topic_gemini_sdk() {
  cat <<'TOPIC'
# Google Gemini TypeScript/JavaScript SDK source code
github googleapis/js-genai
copy googleapis/js-genai/src js-genai-src
include **
TOPIC
}

define_topic_mcp_server() {
  cat <<'TOPIC'
# Model Context Protocol server documentation and specification
github modelcontextprotocol/modelcontextprotocol
copy modelcontextprotocol/modelcontextprotocol/docs/docs/learn/server-concepts.mdx docs/
copy modelcontextprotocol/modelcontextprotocol/docs/docs/learn/architecture.mdx docs/
copy modelcontextprotocol/modelcontextprotocol/docs/specification/2025-11-25 specification/
include docs/*.mdx,specification/**
TOPIC
}

define_topic_mcp_typescript_sdk() {
  cat <<'TOPIC'
# Model Context Protocol TypeScript SDK documentation
github modelcontextprotocol/typescript-sdk
copy modelcontextprotocol/typescript-sdk/README.md .
include README.md
TOPIC
}

define_topic_gemini_cli() {
  cat <<'TOPIC'
# Gemini CLI documentation (all docs)
github google-gemini/gemini-cli
copy google-gemini/gemini-cli/docs docs
include docs/**/*.md
TOPIC
}

define_topic_gemini_cli_extensions() {
  cat <<'TOPIC'
# Gemini CLI extensions documentation
github google-gemini/gemini-cli
copy google-gemini/gemini-cli/docs/extensions extensions
include extensions/*.md
TOPIC
}

define_topic_gemini_cli_hooks() {
  cat <<'TOPIC'
# Gemini CLI hooks documentation
github google-gemini/gemini-cli
copy google-gemini/gemini-cli/docs/hooks hooks
include hooks/*.md
TOPIC
}

define_topic_inkyframe() {
  cat <<'TOPIC'
# Pimoroni Inky Frame documentation and examples
github pimoroni/inky-frame
copy pimoroni/inky-frame/docs inky-frame/docs
copy pimoroni/inky-frame/examples inky-frame/examples
copy pimoroni/inky-frame/modules inky-frame/modules
github pimoroni/pimoroni-pico
copy pimoroni/pimoroni-pico/micropython/modules/picographics pico/picographics
url https://docs.micropython.org/en/latest/_sources/reference/mpremote.rst.txt -> mpremote/mpremote.rst.txt
url https://r.jina.ai/https://learn.pimoroni.com/article/getting-started-with-inky-frame -> pimoroni-learn/getting-started-with-inky-frame.md
include **
TOPIC
}

define_topic_rpi() {
  cat <<'TOPIC'
# Raspberry Pi documentation
github raspberrypi/documentation master
copy raspberrypi/documentation/documentation .
include **/*.adoc
ignore **/accessories/**,**/accessibility.adoc,**/ai/**,**/camera/**,**/compute-module/**,**/display-parallel-interface.adoc,**/gpio-pad-controls.adoc,**/graphics-utilities.adoc,**/keyboard-computers/**,**/legacy_config_txt/**,**/linux_kernel/**,**/microcontrollers/**,**/playing-audio-and-video.adoc,**/processors/**,**/services/**,**/spi-bus-on-raspberry-pi.adoc,**/vnc.adoc
TOPIC
}

# =============================================================================
# AVAILABLE TOPICS
# =============================================================================

TOPICS=(
  "gemini-api:Gemini API documentation and examples"
  "gemini-sdk:Gemini TypeScript/JavaScript SDK"
  "mcp-server:MCP server documentation and specification"
  "mcp-typescript-sdk:MCP TypeScript SDK documentation"
  "gemini-cli:Gemini CLI documentation (all)"
  "gemini-cli-extensions:Gemini CLI extensions documentation"
  "gemini-cli-hooks:Gemini CLI hooks documentation"
  "inkyframe:Pimoroni Inky Frame documentation"
  "rpi:Raspberry Pi documentation"
)

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

require() {
  hash "$@" || {
    echo "$SCRIPT_NAME: command '$1' not found" >&2
    exit 127
  }
}

usage() {
  cat <<EOF
Usage: $SCRIPT_NAME <topic>

Generate combined repomix context for a specific topic. Output is written to
stdout and can be redirected to a file or piped to other commands.

Topics:
EOF
  for entry in "${TOPICS[@]}"; do
    name="${entry%%:*}"
    desc="${entry#*:}"
    printf "  %-22s %s\n" "$name" "$desc"
  done
  cat <<EOF

Options:
  -h, --help    Display this help message and exit
  --list        List available topics (names only)

Examples:
  $SCRIPT_NAME gemini-api
    Generate Gemini API context to stdout

  $SCRIPT_NAME gemini-api > gemini-api-context.txt
    Save context to a file

  $SCRIPT_NAME gemini-api | pbcopy
    Copy context to clipboard (macOS)
EOF
  exit 0
}

list_topics() {
  for entry in "${TOPICS[@]}"; do
    echo "${entry%%:*}"
  done
  exit 0
}

# Filter binary image data from Jupyter notebooks while preserving structure
filter_ipynb_images() {
  local input="$1"
  local output="$2"
  jq 'walk(if type == "object" and has("data") and (.data | type == "object") then
    .data |= with_entries(select(.key | test("^image/") | not))
    else . end) |
    walk(if type == "object" and has("outputs") then
    .outputs |= map(if .data then .data |= with_entries(select(.key | test("^image/") | not)) else . end)
    else . end)' "$input" > "$output"
}

# Download a GitHub repository archive
# Usage: download_github OWNER/REPO [BRANCH]
download_github() {
  local repo="$1"
  local branch="${2:-main}"
  local repo_slug="${repo//\//-}"
  local archive_name

  # GitHub uses different naming for the extracted directory
  if [[ "$branch" == "master" ]]; then
    archive_name="${repo##*/}-master"
  else
    archive_name="${repo##*/}-${branch}"
  fi

  local url="https://github.com/${repo}/archive/refs/heads/${branch}.zip"
  local zip_file="$BUILD_DIR/${repo_slug}.zip"
  local extract_dir="$BUILD_DIR/repos/${repo}"

  if [[ ! -d "$extract_dir" ]]; then
    curl -fsSL -o "$zip_file" "$url"
    mkdir -p "$extract_dir"
    unzip -o -q "$zip_file" -d "$BUILD_DIR/temp_extract"
    mv "$BUILD_DIR/temp_extract/$archive_name"/* "$extract_dir/" 2>/dev/null || true
    rm -rf "$BUILD_DIR/temp_extract"
  fi
}

# Download a URL to a destination
# Usage: download_url URL DEST
download_url() {
  local url="$1"
  local dest="$2"
  local dest_dir

  dest_dir=$(dirname "$MIX_DIR/$dest")
  mkdir -p "$dest_dir"

  # Add source comment header
  {
    echo "<!-- Source: $url -->"
    echo ""
    curl -fsSL "$url"
  } > "$MIX_DIR/$dest"
}

# Copy files from downloaded repo to mix directory
# Usage: copy_files SOURCE DEST [FILTER]
copy_files() {
  local source="$1"
  local dest="$2"
  local filter="${3:-}"
  local source_path="$BUILD_DIR/repos/$source"
  local dest_path="$MIX_DIR/$dest"

  mkdir -p "$dest_path"

  if [[ -f "$source_path" ]]; then
    # Source is a file
    if [[ "$filter" == "ipynb-images" ]]; then
      local basename
      basename=$(basename "$source_path")
      filter_ipynb_images "$source_path" "$dest_path/$basename"
    else
      cp "$source_path" "$dest_path/"
    fi
  elif [[ -d "$source_path" ]]; then
    # Source is a directory
    cp -R "$source_path"/* "$dest_path/" 2>/dev/null || cp -R "$source_path"/. "$dest_path/"
  else
    echo "$SCRIPT_NAME: warning: source not found: $source" >&2
  fi
}

# Process a topic definition
process_topic() {
  local topic="$1"
  local func_name="define_topic_${topic//-/_}"

  # Check if topic function exists
  if ! declare -f "$func_name" > /dev/null 2>&1; then
    echo "$SCRIPT_NAME: unknown topic: $topic" >&2
    echo "Run '$SCRIPT_NAME --list' to see available topics" >&2
    exit 1
  fi

  local include_pattern=""
  local ignore_pattern=""

  # Parse and execute topic definition
  while IFS= read -r line || [[ -n "$line" ]]; do
    # Skip empty lines and comments
    [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue

    # Parse line
    local cmd
    cmd=$(echo "$line" | awk '{print $1}')

    case "$cmd" in
      github)
        local repo branch
        repo=$(echo "$line" | awk '{print $2}')
        branch=$(echo "$line" | awk '{print $3}')
        branch="${branch:-main}"
        download_github "$repo" "$branch"
        ;;
      url)
        local url dest
        # Handle "url URL -> DEST" format
        if [[ "$line" =~ -\> ]]; then
          url=$(echo "$line" | awk '{print $2}')
          dest=$(echo "$line" | awk '{print $4}')
        else
          url=$(echo "$line" | awk '{print $2}')
          dest=$(basename "$url")
        fi
        download_url "$url" "$dest"
        ;;
      copy)
        local source dest filter
        source=$(echo "$line" | awk '{print $2}')
        dest=$(echo "$line" | awk '{print $3}')
        filter=$(echo "$line" | awk '{print $4}')
        copy_files "$source" "$dest" "$filter"
        ;;
      include)
        include_pattern=$(echo "$line" | cut -d' ' -f2-)
        ;;
      ignore)
        ignore_pattern=$(echo "$line" | cut -d' ' -f2-)
        ;;
    esac
  done < <("$func_name")

  # Build repomix command
  local repomix_args=("$MIX_DIR" "--no-security-check" "--quiet" "-o" "-")

  if [[ -n "$include_pattern" ]]; then
    repomix_args+=("--include=$include_pattern")
  fi

  if [[ -n "$ignore_pattern" ]]; then
    repomix_args+=("--ignore=$ignore_pattern")
  fi

  repomix "${repomix_args[@]}"
}

# =============================================================================
# MAIN
# =============================================================================

# Parse arguments
if [[ $# -lt 1 ]]; then
  usage
fi

case "$1" in
  -h|--help)
    usage
    ;;
  --list)
    list_topics
    ;;
  -*)
    echo "$SCRIPT_NAME: unknown option: $1" >&2
    exit 1
    ;;
  *)
    TOPIC="$1"
    ;;
esac

# Check dependencies only when actually processing a topic
require curl
require unzip
require repomix
require jq

# Create build directory
BUILD_DIR=$(mktemp -d)
MIX_DIR="$BUILD_DIR/mix"
mkdir -p "$MIX_DIR" "$BUILD_DIR/repos"
trap 'rm -rf "$BUILD_DIR"' EXIT

# Process the topic
process_topic "$TOPIC"
