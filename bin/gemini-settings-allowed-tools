#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] COMMAND [COMMAND...]

Adds one or more commands to the Gemini allowed tools whitelist.
These commands can then be executed by the 'run_shell_command' tool.

Arguments:
  COMMAND         The shell command to allow. Can be a simple command (e.g., 'git')
                  or a command with arguments (e.g., './gradlew installDebug').

Options:
  -h, --help      Display this help message and exit
  --output FILE   Specify the settings file to update
                  (default: $HOME/.gemini/settings.json)

Examples:
  $(basename "$0") git
  $(basename "$0") "ls -la" "grep -r pattern ."
  $(basename "$0") ./gradlew
EOF
  exit 0
}

require() {
  hash "$@" || {
    echo "$(basename "$0"): $1: command not found" >&2
    exit 127
  }
}

SETTINGS_FILE="$HOME/.gemini/settings.json"

# Parse arguments
REMAINING_ARGS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h | --help)
      usage
      ;;
    --output)
      if [[ -z "${2:-}" ]]; then
        echo "$(basename "$0"): option '--output' requires an argument" >&2
        exit 1
      fi
      SETTINGS_FILE="$2"
      shift 2
      ;;
    *)
      REMAINING_ARGS+=("$1")
      shift
      ;;
  esac
done
set -- "${REMAINING_ARGS[@]}"

if [[ $# -eq 0 ]]; then
  usage
fi

require jq

# Cleanup function to remove temporary files
cleanup() {
  if [[ -n "${TMP_FILE:-}" && -f "$TMP_FILE" ]]; then
    rm -f "$TMP_FILE"
  fi
}
trap cleanup EXIT

# Ensure the settings directory exists
mkdir -p "$(dirname "$SETTINGS_FILE")"

# Ensure the settings file exists and is valid JSON
if [[ ! -f "$SETTINGS_FILE" ]]; then
  echo "{}" >"$SETTINGS_FILE"
fi

# Construct the JSON array of new commands
# We iterate over arguments and wrap them in run_shell_command()
# We use jq to safely construct the JSON array string to avoid injection/escaping issues
NEW_CMDS_JSON=$(jq -n '$ARGS.positional | map("run_shell_command(" + . + ")")' --args "$@")

# Create a temporary file
TMP_FILE=$(mktemp)

# Update the settings
# 1. Read existing settings
# 2. Ensure .tools object exists
# 3. Append new commands to .tools.allowed (initializing if null)
# 4. Remove duplicates with unique
jq --argjson new "$NEW_CMDS_JSON" \
  '.tools |= (. // {}) | .tools.allowed |= ((. // []) + $new | unique)' \
  "$SETTINGS_FILE" >"$TMP_FILE"

mv "$TMP_FILE" "$SETTINGS_FILE"

echo "Updated $SETTINGS_FILE. Allowed tools list now includes:"
echo "$NEW_CMDS_JSON" | jq -r '.[] | "  - " + .'
