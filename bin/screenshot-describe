#!/bin/bash

set -euo pipefail

IMAGE_PATH="$1"
DEFAULT_PROMPT="Generate concise alt text (around 200 chars) describing the *content* of this screenshot. Do not describe the physical device, its shape (e.g., circular), or type (e.g., smartwatch). Focus on key UI elements, text, colors, and layout differences to distinguish it from similar screen captures."
PROMPT="${2:-${DEFAULT_PROMPT}}"
API_KEY="${GEMINI_API_KEY:?API key not set. Please set the GEMINI_API_KEY environment variable}"
MODEL="gemini-3-flash-preview"
URL="https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}"

if [ ! -f "$IMAGE_PATH" ]; then
  echo "Error: Image file not found: $IMAGE_PATH" >&2
  exit 1
fi

MIME_TYPE=$(file -b --mime-type "$IMAGE_PATH")
if [[ "$MIME_TYPE" != "image/jpeg" && "$MIME_TYPE" != "image/png" && "$MIME_TYPE" != "image/gif" && "$MIME_TYPE" != "image/webp" ]]; then
  echo "Error: Unsupported image type: $MIME_TYPE" >&2
  echo "Supported types are: image/jpeg, image/png, image/gif, image/webp" >&2
  exit 1
fi

IMAGE_BASE64=$(base64 -w 0 "$IMAGE_PATH")

REQUEST_BODY=$(cat <<EOF
{
  "contents": [
    {
      "parts": [
        {"text": "${PROMPT}"},
        {
          "inlineData": {
            "mimeType": "${MIME_TYPE}",
            "data": "${IMAGE_BASE64}"
          }
        }
      ]
    }
  ]
}
EOF
)

curl -s -X POST \
  -H "Content-Type: application/json" \
  -d "${REQUEST_BODY}" \
  "${URL}" | jq -r '.candidates[0].content.parts[0].text'
