#!/usr/bin/env bash

set -euo pipefail

usage() {
  cat <<EOF
Usage: $(basename "$0") IMAGE [PROMPT]

Generate a text description of a screenshot using the Gemini API. Optimized for
screenshots and UI captures; the default prompt focuses on UI elements, text,
colors, and layout.

Arguments:
  IMAGE       Path to a screenshot (any format supported by ImageMagick)
  PROMPT      Custom prompt for the AI model (optional)

Options:
  -h, --help  Display this help message and exit

Environment Variables:
  GEMINI_API_KEY  Required. Your Gemini API key.

Examples:
  $(basename "$0") screenshot.png
  $(basename "$0") screen-capture.png "What objects are in this image?"
  $(basename "$0") ui-mockup.png "List all UI elements visible"
EOF
  exit 0
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
fi

require() { hash "$@" || exit 127; }

require curl
require jq
require base64
require magick

if [[ $# -lt 1 ]]; then
  usage
fi

IMAGE_PATH="$1"
DEFAULT_PROMPT="Generate concise alt text (up to 300 chars) describing the *content* of this screenshot. Do not describe the physical device, its shape (e.g., circular), or type (e.g., smartwatch). Focus on key UI elements, text, colors, margins, and layout differences to distinguish it from similar screen captures."
PROMPT="${2:-${DEFAULT_PROMPT}}"

if [[ -z "${GEMINI_API_KEY:-}" ]]; then
  echo "$(basename "$0"): GEMINI_API_KEY environment variable not set" >&2
  exit 1
fi

MODEL="gemini-3-flash-preview"
#MODEL="gemini-2.5-flash"
URL="https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent"

if [[ ! -f "$IMAGE_PATH" ]]; then
  echo "$(basename "$0"): $IMAGE_PATH: No such file or directory" >&2
  exit 1
fi

# Convert to lossless webp and base64 encode
# base64: macOS uses -b 0, Linux uses -w 0
if base64 --help 2>&1 | grep -q -- '-w'; then
  IMAGE_BASE64=$(magick "$IMAGE_PATH" -alpha off -define webp:lossless=true webp:- | base64 -w 0)
else
  IMAGE_BASE64=$(magick "$IMAGE_PATH" -alpha off -define webp:lossless=true webp:- | base64 -b 0)
fi

# Image before text for single-image prompts per:
# https://ai.google.dev/gemini-api/docs/image-understanding
REQUEST_BODY=$(
  cat <<EOF
{
  "contents": [
    {
      "parts": [
        {
          "inlineData": {
            "mimeType": "image/webp",
            "data": "${IMAGE_BASE64}"
          }
        },
        {"text": "${PROMPT}"}
      ]
    }
  ],
  "generationConfig": {
    "thinkingConfig": {
      "thinkingLevel": "low"
    }
  }
}
EOF
)

RESPONSE=$(echo "${REQUEST_BODY}" | curl -s -X POST \
  -H "x-goog-api-key: $GEMINI_API_KEY" \
  -H "Content-Type: application/json" \
  -d @- \
  "${URL}")

# Check for API errors
if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
  ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"')
  echo "$(basename "$0"): API error: $ERROR_MSG" >&2
  exit 1
fi

# Extract and output the text response
TEXT=$(echo "$RESPONSE" | jq -r '.candidates[0].content.parts[0].text // empty')
if [[ -z "$TEXT" ]]; then
  echo "$(basename "$0"): no response text received from API" >&2
  exit 1
fi

echo "$TEXT"
