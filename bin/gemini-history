#!/bin/bash

# gemini-history: specific script to list user questions from the latest gemini-cli session for a given directory.

# Check if directory argument is provided
if [ -z "$1" ]; then
  echo "Error: Please provide a directory."
  echo "Usage: $0 <directory>"
  exit 1
fi

# Get absolute path
TARGET_DIR=$(realpath "$1")

# Check if the target directory itself exists
if [ ! -d "$TARGET_DIR" ]; then
    echo "Error: Directory '$TARGET_DIR' does not exist."
    exit 1
fi

# Generate SHA256 hash of the absolute path
# We use openssl dgst -sha256 and extract the last field of the output
HASH=$(echo -n "$TARGET_DIR" | sha256 -q)

# Construct path to the gemini temp directory
GEMINI_TMP="$HOME/.gemini/tmp/$HASH"
CHATS_DIR="$GEMINI_TMP/chats"

# Check if the gemini temp directory exists for this project
if [ ! -d "$GEMINI_TMP" ]; then
  echo "Error: No Gemini history found for directory: $TARGET_DIR"
  echo "Expected location: $GEMINI_TMP"
  exit 1
fi

# Check if chats subdirectory exists
if [ ! -d "$CHATS_DIR" ]; then
  echo "Error: No 'chats' subdirectory found in: $GEMINI_TMP"
  exit 1
fi

# Find the most recently updated JSON file in the chats directory
LATEST_CHAT=$(find "$CHATS_DIR" -maxdepth 1 -type f -name "*.json" -exec stat -f "%m %N" {} + 2>/dev/null | sort -nr | head -n 1 | cut -f2- -d' ')

if [ -z "$LATEST_CHAT" ]; then
  echo "No chat history found in $CHATS_DIR"
  exit 1
fi

# Extract user messages using jq and format them
# We select messages where type is "user", verify they have content, and format as markdown list items.
# We add a newline after each item so 'fmt' treats them as separate paragraphs.
jq -r '[.messages[] | select(.type == "user") | .content | split("\n--- Content from referenced files ---")[0]] | join("\n\n---\n\n")' "$LATEST_CHAT" | fmt -w 80
