#!/bin/bash
set -eo pipefail

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] DIRECTORY

Lists user questions from the latest gemini-cli session for a given directory.

Arguments:
  DIRECTORY         The directory to look up history for.

Options:
  --dir             Output the directory where history is stored and exit
  -h, --help        Display this help message and exit

Examples:
  # List history for the current directory
  $(basename "$0") .

  # Show the history directory path
  $(basename "$0") --dir .
EOF
  exit 0
}

POSITIONAL_ARGS=()
SHOW_DIR=false

while [[ $# -gt 0 ]]; do
  case $1 in
    -h | --help)
      usage
      ;;
    --dir)
      SHOW_DIR=true
      shift
      ;;
    -*)
      echo "Unknown option $1"
      exit 1
      ;;
    *)
      POSITIONAL_ARGS+=("$1")
      shift
      ;;
  esac
done

set -- "${POSITIONAL_ARGS[@]}"

# Check if directory argument is provided
if [ -z "$1" ]; then
  usage
fi

# Get absolute path
TARGET_DIR=$(realpath "$1")

# Check if the target directory itself exists
if [ ! -d "$TARGET_DIR" ]; then
  echo "Error: Directory '$TARGET_DIR' does not exist." >&2
  exit 1
fi

# Generate SHA256 hash of the absolute path
HASH=$(echo -n "$TARGET_DIR" | sha256 -q)

# Construct path to the gemini temp directory
GEMINI_TMP="$HOME/.gemini/tmp/$HASH"
CHATS_DIR="$GEMINI_TMP/chats"

if [ "$SHOW_DIR" = true ]; then
  echo "$GEMINI_TMP"
  exit 0
fi

# Check if the gemini temp directory exists for this project
if [ ! -d "$GEMINI_TMP" ]; then
  echo "Error: No Gemini history found for directory: $TARGET_DIR" >&2
  echo "Expected location: $GEMINI_TMP" >&2
  exit 1
fi

# Check if chats subdirectory exists
if [ ! -d "$CHATS_DIR" ]; then
  echo "Error: No 'chats' subdirectory found in: $GEMINI_TMP" >&2
  exit 1
fi

# Find the most recently updated JSON file in the chats directory
LATEST_CHAT=$(find "$CHATS_DIR" -maxdepth 1 -type f -name "*.json" -exec stat -f "%m %N" {} + 2>/dev/null | sort -nr | head -n 1 | cut -f2- -d' ')

if [ -z "$LATEST_CHAT" ]; then
  echo "No chat history found in $CHATS_DIR" >&2
  exit 1
fi

# Extract user messages using jq and format them
# We select messages where type is "user", verify they have content, and format as markdown list items.
# We add a newline after each item so 'fmt' treats them as separate paragraphs.
jq -r '[.messages[] | select(.type == "user") | (.content | if type == "array" then map(.text) | join("") else . end) | split("\n--- Content from referenced files ---")[0]] | join("\n\n---\n\n")' "$LATEST_CHAT" | fmt -w 80
