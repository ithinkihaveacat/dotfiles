#!/usr/bin/env bash

# Installs a specific version of Node.js to a given prefix directory.
# Based on https://github.com/wilmoore/nodejs-install

set -o errexit
set -o errtrace
set -o nounset

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] VERSION PREFIX
       $(basename "$0") --list

Downloads and installs a specific version of Node.js.

Arguments:
  VERSION     Node.js version to install (e.g., 22.13.1 or v22.13.1)
  PREFIX      Directory where Node.js will be installed.
              A subdirectory named node-vVERSION will be created.

Options:
  -l, --list  List all available Node.js versions
  -h, --help  Display this help message and exit

Examples:
  # Install Node.js 22.13.1 to \$HOME/nodejs-versions
  $(basename "$0") 22.13.1 \$HOME/nodejs-versions

  # List available versions
  $(basename "$0") --list
EOF
  exit 0
}

require() {
  for cmd in "$@"; do
    if ! command -v "$cmd" &>/dev/null; then
      echo "$(basename "$0"): '$cmd' command not found" >&2
      exit 127
    fi
  done
}

require curl tar

# Infer operating system identifier for Node.js downloads.
get_os() {
  uname | tr '[:upper:]' '[:lower:]'
}

# Infer architecture identifier for Node.js downloads.
get_arch() {
  local machine
  machine=$(uname -m)
  case "$machine" in
    x86_64)
      echo "x64"
      ;;
    aarch64 | arm64)
      echo "arm64"
      ;;
    armv7l)
      echo "armv7l"
      ;;
    *)
      echo "$(basename "$0"): unsupported architecture: $machine" >&2
      exit 1
      ;;
  esac
}

# Build platform identifier (e.g., linux-x64, darwin-arm64).
get_platform() {
  echo "$(get_os)-$(get_arch)"
}

# List all downloadable Node.js versions.
list_versions() {
  curl -fsSL https://nodejs.org/dist/ \
    | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' \
    | sort -t. -u -k 1.2,1n -k 2,2n -k 3,3n
}

# Check if a version is available for download.
# Returns 0 if available, 1 if not.
is_version_available() {
  local version="$1"
  list_versions | grep -qw "v${version}"
}

# Handle --help and --list before checking argument count
case "${1:-}" in
  -h | --help)
    usage
    ;;
  -l | --list)
    list_versions
    exit 0
    ;;
esac

# Require at least 2 arguments for installation
if [[ $# -lt 2 ]]; then
  echo "$(basename "$0"): VERSION and PREFIX arguments required" >&2
  echo "Try '$(basename "$0") --help' for more information." >&2
  exit 1
fi

# Parse positional arguments
VERSION=$(echo "$1" | tr -d 'vV')
PREFIX="$2"
TARGET="$PREFIX/node-v$VERSION"
BINDIR="$TARGET/bin"

# Validate version
if ! is_version_available "$VERSION"; then
  echo "$(basename "$0"): Node.js version $VERSION is not available" >&2
  echo "Use '$(basename "$0") --list' to see available versions." >&2
  exit 1
fi

# Validate prefix
if [[ -z "$PREFIX" ]]; then
  echo "$(basename "$0"): PREFIX argument is required" >&2
  exit 1
fi

# Check for existing installation
if [[ -d "$TARGET" ]]; then
  echo "$(basename "$0"): '$TARGET' already exists" >&2
  exit 1
fi

# Build download URL
DOWNLOAD_URL="https://nodejs.org/dist/v$VERSION/node-v$VERSION-$(get_platform).tar.gz"

# Create target directory
mkdir -p "$TARGET"

# Clean up on failure
cleanup() {
  rm -rf "$TARGET"
}
trap cleanup EXIT

# Download and extract
echo "Downloading Node.js v$VERSION for $(get_platform)..."
curl -fL# "$DOWNLOAD_URL" | tar xz --strip-components=1 -C "$TARGET"

# Clear the trap on success
trap - EXIT

cat <<EOF

Node.js v$VERSION installed successfully.

Installation directory:
  $TARGET

Add the following to your PATH:
  $BINDIR
EOF
