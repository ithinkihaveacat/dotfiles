#!/usr/bin/env bash

# shellcheck disable=SC2002

usage() {
  cat <<EOF
Usage: $(basename "$0") URL

Downloads images from a specific gallery format.

Arguments:
  URL         The URL of the gallery to download.

Options:
  --help      Display this help message and exit

Examples:
  $(basename "$0") https://example.com/gallery/123
EOF
  exit 0
}

if [[ "$1" == "--help" ]]; then
  usage
fi

if [ -z "$1" ]; then
  usage 1 >&2
fi

require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo >&2 "$(basename "$0"): $1 not found"
    exit 127
  }
}

require url-cat-dom
require jq
require wget
require sed
require json_pp

URL="$1"
NAME=$(basename "$1")

mkdir "$NAME" || exit

pushd "$NAME" || exit

echo "$URL" >URL.txt

url-cat-dom "$URL" >"index.html"

cat "index.html" | sed -n 's/.*<script id="__NEXT_DATA__" type="application\/json">\([^<]*\)<\/script>.*/\1/p' | json_pp >"index.json"

cat "index.json" | jq -r ".props .pageProps .gallery .[] .imageRetina" >"images.txt"

while IFS= read -r url; do
  wget "$url"
done <images.txt

popd || exit
