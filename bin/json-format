#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") [FILE]

Format a JSON file using jq.

When FILE is provided, the file is formatted in place. When no FILE is
provided, reads from standard input and writes to standard output.

Arguments:
  FILE        Path to a JSON file to format (optional)

Options:
  -h, --help  Display this help message and exit

Examples:

# Format a file in place

  $(basename "$0") config.json

# Format from stdin to stdout

  curl -s <https://api.example.com/data> | $(basename "$0")

# Format a file and see the result

  $(basename "$0") < data.json
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

if [[ $# -gt 1 ]]; then
  echo "$(basename "$0"): too many arguments" >&2
  exit 1
fi

if [[ $# -eq 0 && -t 0 ]]; then
  usage
fi

# Determine which formatter to use

if ! command -v jq >/dev/null 2>&1; then
  echo "$(basename "$0"): jq not found" >&2
  exit 127
fi

FORMAT_CMD="jq ."

if [[ $# -eq 0 ]]; then

# Read from stdin, write to stdout

  $FORMAT_CMD
else

# Format file in place

  if [[ ! -f "$1" ]]; then
    echo "$(basename "$0"): $1: No such file or directory" >&2
    exit 1
  fi
  TMPFILE=$(mktemp)
  trap 'rm -f -- "$TMPFILE"' EXIT
  if $FORMAT_CMD < "$1" > "$TMPFILE"; then
    cat "$TMPFILE" > "$1"
    echo "$(basename "$0"): $1: formatted"
  else
    echo "$(basename "$0"): $1: failed to format" >&2
    exit 1
  fi
fi
