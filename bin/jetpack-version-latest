#!/bin/bash
#
# Gets the latest version for a given Jetpack package.
#
# Usage:
#   jetpack-version-latest <package_name> [repo_url]
#
# Example:
#   jetpack-version-latest androidx.wear.tiles:tiles
#   jetpack-version-latest com.google.android.horologist:horologist-datalayer https://repo1.maven.org/maven2
#

set -e

if [ "$#" -lt 1 ]; then
  echo "Usage: jetpack-version-latest <package_name> [repo_url]" >&2
  exit 1
fi

PACKAGE_NAME=$1
REPO_URL=${2:-"https://dl.google.com/android/maven2"}

GROUP_ID=$(echo "$PACKAGE_NAME" | cut -d: -f1)
ARTIFACT_ID=$(echo "$PACKAGE_NAME" | cut -d: -f2)
GROUP_ID_PATH=$(echo "$GROUP_ID" | sed 's/\./\//g')
METADATA_URL="$REPO_URL/$GROUP_ID_PATH/$ARTIFACT_ID/maven-metadata.xml"

LATEST_VERSION=$(curl -sSL "$METADATA_URL" |
  xmllint --xpath "//versioning/latest/text()" -)

if [[ -z "$LATEST_VERSION" ]]; then
  echo "error: could not determine latest version for $PACKAGE_NAME from $METADATA_URL" >&2
  exit 1
fi

echo "$LATEST_VERSION"
