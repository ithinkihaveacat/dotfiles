#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") KEYFILE_ZIP

Decode a Temporary Exposure Key (TEK) export zip file using protoc.

Arguments:
  KEYFILE_ZIP  The .zip file containing the export data.

Options:
  --help       Display this help message and exit

Examples:
  $(basename "$0") export.zip
EOF
  exit 0
}

if [[ "$1" == "--help" ]]; then
  usage
fi

if [[ $# -eq 0 ]]; then
  usage 1 >&2
fi

require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo >&2 "$(basename "$0"): $1 not found"
    exit 127
  }
}

require protoc
require unzip

unzip -p "$1" export.bin | tail +17c | protoc --decode TemporaryExposureKeyExport -I "$HOME/workspace/exposure-notifications-server/internal/pb/export" export.proto
