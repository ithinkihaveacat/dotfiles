#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] [FILE]

Dumps the UI hierarchy from an adb-connected device.

The hierarchy is saved to the specified file, or to a timestamped file in the
current directory if no file is specified.

Arguments:
  FILE              The path to save the hierarchy to.
                    (defaults to 'adb-uihierarchy-YYYYMMDDHHMMSS.xml')

Options:
  -o, --output FILE The path to save the hierarchy to.
  -h, --help        Display this help message and exit

Environment:
  ANDROID_SERIAL  Serial number of device to connect to (see 'adb devices -l').
                  To target a specific device, use:
                    env ANDROID_SERIAL=<serial> $(basename "$0")

Examples:
  # Save hierarchy to a timestamped file in the current directory
  $(basename "$0")

  # Save hierarchy to a specific file
  $(basename "$0") /tmp/my-hierarchy.xml

  # Save hierarchy to a specific file using the --output flag
  $(basename "$0") --output /tmp/my-hierarchy.xml
EOF
  exit 0
}

OUTPUT_FILE=""

# Manual parsing for --output, compatible with macOS getopt
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h | --help)
      usage
      ;;
    -o | --output)
      if [ -z "${2:-}" ]; then
        echo "$(basename "$0"): --output option requires an argument" >&2
        exit 1
      fi
      OUTPUT_FILE="$2"
      shift 2
      ;;
    *)
      if [ -n "$OUTPUT_FILE" ] && [ -n "$1" ]; then
         echo "$(basename "$0"): cannot specify both FILE and --output" >&2
         exit 1
      fi
      OUTPUT_FILE="$1"
      shift
      ;;
  esac
done

require() { hash "$@" || exit 127; }

require adb
require xmllint
require sed

# Check if device is available
if [ "$(adb get-state 2>/dev/null)" != "device" ]; then
  echo "error: no device connected" >&2
  exit 1
fi

if [ -z "$OUTPUT_FILE" ]; then
  OUTPUT_FILE=$(date -u +'adb-uihierarchy-%Y%m%d%H%M%S.xml')
fi

adb exec-out uiautomator dump /dev/stdout | 
  sed 's/UI hierchary dumped to: \/dev\/stdout//' | 
  xmllint --format - > "$OUTPUT_FILE"

echo "Saved to $OUTPUT_FILE"
