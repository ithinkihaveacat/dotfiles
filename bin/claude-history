#!/bin/bash
set -eo pipefail

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] DIRECTORY

Lists user questions from the latest claude-cli session for a given directory.

Arguments:
  DIRECTORY         The directory to look up history for.

Options:
  -h, --help        Display this help message and exit

Examples:
  # List history for the current directory
  $(basename "$0") .
EOF
  exit 0
}

if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
  usage
fi

# Check if directory argument is provided
if [ -z "$1" ]; then
  usage
fi

# Get absolute path
TARGET_DIR=$(realpath "$1")

# Check if the target directory itself exists
if [ ! -d "$TARGET_DIR" ]; then
  echo "Error: Directory '$TARGET_DIR' does not exist." >&2
  exit 1
fi

# Convert absolute path to Claude's slugified format (replace / with -)
SLUG=$(echo "$TARGET_DIR" | sed 's|^/||; s|/|-|g')

# Construct path to the Claude projects directory
CLAUDE_PROJECT="$HOME/.claude/projects/-$SLUG"

# Check if the Claude project directory exists for this directory
if [ ! -d "$CLAUDE_PROJECT" ]; then
  echo "Error: No Claude history found for directory: $TARGET_DIR" >&2
  echo "Expected location: $CLAUDE_PROJECT" >&2
  exit 1
fi

# Find the most recently updated JSONL file in the project directory
# Use ls -t for portable sorting by modification time (works on both Linux and macOS)
# shellcheck disable=SC2012  # Session IDs are UUIDs, safe for ls
LATEST_SESSION=$(ls -t "$CLAUDE_PROJECT"/*.jsonl 2>/dev/null | head -n 1)

if [ -z "$LATEST_SESSION" ]; then
  echo "No session history found in $CLAUDE_PROJECT" >&2
  exit 1
fi

# Extract user messages from JSONL format
# Each line is a JSON object; we select those with type="user" and string content
# (array content indicates tool results, not actual user prompts)
jq -rs '[.[] | select(.type == "user") | .message.content | select(type == "string")] | join("\n\n---\n\n")' "$LATEST_SESSION" | fmt -w 80
