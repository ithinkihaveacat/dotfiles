#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] ZIP_FILE

Unzips a file into a specified or temporary directory and prints the directory's path.

This script is useful for inspecting the contents of ZIP archives, such as
Android App Bundles (.aab) or split APKs.

Arguments:
  ZIP_FILE          Path to the ZIP file to unzip.

Options:
  -o, --output DIR  Path to the output directory
  -h, --help        Display this help message and exit

Examples:
  # Unzip to a temporary directory and list its contents
  UNZIPPED_PATH=$($(basename "$0") /path/to/your/archive.zip)
  ls "\$UNZIPPED_PATH"

  # Unzip to a specific directory
  $(basename "$0") --output /tmp/my-unzipped-archive /path/to/your/archive.zip
EOF
  exit 0
}

OUTPUT_PATH=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h | --help)
      usage
      ;;
    -o | --output)
      if [ -z "$2" ]; then
        echo "$(basename "$0"): --output option requires an argument" >&2
        exit 1
      fi
      OUTPUT_PATH="$2"
      shift 2
      ;;
    *)
      break
      ;;
  esac
done

require() { hash "$@" || exit 127; }

require unzip

if [ -z "$1" ]; then
  usage
fi

ZIP_FILE="$1"

if [ ! -f "$ZIP_FILE" ]; then
  echo "$(basename "$0"): $ZIP_FILE: No such file or directory" >&2
  exit 1
fi

if [ -z "$OUTPUT_PATH" ]; then
  OUTPUT_PATH=$(mktemp -d)
else
  # Ensure the target directory exists
  mkdir -p "$OUTPUT_PATH"
fi

# -o (overwrite existing without prompting) because APKs can contain files that differ only in case...
unzip -q -o "$ZIP_FILE" -d "$OUTPUT_PATH"

echo "$OUTPUT_PATH"
