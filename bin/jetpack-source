#!/bin/bash
#
# Downloads and extracts the source code for one or more Jetpack packages.
#

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] PACKAGE... [VERSION] [REPO_URL]

Download and extract source code for one or more Jetpack packages.

Arguments:
  PACKAGE     One or more package names in the format GROUP_ID:ARTIFACT_ID
              (supports brace expansion, e.g., androidx.pkg:{foo,bar})
  VERSION     Version string: ALPHA, BETA, RC, STABLE, LATEST, or a specific version number
              (optional, defaults to STABLE)
  REPO_URL    Maven repository URL (optional, default: https://dl.google.com/android/maven2)

Options:
  -h, --help  Display this help message and exit
  --output DIR  Specify output directory (default: create temporary directory)

Examples:
  $(basename "$0") androidx.wear.tiles:tiles
  $(basename "$0") androidx.wear.tiles:tiles STABLE
  $(basename "$0") androidx.wear.tiles:tiles ALPHA
  $(basename "$0") androidx.wear.tiles:tiles RC
  $(basename "$0") androidx.wear.protolayout:protolayout-{expression,material,material3}
  $(basename "$0") com.google.android.horologist:horologist-datalayer STABLE https://repo1.maven.org/maven2
  $(basename "$0") --output /tmp/wear-tiles androidx.wear.tiles:tiles BETA
  pushd "\$($(basename "$0") androidx.wear.tiles:tiles)"

The script creates a temporary directory, downloads the source JARs for the specified
packages, extracts them, and prints the path to the temporary directory.

For Kotlin Multiplatform libraries, the script automatically detects and downloads
platform-specific sources (e.g., -jvm, -android variants) in addition to common sources,
ensuring complete source code coverage for all platforms.
EOF
  exit 0
}

set -e

OUTPUT_DIR=""
REMAINING_ARGS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h | --help)
      usage
      ;;
    --output)
      if [ -z "$2" ]; then
        echo "$(basename "$0"): option '--output' requires an argument" >&2
        exit 1
      fi
      OUTPUT_DIR="$2"
      shift 2
      ;;
    *)
      REMAINING_ARGS+=("$1")
      shift
      ;;
  esac
done
set -- "${REMAINING_ARGS[@]}" # Overwrite the original positional arguments

if [ "$#" -lt 1 ]; then
  echo "$(basename "$0"): missing operand" >&2
  exit 1
fi

require() {
  hash "$@" || {
    echo "Error: Command '$1' not found." >&2
    exit 127
  }
}

require curl
require jar
require jetpack-version

# Parse arguments: PACKAGE... [VERSION] [REPO_URL]
# Last argument is a URL -> it's REPO_URL
# Last non-URL argument doesn't contain ':' -> it's VERSION
# Arguments with ':' are PACKAGES
if [[ "${!#}" =~ ^https?:// ]]; then
  REPO_URL="${!#}"
  LAST_NON_URL_ARG="${*: -2:1}"
  if [[ ! "$LAST_NON_URL_ARG" =~ : ]]; then
    VERSION_STRING="$LAST_NON_URL_ARG"
    PACKAGES=("${@:1:$#-2}")
  else
    VERSION_STRING="STABLE"
    PACKAGES=("${@:1:$#-1}")
  fi
else
  REPO_URL="https://dl.google.com/android/maven2"
  LAST_ARG="${!#}"
  if [[ ! "$LAST_ARG" =~ : ]]; then
    VERSION_STRING="$LAST_ARG"
    PACKAGES=("${@:1:$#-1}")
  else
    VERSION_STRING="STABLE"
    PACKAGES=("$@")
  fi
fi

VERSION_STRING_UPPER=$(echo "$VERSION_STRING" | tr '[:lower:]' '[:upper:]')

# Check that at least one package was specified
if [ "${#PACKAGES[@]}" -eq 0 ]; then
  echo "$(basename "$0"): no packages specified (did you mean to include a package name with GROUP_ID:ARTIFACT_ID?)" >&2
  exit 1
fi

# Validate all packages before creating directories or downloading
for PACKAGE_NAME in "${PACKAGES[@]}"; do
  # Validate package name format
  if [[ ! "$PACKAGE_NAME" =~ ^[^:]+:[^:]+$ ]]; then
    echo "$(basename "$0"): invalid package format '$PACKAGE_NAME' (expected GROUP_ID:ARTIFACT_ID)" >&2
    exit 1
  fi

  # Validate that package exists by checking maven-metadata.xml
  GROUP_ID=$(echo "$PACKAGE_NAME" | cut -d: -f1)
  ARTIFACT_ID=$(echo "$PACKAGE_NAME" | cut -d: -f2)
  GROUP_ID_PATH=$(echo "$GROUP_ID" | sed 's/\./\//g')
  METADATA_URL="${REPO_URL}/${GROUP_ID_PATH}/${ARTIFACT_ID}/maven-metadata.xml"

  if ! curl -sSLf "$METADATA_URL" >/dev/null 2>&1; then
    echo "$(basename "$0"): failed to fetch $METADATA_URL" >&2
    exit 1
  fi
done

# Create output directory
if [ -n "$OUTPUT_DIR" ]; then
  BUILD_DIR="$OUTPUT_DIR"
  mkdir -p "$BUILD_DIR"
else
  BUILD_DIR=$(mktemp -d)
fi

# Download and extract each package
for PACKAGE_NAME in "${PACKAGES[@]}"; do
  GROUP_ID=$(echo "$PACKAGE_NAME" | cut -d: -f1)
  ARTIFACT_ID=$(echo "$PACKAGE_NAME" | cut -d: -f2)
  GROUP_ID_PATH=$(echo "$GROUP_ID" | sed 's/\./\//g')

  # Resolve version (use the first package to resolve ALPHA/BETA/RC/STABLE/LATEST)
  if [ -z "$VERSION" ]; then
    if [ "$VERSION_STRING_UPPER" == "ALPHA" ] || [ "$VERSION_STRING_UPPER" == "BETA" ] || [ "$VERSION_STRING_UPPER" == "RC" ] || [ "$VERSION_STRING_UPPER" == "STABLE" ] || [ "$VERSION_STRING_UPPER" == "LATEST" ]; then
      VERSION=$(jetpack-version "${PACKAGE_NAME}" "$VERSION_STRING_UPPER" "$REPO_URL")
      echo "info: Resolved $VERSION_STRING_UPPER version for ${PACKAGE_NAME} to ${VERSION}" >&2
    else
      VERSION=$VERSION_STRING
    fi
  fi
  SOURCE_JAR_URL="${REPO_URL}/${GROUP_ID_PATH}/${ARTIFACT_ID}/${VERSION}/${ARTIFACT_ID}-${VERSION}-sources.jar"
  SOURCE_JAR_FILENAME="${ARTIFACT_ID}-${VERSION}-sources.jar"

  echo "info: Downloading ${PACKAGE_NAME} version ${VERSION}" >&2
  if ! curl -sSLf -o "${BUILD_DIR}/${SOURCE_JAR_FILENAME}" "${SOURCE_JAR_URL}"; then
    echo "$(basename "$0"): failed to download $SOURCE_JAR_URL" >&2
    exit 1
  fi

  (
    cd "${BUILD_DIR}"
    jar xf "${SOURCE_JAR_FILENAME}"
    rm "${SOURCE_JAR_FILENAME}"
  )

  # Check for Kotlin Multiplatform platform-specific sources
  # Download the POM to check for platform dependencies (-jvm, -android, etc.)
  POM_URL="${REPO_URL}/${GROUP_ID_PATH}/${ARTIFACT_ID}/${VERSION}/${ARTIFACT_ID}-${VERSION}.pom"
  POM_CONTENT=$(curl -sSLf "${POM_URL}" 2>/dev/null || true)

  if [ -n "$POM_CONTENT" ]; then
    # Look for dependencies on platform-specific artifacts (e.g., artifact-jvm, artifact-android)
    # Extract artifact IDs that match the pattern: ${ARTIFACT_ID}-{platform}
    # Use local-name() to handle XML namespaces
    PLATFORM_ARTIFACTS=$(echo "$POM_CONTENT" | xmllint --xpath "//*[local-name()='dependency']/*[local-name()='groupId' and text()='${GROUP_ID}']/../*[local-name()='artifactId']/text()" - 2>/dev/null | grep "^${ARTIFACT_ID}-" || true)

    if [ -n "$PLATFORM_ARTIFACTS" ]; then
      echo "info: Detected Kotlin Multiplatform library, downloading platform-specific sources..." >&2
      for PLATFORM_ARTIFACT in $PLATFORM_ARTIFACTS; do
        PLATFORM_SOURCE_JAR_URL="${REPO_URL}/${GROUP_ID_PATH}/${PLATFORM_ARTIFACT}/${VERSION}/${PLATFORM_ARTIFACT}-${VERSION}-sources.jar"
        PLATFORM_SOURCE_JAR_FILENAME="${PLATFORM_ARTIFACT}-${VERSION}-sources.jar"

        # Try to download platform sources (may not exist for all platforms)
        if curl -sSLf -o "${BUILD_DIR}/${PLATFORM_SOURCE_JAR_FILENAME}" "${PLATFORM_SOURCE_JAR_URL}" 2>/dev/null; then
          echo "info: Downloaded ${PLATFORM_ARTIFACT} platform sources" >&2
          (
            cd "${BUILD_DIR}"
            jar xf "${PLATFORM_SOURCE_JAR_FILENAME}"
            rm "${PLATFORM_SOURCE_JAR_FILENAME}"
          )
        fi
      done
    fi
  fi
done

# Clean up META-INF after all extractions
rm -rf "${BUILD_DIR}/META-INF"

echo "${BUILD_DIR}"
