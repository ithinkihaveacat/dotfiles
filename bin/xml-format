#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") [FILE...]

Format XML files using xmllint.

When FILEs are provided, each file is formatted in place. When no FILE is
provided, reads from standard input and writes to standard output.

Arguments:
  FILE...     Paths to XML files to format (optional)

Options:
  -h, --help  Display this help message and exit

Examples:

# Format a file in place

  $(basename "$0") config.xml

# Format multiple files

  $(basename "$0") *.xml

# Format from stdin to stdout

  curl -s <https://example.com/feed.xml> | $(basename "$0")

# Format a file and see the result

  $(basename "$0") < data.xml
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

if [[ $# -eq 0 && -t 0 ]]; then
  usage
fi

require() { hash "$@" || exit 127; }

require xmllint

if [[ $# -eq 0 ]]; then

  # Read from stdin, write to stdout

  xmllint --format -
else

  # Format files in place

  TMPFILE=$(mktemp)
  trap 'rm -f -- "$TMPFILE"' EXIT
  FAILED=0
  for FILE in "$@"; do
    if [[ ! -f "$FILE" ]]; then
      echo "$(basename "$0"): $FILE: No such file or directory" >&2
      FAILED=1
      continue
    fi
    if xmllint --format "$FILE" > "$TMPFILE"; then
      cat "$TMPFILE" > "$FILE"
      echo "$(basename "$0"): $FILE: formatted"
    else
      echo "$(basename "$0"): $FILE: failed to format" >&2
      FAILED=1
    fi
  done
  exit $FAILED
fi
