#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") [FILE]

Format an XML file using xmllint.

When FILE is provided, the file is formatted in place. When no FILE is
provided, reads from standard input and writes to standard output.

Arguments:
  FILE        Path to an XML file to format (optional)

Options:
  -h, --help  Display this help message and exit

Examples:
  # Format a file in place
  $(basename "$0") config.xml

  # Format from stdin to stdout
  curl -s https://example.com/feed.xml | $(basename "$0")

  # Format a file and see the result
  $(basename "$0") < data.xml
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

if [[ $# -gt 1 ]]; then
  echo "$(basename "$0"): too many arguments" >&2
  exit 1
fi

require() { hash "$@" || exit 127; }

require xmllint

if [[ $# -eq 0 ]]; then
  # Read from stdin, write to stdout
  xmllint --format -
else
  # Format file in place
  if [[ ! -f "$1" ]]; then
    echo "$(basename "$0"): $1: No such file or directory" >&2
    exit 1
  fi
  TMPFILE=$(mktemp)
  trap 'rm -f -- "$TMPFILE"' EXIT
  if xmllint --format "$1" > "$TMPFILE"; then
    cat "$TMPFILE" > "$1"
    echo "$(basename "$0"): $1: formatted"
  else
    echo "$(basename "$0"): $1: failed to format" >&2
    exit 1
  fi
fi
