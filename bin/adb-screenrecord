#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] [FILE]

Records the screen of an adb-connected device using scrcpy.

The screen recording is saved to the specified file, or to a timestamped file
in the current directory if no file is specified. Touches are displayed during
the recording.

Arguments:
  FILE              The path to save the screen recording to.
                    (defaults to 'adb-screenrecord-YYYYMMDDHHMMSS.mp4')

Options:
  -o, --output FILE The path to save the screen recording to.
  -h, --help        Display this help message and exit

Examples:
  # Save screen recording to a timestamped file in the current directory
  $(basename "$0")

  # Save screen recording to a specific file
  $(basename "$0") /tmp/my-screen-recording.mp4

  # Save screen recording to a specific file using the --output flag
  $(basename "$0") --output /tmp/my-screen-recording.mp4
EOF
  exit 0
}

OUTPUT_FILE=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -h | --help)
      usage
      ;;
    -o | --output)
      if [ -z "$2" ]; then
        echo "$(basename "$0"): --output option requires an argument" >&2
        exit 1
      fi
      OUTPUT_FILE="$2"
      shift 2
      ;;
    *)
      break
      ;;
  esac
done

require() { hash "$@" || exit 127; }

require scrcpy

if [ -n "$1" ]; then
  OUTPUT_FILE="$1"
fi

if [ -z "$OUTPUT_FILE" ]; then
  OUTPUT_FILE=$(date -u +'adb-screenrecord-%Y%m%d%H%M%S.mp4')
fi

adb exec-out log -p f -t scrcpy "screen recording to $OUTPUT_FILE"

SHOW_TOUCHES="adb exec-out settings get system show_touches"
# shellcheck disable=SC2064
trap "$(printf 'adb exec-out settings put system show_touches %s' "$($SHOW_TOUCHES)")" EXIT

adb exec-out settings put system show_touches 1

# Trying to mux audio seems to lead scrcpy to create a broken MP4 on Ctrl-C, so
# disable via --no-audio
#
# May also need to disable -t (show touches) and -w (stay awake) on
# some devices.

#scrcpy --no-audio -N -t -w -r "$OUTPUT_FILE"
scrcpy --no-audio --no-window -r "$OUTPUT_FILE"

# On some devices, may need to force a particular video codec:
# --video-codec=h264 --video-encoder='OMX.google.h264.encoder'
