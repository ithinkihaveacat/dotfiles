#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") PACKAGE_NAME [REPO_URL]

Gets the stable version for a given Jetpack package.

Arguments:
  PACKAGE_NAME  The package name (e.g., androidx.wear.tiles:tiles)
  REPO_URL      The Maven repository URL (optional, defaults to Google Maven)

Examples:
  $(basename "$0") androidx.wear.tiles:tiles
  $(basename "$0") com.google.android.horologist:horologist-datalayer https://repo1.maven.org/maven2
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

set -e

if [ "$#" -lt 1 ]; then
  echo "$(basename "$0"): missing package name" >&2
  exit 1
fi

PACKAGE_NAME=$1
REPO_URL=${2:-"https://dl.google.com/android/maven2"}

GROUP_ID=$(echo "$PACKAGE_NAME" | cut -d: -f1)
ARTIFACT_ID=$(echo "$PACKAGE_NAME" | cut -d: -f2)
GROUP_ID_PATH=$(echo "$GROUP_ID" | sed 's/\./\//g')
METADATA_URL="$REPO_URL/$GROUP_ID_PATH/$ARTIFACT_ID/maven-metadata.xml"

RELEASE_VERSION=$(curl -sSL "$METADATA_URL" |
  xmllint --xpath "//version/text()" - |
  tr ' ' '\n' |
  grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' |
  sort -V |
  tail -n 1)

if [[ -z "$RELEASE_VERSION" ]]; then
  RELEASE_VERSION=$(curl -sSL "$METADATA_URL" |
    xmllint --xpath "//version/text()" - |
    tr ' ' '\n' |
    sort -V |
    tail -n 1)
  if [[ -z "$RELEASE_VERSION" ]]; then
    echo "$(basename "$0"): could not determine stable version for $PACKAGE_NAME from $METADATA_URL" >&2
    exit 1
  fi
  echo "$(basename "$0"): info: using latest prerelease version: $RELEASE_VERSION" >&2
fi

echo "$RELEASE_VERSION"
