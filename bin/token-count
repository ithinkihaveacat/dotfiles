#!/usr/bin/env bash

set -euo pipefail

usage() {
  cat <<EOF
Usage: $(basename "$0") < INPUT_FILE
       echo "text" | $(basename "$0")

Counts the tokens in the text provided via standard input using the Gemini API.

Input:
  stdin       The text to count tokens for.

Options:
  -h, --help  Display this help message and exit

Environment:
  GEMINI_API_KEY  Required. Your Gemini API key.

Examples:
  echo "The quick brown fox jumps over the lazy dog." | $(basename "$0")
  $(basename "$0") < document.txt
  cat *.md | $(basename "$0")
EOF
  exit 0
}

if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
fi

require() { hash "$@" || exit 127; }

require curl
require jq

# Check for stdin
if [ -t 0 ]; then
  usage
fi

if [[ -z "${GEMINI_API_KEY:-}" ]]; then
  echo "$(basename "$0"): GEMINI_API_KEY environment variable not set" >&2
  exit 1
fi

MODEL="gemini-2.0-flash"
URL="https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:countTokens"

RESPONSE=$(jq -R -s \
  '{
    contents: [{
      parts: [{ text: . }]
    }]
  }' | curl -s -X POST \
  -H "x-goog-api-key: $GEMINI_API_KEY" \
  -H "Content-Type: application/json" \
  -d @- \
  "${URL}")

# Check for API errors
if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
  ERROR_MSG=$(echo "$RESPONSE" | jq -r '.error.message // "Unknown error"')
  echo "$(basename "$0"): API error: $ERROR_MSG" >&2
  exit 1
fi

# Extract and output the token count
TOKEN_COUNT=$(echo "$RESPONSE" | jq -r '.totalTokens // 0')

if [[ -z "$TOKEN_COUNT" ]]; then
  echo "$(basename "$0"): failed to get token count from response" >&2
  echo "$RESPONSE" >&2
  exit 1
fi

echo "$TOKEN_COUNT"
