#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] [FILE]

Takes a screenshot from an adb-connected device.

The screenshot is saved to the specified file, or to a timestamped file in the
current directory if no file is specified. The image is also copied to the
clipboard on macOS.

For square displays (e.g., Wear OS), a circular mask is applied to the screenshot.

Arguments:
  FILE              The path to save the screenshot to.
                    (defaults to 'adb-screenshot-YYYYMMDDHHMMSS.png')

Options:
  -o, --output FILE The path to save the screenshot to.
  -h, --help        Display this help message and exit

Examples:
  # Save screenshot to a timestamped file in the current directory
  $(basename "$0")

  # Save screenshot to a specific file
  $(basename "$0") /tmp/my-screenshot.png

  # Save screenshot to a specific file using the --output flag
  $(basename "$0") --output /tmp/my-screenshot.png
EOF
  exit 0
}

OUTPUT_FILE=""

# Manual parsing for --output, compatible with macOS getopt
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h | --help)
      usage
      ;;
    -o | --output)
      if [ -z "$2" ]; then
        echo "$(basename "$0"): --output option requires an argument" >&2
        exit 1
      fi
      OUTPUT_FILE="$2"
      shift 2
      ;;
    *)
      break # First non-option argument is the FILE
      ;;
  esac
done

require() { hash "$@" || exit 127; }

require adb
require exiftool
require osascript
require magick

if [ "$(adb get-state)" != "device" ]; then
  exit 1
fi

if [ -n "$1" ]; then
  OUTPUT_FILE="$1"
fi

if [ -z "$OUTPUT_FILE" ]; then
  OUTPUT_FILE=$(date -u +'adb-screenshot-%Y%m%d%H%M%S.png')
fi

adb exec-out input keyevent KEYCODE_WAKEUP

adb exec-out log -t screencap "screenshot to $OUTPUT_FILE"

is_square() {
  size=$(adb exec-out wm size 2>/dev/null) &&
    [[ $size =~ Physical\ size:\ ([0-9]+)x([0-9]+) ]] &&
    [[ ${BASH_REMATCH[1]} -eq ${BASH_REMATCH[2]} ]]
}

# stderr to /dev/null because screencap can complain if there
# are multiple displays (e.g. Samsung Flip). Investigate
# `adb exec-out dumpsys SurfaceFlinger --display-id` if want to
# check for multiple displays.
if is_square; then

  # Apply circular mask if on square display (i.e. assume Wear if square display)
  adb exec-out "screencap -p 2>/dev/null" | magick - \
    -alpha set -background none -fill white \
    \( +clone -channel A -evaluate set 0 +channel -draw "circle %[fx:(w-1)/2],%[fx:(h-1)/2] %[fx:(w-1)/2],0.5" \) \
    -compose dstin -composite \
    png:"$OUTPUT_FILE"

else

  adb exec-out "screencap -p 2>/dev/null" >"$OUTPUT_FILE"

fi

# Some devices (Pixel 7) report a "Physical" and "Override" density, so just take one line
DPI=$(adb exec-out wm density | tail -1 | awk '{ print $NF }')
exiftool -overwrite_original_in_place -XResolution="$DPI" -YResolution="$DPI" "$OUTPUT_FILE"

/usr/bin/osascript - "$OUTPUT_FILE" <<END 2>&1 | grep -v CFURLGetFSRef

on run argv
  # https://stackoverflow.com/a/30578507/11543
  # "as PNG" doesn't work, but "as JPEG" seems fine...
  set the clipboard to (read (POSIX file (first item of argv)) as JPEG picture)
end

END

echo "Saved to $OUTPUT_FILE and copied to clipboard"
