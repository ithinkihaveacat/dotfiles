#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") PACKAGE

Triggers background dex optimization for a given package.

This script is useful for manually triggering the optimization process, which is normally
handled by the Android OS. This can be useful for testing or for ensuring that an app is
fully optimized before a performance measurement.

Arguments:
  PACKAGE     Android package name (e.g., com.example.app)

Options:
  -h, --help  Display this help message and exit

Environment:
  ANDROID_SERIAL  Serial number of device to connect to (see 'adb devices -l').
                  To target a specific device, use:
                    env ANDROID_SERIAL=<serial> $(basename "$0")

Examples:
  # Trigger optimization for the System UI
  $(basename "$0") com.android.systemui

  # Optimize a specific app before a benchmark
  $(basename "$0") com.google.android.apps.photos
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

require() { hash "$@" || exit 127; }

require adb

if [ -z "$1" ]; then
  usage
fi

adb exec-out cmd package compile -r bg-dexopt "$1"

#adb exec-out cmd "$1" bg-dexopt-job
