#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") [FILE]

Format a Markdown file using markdownlint-cli2 and prettier.

When FILE is provided, the file is formatted in place. When no FILE is
provided, reads from standard input and writes to standard output.

Arguments:
  FILE        Path to a Markdown file to format (optional)

Options:
  -h, --help  Display this help message and exit

Examples:

# Format a file in place

  $(basename "$0") README.md

# Format from stdin to stdout

  cat README.md | $(basename "$0") > formatted.md

# Format a file and see the result

  $(basename "$0") < notes.md
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

if [[ $# -gt 1 ]]; then
  echo "$(basename "$0"): too many arguments" >&2
  exit 1
fi

if [[ $# -eq 0 && -t 0 ]]; then
  usage
fi

# Determine which commands to use

if command -v markdownlint-cli2 >/dev/null 2>&1; then
  MARKDOWNLINT="markdownlint-cli2"
elif command -v npx >/dev/null 2>&1; then
  MARKDOWNLINT="npx -y markdownlint-cli2"
else
  echo "$(basename "$0"): markdownlint-cli2 not found and npx not available" >&2
  exit 127
fi

if command -v prettier >/dev/null 2>&1; then
  PRETTIER="prettier"
elif command -v npx >/dev/null 2>&1; then
  PRETTIER="npx -y prettier"
else
  echo "$(basename "$0"): prettier not found and npx not available" >&2
  exit 127
fi

if [[ $# -eq 0 ]]; then

  # Read from stdin, write to stdout

  TMPDIR=$(mktemp -d)
  TMPFILE="$TMPDIR/content.md"
  trap 'rm -rf -- "$TMPDIR"' EXIT
  cat >"$TMPFILE"
  $MARKDOWNLINT --fix "$TMPFILE" >/dev/null 2>&1
  $PRETTIER --prose-wrap always --write "$TMPFILE" >/dev/null 2>&1
  cat "$TMPFILE"
else

  # Format file in place

  if [[ ! -f "$1" ]]; then
    echo "$(basename "$0"): $1: No such file or directory" >&2
    exit 1
  fi
  $MARKDOWNLINT --fix "$1" 2>/dev/null
  $PRETTIER --prose-wrap always --write "$1" 2>/dev/null
  echo "$(basename "$0"): $1: formatted"
fi
