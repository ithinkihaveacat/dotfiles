#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") [FILE...]

Format Markdown files using markdownlint-cli2 and prettier.

When FILEs are provided, each file is formatted in place. When no FILE is
provided, reads from standard input and writes to standard output.

Arguments:
  FILE...     Paths to Markdown files to format (optional)

Options:
  -h, --help  Display this help message and exit

Examples:

# Format a file in place

  $(basename "$0") README.md

# Format multiple files

  $(basename "$0") docs/*.md

# Format from stdin to stdout

  cat README.md | $(basename "$0") > formatted.md

# Format a file and see the result

  $(basename "$0") < notes.md
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

if [[ $# -eq 0 && -t 0 ]]; then
  usage
fi

# Determine which commands to use

if command -v markdownlint-cli2 >/dev/null 2>&1; then
  MARKDOWNLINT="markdownlint-cli2"
elif command -v npx >/dev/null 2>&1; then
  MARKDOWNLINT="npx -y markdownlint-cli2"
else
  echo "$(basename "$0"): markdownlint-cli2 not found and npx not available" >&2
  exit 127
fi

if command -v prettier >/dev/null 2>&1; then
  PRETTIER="prettier"
elif command -v npx >/dev/null 2>&1; then
  PRETTIER="npx -y prettier"
else
  echo "$(basename "$0"): prettier not found and npx not available" >&2
  exit 127
fi

if [[ $# -eq 0 ]]; then

  # Read from stdin, write to stdout

  TMPDIR=$(mktemp -d)
  TMPFILE="$TMPDIR/content.md"
  trap 'rm -rf -- "$TMPDIR"' EXIT
  cat >"$TMPFILE"

  # Fix what can be auto-fixed
  $MARKDOWNLINT --fix "$TMPFILE" >/dev/null 2>&1
  $PRETTIER --prose-wrap always --write "$TMPFILE" >/dev/null 2>&1

  # Report any remaining lint errors to stderr (keeps stdout clean for piping)
  $MARKDOWNLINT "$TMPFILE" >&2 || true

  cat "$TMPFILE"
else

  # Format files in place

  FAILED=0
  for FILE in "$@"; do
    if [[ ! -f "$FILE" ]]; then
      echo "$(basename "$0"): $FILE: No such file or directory" >&2
      FAILED=1
      continue
    fi

    # Fix what can be auto-fixed
    $MARKDOWNLINT --fix "$FILE" >/dev/null 2>&1
    $PRETTIER --prose-wrap always --write "$FILE" >/dev/null 2>&1

    # Report any remaining lint errors that couldn't be auto-fixed
    $MARKDOWNLINT "$FILE" 2>&1 || true

    echo "$(basename "$0"): $FILE: formatted"
  done
  exit $FAILED
fi
