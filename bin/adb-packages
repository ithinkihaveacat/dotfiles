#!/usr/bin/env bash

# Check bash version for safety, though this script is simple enough to likely work on older bash
# keeping consistent with other scripts if I were to use bash 4 features, but standard bash 3 is fine here.
# However, AGENTS.md suggests checking dependencies and providing usage.

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS]

Lists installed packages on the connected device.
By default, lists only user-installed (third-party) packages.

Options:
  --all       List all packages (including system apps)
  -h, --help  Display this help message and exit

Environment:
  ANDROID_SERIAL  Serial number of device to connect to (see 'adb devices -l').
EOF
  exit 0
}

# Parse args
all_apps=0

while [[ "$#" -gt 0 ]]; do
  case $1 in
    --all) all_apps=1 ;;
    -h | --help) usage ;;
    *)
      echo "$(basename "$0"): unknown option '$1'" >&2
      exit 1
      ;;
  esac
  shift
done

require() { hash "$@" || exit 127; }

require adb

if ! adb get-state >/dev/null 2>&1; then
  if [[ -n "$ANDROID_SERIAL" ]]; then
    echo "$(basename "$0"): device '$ANDROID_SERIAL' not available" >&2
  else
    echo "$(basename "$0"): no device connected" >&2
  fi
  exit 1
fi

if ((all_apps)); then
  # List all packages
  adb exec-out pm list packages | cut -b 9- | sort
else
  # List only third-party packages (default)
  adb exec-out pm list packages -3 | cut -b 9- | sort
fi
