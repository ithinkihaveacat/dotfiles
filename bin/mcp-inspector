#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") COMMAND|FILE [ARGS...]

Interactive inspector for Model Context Protocol (MCP) servers.

If the first argument is an executable command, it runs the inspector for that command.
If the first argument is a JSON configuration file, it lists available servers or
runs the inspector for a specific server if a second argument is provided.

Arguments:
  COMMAND|FILE  The command to run or path to an MCP config JSON file.
  ARGS...       Arguments for the command or the name of the server in the config file.

Options:
  --help        Display this help message and exit

Examples:
  # Run inspector for a specific command
  $(basename "$0") npx -y sqlite-mcp-server /path/to/db.sqlite

  # List servers from a config file
  $(basename "$0") mcp-config.json

  # Run inspector for a specific server from a config file
  $(basename "$0") mcp-config.json my-server
EOF
  exit 0
}

if [[ "${1:-}" == "--help" ]]; then
  usage
fi

if [ -z "${1:-}" ]; then
  usage 1 >&2
fi

require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo >&2 "$(basename "$0"): $1 not found"
    exit 127
  }
}

require npx
require jq

# If the first argument is an executable, run it with the inspector.
if command -v "$1" >/dev/null 2>&1; then

  npx @modelcontextprotocol/inspector "$@"
  exit $?

fi

# Otherwise, treat the first argument as a JSON config file.
CONFIG_FILE="$1"
SERVER_NAME="${2:-}"

if [ ! -f "$CONFIG_FILE" ]; then
  echo "$(basename "$0"): Error: Command '$1' not found, and is not a file." >&2
  exit 1
fi

if [ -z "$SERVER_NAME" ]; then

  # If no server name is given, list the available servers from the config file.
  echo "Available servers:"
  jq -r '.mcpServers | keys[]' "$CONFIG_FILE"

else

  # If a server name is provided, run the inspector with the server's config.

  # Check if the server key exists in the JSON file.
  if ! jq -e ".mcpServers.\"$SERVER_NAME\"" "$CONFIG_FILE" >/dev/null; then
    echo "$(basename "$0"): Error: Server '$SERVER_NAME' not found in $CONFIG_FILE" >&2
    exit 1
  fi

  # Extract the command and arguments from the JSON file.
  CMD=$(jq -r ".mcpServers.\"$SERVER_NAME\".command" "$CONFIG_FILE")
  # Use mapfile/readarray for safety
  readarray -t ARGS < <(jq -r ".mcpServers.\"$SERVER_NAME\".args[]" "$CONFIG_FILE")

  # Pass through any errors from jq.
  if [ "${PIPESTATUS[0]}" -ne 0 ]; then
    echo "$(basename "$0"): Error: Could not parse command or args for server '$SERVER_NAME' in '$CONFIG_FILE'." >&2
    exit 1
  fi

  npx @modelcontextprotocol/inspector "$CMD" "${ARGS[@]}"

fi
