#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] CLASS_NAME [VERSION_TYPE] [REPO_URL]

Download and inspect source code for a Jetpack class or package.

This is a convenience wrapper that combines jetpack-resolve and jetpack-source
to map from a package/class name directly to source code.

Arguments:
  CLASS_NAME    Fully qualified package/class name
                (e.g., androidx.core.splashscreen.SplashScreen)
  VERSION_TYPE  Version type: ALPHA, BETA, RC, STABLE, or LATEST
                (optional, defaults to STABLE)
  REPO_URL      Maven repository URL
                (optional, defaults to Google Maven)

Options:
  -h, --help    Display this help message and exit
  --output DIR  Specify output directory (default: create temporary directory)

Examples:
  $(basename "$0") androidx.core.splashscreen.SplashScreen
  $(basename "$0") androidx.wear.ambient.AmbientLifecycleObserver ALPHA
  $(basename "$0") androidx.lifecycle.ViewModel STABLE
  pushd "\$($(basename "$0") androidx.wear.tiles.TileService)"

The script resolves the class name to a Maven coordinate, then downloads and
extracts the source code to a directory (temporary by default), and prints the
path to that directory.

For Kotlin Multiplatform libraries, both common and platform-specific sources
(e.g., jvmMain, androidMain) are automatically downloaded to provide complete
source code coverage.
EOF
  exit 0
}

set -e

OUTPUT_DIR=""
REMAINING_ARGS=()
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h | --help)
      usage
      ;;
    --output)
      if [ -z "$2" ]; then
        echo "$(basename "$0"): option '--output' requires an argument" >&2
        exit 1
      fi
      OUTPUT_DIR="$2"
      shift 2
      ;;
    *)
      REMAINING_ARGS+=("$1")
      shift
      ;;
  esac
done
set -- "${REMAINING_ARGS[@]}" # Overwrite the original positional arguments

if [ "$#" -lt 1 ]; then
  usage
fi

require() {
  hash "$@" || {
    echo "Error: Command '$1' not found." >&2
    exit 127
  }
}

require jetpack-resolve
require jetpack-source

CLASS_NAME=$1
VERSION_TYPE=${2:-STABLE}
REPO_URL=${3:-}

# Resolve class name to Maven coordinate
COORDINATE=$(jetpack-resolve "$CLASS_NAME")

# Build jetpack-source arguments
JETPACK_SOURCE_ARGS=()
if [ -n "$OUTPUT_DIR" ]; then
  JETPACK_SOURCE_ARGS+=(--output "$OUTPUT_DIR")
fi
JETPACK_SOURCE_ARGS+=("$COORDINATE" "$VERSION_TYPE")
if [ -n "$REPO_URL" ]; then
  JETPACK_SOURCE_ARGS+=("$REPO_URL")
fi

# Download source
jetpack-source "${JETPACK_SOURCE_ARGS[@]}"
