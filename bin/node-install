#!/usr/bin/env bash

# Installs a specific version of Node.js to a given prefix directory.
# Based on https://github.com/wilmoore/nodejs-install

set -o errexit
set -o errtrace
set -o nounset

readonly DEFAULT_PREFIX="${XDG_DATA_HOME:-$HOME/.local/share}/node/versions"

usage() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS] VERSION [PREFIX]
       $(basename "$0") --list
       $(basename "$0") --installed

Downloads and installs a specific version of Node.js.

Arguments:
  VERSION     Node.js version to install. Supports partial versions:
              - "22.13.1" installs exactly v22.13.1
              - "22.13" installs the latest v22.13.x
              - "22" installs the latest v22.x.x
  PREFIX      Directory where Node.js will be installed (optional).
              A subdirectory named node-vVERSION will be created.
              Default: \$XDG_DATA_HOME/node/versions or ~/.local/share/node/versions

Options:
  -l, --list       List all available remote Node.js versions
  -i, --installed  List all installed Node.js versions
  -h, --help       Display this help message and exit

Examples:
  # Install latest Node.js 22.x
  $(basename "$0") 22

  # List available versions
  $(basename "$0") --list

  # List installed versions
  $(basename "$0") --installed
EOF
  exit 0
}

require() {
  for cmd in "$@"; do
    if ! command -v "$cmd" &>/dev/null; then
      echo "$(basename "$0"): '$cmd' command not found" >&2
      exit 127
    fi
  done
}

require curl tar

# Infer operating system identifier for Node.js downloads.
get_os() {
  uname | tr '[:upper:]' '[:lower:]'
}

# Infer architecture identifier for Node.js downloads.
get_arch() {
  local machine
  machine=$(uname -m)
  case "$machine" in
    x86_64)
      echo "x64"
      ;;
    aarch64 | arm64)
      echo "arm64"
      ;;
    armv7l)
      echo "armv7l"
      ;;
    *)
      echo "$(basename "$0"): unsupported architecture: $machine" >&2
      exit 1
      ;;
  esac
}

# Build platform identifier (e.g., linux-x64, darwin-arm64).
get_platform() {
  echo "$(get_os)-$(get_arch)"
}

# List all downloadable Node.js versions.
list_versions() {
  curl -fsSL https://nodejs.org/dist/ \
    | grep -oE 'v[0-9]+\.[0-9]+\.[0-9]+' \
    | sort -t. -u -k 1.2,1n -k 2,2n -k 3,3n
}

# List locally installed versions.
list_installed() {
  local dir="${1:-$DEFAULT_PREFIX}"
  if [[ ! -d "$dir" ]]; then
    echo "$(basename "$0"): no versions found in $dir" >&2
    return
  fi
  
  find "$dir" -maxdepth 1 -name "node-v*" -type d \
    | sed 's|.*/node-||' \
    | sort -V
}

# Resolve a partial version to the highest matching full version.
# Supports: "24" -> "24.x.x", "24.1" -> "24.1.x", "24.1.0" -> "24.1.0"
# Returns the full version number (without 'v' prefix) or empty if not found.
resolve_version() {
  local input="$1"
  local pattern

  # Count dots to determine version specificity
  # Note: Use arithmetic expansion to handle macOS wc whitespace padding
  local dots
  dots=$(($(echo "$input" | tr -cd '.' | wc -c)))

  case "$dots" in
    0) pattern="^v${input}\\." ;;       # "24" matches "v24.*"
    1) pattern="^v${input}\\." ;;       # "24.1" matches "v24.1.*"
    2) pattern="^v${input}$" ;;         # "24.1.0" matches exactly
    *) pattern="^v${input}$" ;;
  esac

  list_versions | grep -E "$pattern" | tail -1 | tr -d 'v'
}

# Handle --help, --list and --installed before checking argument count
case "${1:-}" in
  -h | --help)
    usage
    ;;
  -l | --list)
    list_versions
    exit 0
    ;;
  -i | --installed)
    PREFIX="${2:-$DEFAULT_PREFIX}"
    list_installed "$PREFIX"
    exit 0
    ;;
esac

# Show help if no arguments provided
if [[ $# -lt 1 ]]; then
  usage
fi

# Parse positional arguments
VERSION_INPUT=$(echo "$1" | tr -d 'vV')
PREFIX="${2:-$DEFAULT_PREFIX}"

# Resolve partial version to full version (e.g., "24" -> "24.1.0")
VERSION=$(resolve_version "$VERSION_INPUT")
if [[ -z "$VERSION" ]]; then
  echo "$(basename "$0"): no Node.js version matching '$VERSION_INPUT' found" >&2
  echo "Use '$(basename "$0") --list' to see available versions." >&2
  exit 1
fi

TARGET="$PREFIX/node-v$VERSION"
BINDIR="$TARGET/bin"

# Check for existing installation
if [[ -d "$TARGET" ]]; then
  echo "$(basename "$0"): '$TARGET' already exists" >&2
  exit 1
fi

# Build download URL
DOWNLOAD_URL="https://nodejs.org/dist/v$VERSION/node-v$VERSION-$(get_platform).tar.gz"

# Create target directory
mkdir -p "$TARGET"

# Clean up on failure
cleanup() {
  rm -rf "$TARGET"
}
trap cleanup EXIT

# Download and extract
echo "Downloading Node.js v$VERSION for $(get_platform)..."
curl -fL# "$DOWNLOAD_URL" | tar xz --strip-components=1 -C "$TARGET"

# Clear the trap on success
trap - EXIT

echo "$TARGET"
echo ""
echo "Tip: use direnv to switch Node.js versions. See ~/.direnvrc for usage." >&2
