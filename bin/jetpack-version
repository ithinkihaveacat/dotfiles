#!/usr/bin/env bash

usage() {
  cat <<EOF
Usage: $(basename "$0") PACKAGE_NAME [VERSION_TYPE] [REPO_URL]

Gets a specific version type for a given Jetpack package.

Arguments:
  PACKAGE_NAME  The package name (e.g., androidx.wear.tiles:tiles)
  VERSION_TYPE  The version type to retrieve: ALPHA, BETA, RC, STABLE,
                LATEST, or SNAPSHOT (optional, defaults to STABLE)
  REPO_URL      The Maven repository URL (optional, defaults to Google Maven)
                For SNAPSHOT, this is ignored and the androidx.dev snapshot
                repo is used.

**About SNAPSHOT builds:** These are bleeding-edge versions of Jetpack
libraries. In these scripts, 'SNAPSHOT' always refers to the **latest**
available build from androidx.dev. Selecting a specific build ID is not
supported. Use this when you need the absolute latest, unreleased code.
More info: https://androidx.dev/

Version Types:
  ALPHA    - Latest alpha version (e.g., 1.2.3-alpha04)
  BETA     - Latest beta version (e.g., 1.2.3-beta02)
  RC       - Latest release candidate version (e.g., 1.2.3-rc01)
  STABLE   - Latest stable release (e.g., 1.2.3, without pre-release
             suffix)
  LATEST   - Latest version of any kind (from maven-metadata.xml <latest>
             tag)
  SNAPSHOT - Latest snapshot version from androidx.dev (e.g.,
             1.0.0-SNAPSHOT)

Examples:
  $(basename "$0") androidx.wear.tiles:tiles
  $(basename "$0") androidx.wear.tiles:tiles STABLE
  $(basename "$0") androidx.wear.tiles:tiles ALPHA
  $(basename "$0") androidx.wear.tiles:tiles BETA
  $(basename "$0") androidx.wear.tiles:tiles RC
  $(basename "$0") androidx.wear.tiles:tiles LATEST
  $(basename "$0") androidx.wear.tiles:tiles SNAPSHOT
  $(basename "$0") com.google.android.horologist:horologist-datalayer \
    STABLE https://repo1.maven.org/maven2
EOF
  exit 0
}

if [[ "$1" == "-h" || "$1" == "--help" ]]; then
  usage
fi

set -e

if [ "$#" -lt 1 ]; then
  usage
fi

PACKAGE_NAME=$1

# Validate package name format
if [[ ! "$PACKAGE_NAME" =~ ^[^:]+:[^:]+$ ]]; then
  echo "$(basename "$0"): invalid package format '$PACKAGE_NAME' (expected GROUP_ID:ARTIFACT_ID)" >&2
  exit 1
fi

# Parse optional arguments
if [ -n "$2" ]; then
  # Check if second argument is a URL
  if [[ "$2" =~ ^https?:// ]]; then
    VERSION_TYPE="STABLE"
    REPO_URL="$2"
  else
    VERSION_TYPE=$(echo "$2" | tr '[:lower:]' '[:upper:]')
    REPO_URL=${3:-"https://dl.google.com/android/maven2"}
  fi
else
  VERSION_TYPE="STABLE"
  REPO_URL="https://dl.google.com/android/maven2"
fi

# Validate version type
case "$VERSION_TYPE" in
  ALPHA | BETA | RC | STABLE | LATEST | SNAPSHOT) ;;
  *)
    echo "$(basename "$0"): invalid version type '$VERSION_TYPE'" >&2
    echo "Valid types: ALPHA, BETA, RC, STABLE, LATEST, SNAPSHOT" >&2
    exit 1
    ;;
esac

GROUP_ID=$(echo "$PACKAGE_NAME" | cut -d: -f1)
ARTIFACT_ID=$(echo "$PACKAGE_NAME" | cut -d: -f2)
GROUP_ID_PATH=$(echo "$GROUP_ID" | sed 's/\./\//g')

# Handle SNAPSHOT separately since it uses a different repository
if [ "$VERSION_TYPE" = "SNAPSHOT" ]; then
  # Use the "latest" redirect URL which automatically resolves to the current snapshot build
  # e.g., https://androidx.dev/snapshots/latest/artifacts/repository redirects to
  #       https://androidx.dev/snapshots/builds/14566697/artifacts/repository
  SNAPSHOT_REPO_URL="https://androidx.dev/snapshots/latest/artifacts/repository"
  METADATA_URL="$SNAPSHOT_REPO_URL/$GROUP_ID_PATH/$ARTIFACT_ID/maven-metadata.xml"

  # Check if the package exists in snapshot repository
  if ! curl -sSLf "$METADATA_URL" >/dev/null 2>&1; then
    echo "$(basename "$0"): failed to fetch $METADATA_URL" >&2
    echo "$(basename "$0"): package may not exist in snapshot builds" >&2
    exit 1
  fi

  # Get the latest SNAPSHOT version
  VERSION=$(curl -sSLf "$METADATA_URL" |
    xmllint --xpath "//version/text()" - |
    tr ' ' '\n' |
    grep -E '\-SNAPSHOT$' |
    sort -V |
    tail -n 1)

  if [[ -z "$VERSION" ]]; then
    echo "$(basename "$0"): no snapshot version found at $METADATA_URL" >&2
    exit 1
  fi

  echo "$VERSION"
  exit 0
fi

METADATA_URL="$REPO_URL/$GROUP_ID_PATH/$ARTIFACT_ID/maven-metadata.xml"

# Check if the package exists
if ! curl -sSLf "$METADATA_URL" >/dev/null 2>&1; then
  echo "$(basename "$0"): failed to fetch $METADATA_URL" >&2
  exit 1
fi

case "$VERSION_TYPE" in
  ALPHA)
    VERSION=$(curl -sSLf "$METADATA_URL" |
      xmllint --xpath "//version/text()" - |
      tr ' ' '\n' |
      grep -E '^[0-9]+\.[0-9]+\.[0-9]+-alpha[0-9]+$' |
      sort -V |
      tail -n 1)

    if [[ -z "$VERSION" ]]; then
      echo "$(basename "$0"): no alpha version found at $METADATA_URL" >&2
      exit 1
    fi
    ;;

  BETA)
    VERSION=$(curl -sSLf "$METADATA_URL" |
      xmllint --xpath "//version/text()" - |
      tr ' ' '\n' |
      grep -E '^[0-9]+\.[0-9]+\.[0-9]+-beta[0-9]+$' |
      sort -V |
      tail -n 1)

    if [[ -z "$VERSION" ]]; then
      echo "$(basename "$0"): no beta version found at $METADATA_URL" >&2
      exit 1
    fi
    ;;

  RC)
    VERSION=$(curl -sSLf "$METADATA_URL" |
      xmllint --xpath "//version/text()" - |
      tr ' ' '\n' |
      grep -E '^[0-9]+\.[0-9]+\.[0-9]+-rc[0-9]+$' |
      sort -V |
      tail -n 1)

    if [[ -z "$VERSION" ]]; then
      echo "$(basename "$0"): no rc version found at $METADATA_URL" >&2
      exit 1
    fi
    ;;

  STABLE)
    VERSION=$(curl -sSLf "$METADATA_URL" |
      xmllint --xpath "//version/text()" - |
      tr ' ' '\n' |
      grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' |
      sort -V |
      tail -n 1)

    if [[ -z "$VERSION" ]]; then
      VERSION=$(curl -sSLf "$METADATA_URL" |
        xmllint --xpath "//version/text()" - |
        tr ' ' '\n' |
        sort -V |
        tail -n 1)
      if [[ -z "$VERSION" ]]; then
        echo "$(basename "$0"): no stable version found at $METADATA_URL" >&2
        exit 1
      fi
      echo "$(basename "$0"): using prerelease version: $VERSION" >&2
    fi
    ;;

  LATEST)
    VERSION=$(curl -sSLf "$METADATA_URL" |
      xmllint --xpath "//versioning/latest/text()" -)

    if [[ -z "$VERSION" ]]; then
      echo "$(basename "$0"): no latest version found at $METADATA_URL" >&2
      exit 1
    fi
    ;;
esac

echo "$VERSION"
